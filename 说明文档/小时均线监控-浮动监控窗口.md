# 小时均线监控 - 浮动监控窗口

## 功能概述
浮动监控窗口是一个独立的、始终置顶的监控工具，可以实时监控指定合约的价格与EMA的关系，并在触发预警条件时自动提醒。

## 功能特性

### 1. 自动显示
- 打开"小时均线监控"窗口时，自动在右上角显示浮动监控窗口
- 窗口默认置顶（Topmost），方便随时查看
- 独立于主窗口，可以单独关闭或移动

### 2. 三个监控列表

#### 🔺 多头监控
- 用于监控做多的合约
- 当价格接近EMA下方时触发预警
- 预警条件：`价格 < EMA × (1 + 多头预警范围%)`

#### 🔻 空头监控
- 用于监控做空的合约
- 当价格接近EMA上方时触发预警
- 预警条件：`价格 > EMA × (1 - 空头预警范围%)`

#### ⚠️ 预警列表
- 显示所有触发预警的合约
- 记录预警时间、价格、EMA值
- 包含多头和空头预警

### 3. 添加监控方式

#### 方式1：右键菜单（推荐）
1. 在小时均线监控的结果列表中
2. 右键点击目标合约
3. 选择"📈 加入多头监控"或"📉 加入空头监控"
4. 自动填入当前价格作为选入价

#### 方式2：手动添加
1. 点击浮动窗口的"➕ 添加"按钮
2. 在弹出对话框中输入：
   - 合约名称（如BTCUSDT）
   - 选入价格（当前价格）
   - 监控类型（多头/空头）
3. 点击"确定"完成添加

### 4. 启动监控

**配置预警参数**：
- **多头预警范围**：默认10%
- **空头预警范围**：默认10%

**启动步骤**：
1. 点击"▶ 启动监控"按钮
2. 系统立即执行一次监控
3. 之后每5分钟自动监控一次

**监控内容**：
- 获取最新价格
- 重新计算EMA
- 更新距离百分比
- 检查预警条件
- 触发预警时添加到预警列表

### 5. 预警逻辑详解

#### 多头预警示例
```
假设：
- EMA = 10.0
- 多头预警范围 = 10%
- 预警阈值 = 10.0 × (1 + 0.1) = 11.0

当前价格 = 10.5
10.5 < 11.0 ✅ 触发预警！
```

**含义**：价格已经接近EMA上方10%的位置，提醒可能回调

#### 空头预警示例
```
假设：
- EMA = 10.0
- 空头预警范围 = 10%
- 预警阈值 = 10.0 × (1 - 0.1) = 9.0

当前价格 = 9.3
9.3 > 9.0 ✅ 触发预警！
```

**含义**：价格已经接近EMA下方10%的位置，提醒可能反弹

### 6. 数据持久化
- 监控配置自动保存到 `floating_monitor_config.json`
- 包含：
  - 多头监控列表
  - 空头监控列表
  - 预警参数设置
- 下次打开时自动恢复

## 使用场景

### 场景1：突破后的回调监控
```
操作流程：
1. 合约突破EMA向上
2. 在小时监控列表中找到该合约
3. 右键选择"加入多头监控"
4. 设置多头预警范围10%
5. 启动监控
→ 当价格回调接近EMA时自动预警
```

### 场景2：跌破后的反弹监控
```
操作流程：
1. 合约跌破EMA向下
2. 在小时监控列表中找到该合约
3. 右键选择"加入空头监控"
4. 设置空头预警范围10%
5. 启动监控
→ 当价格反弹接近EMA时自动预警
```

### 场景3：批量监控多个合约
```
操作流程：
1. 筛选出符合条件的合约
2. 逐个右键加入监控（多头或空头）
3. 统一启动监控
4. 系统自动批量监控所有合约
→ 任何合约触发预警都会记录
```

## 技术实现

### 数据模型

```csharp
// 监控项目
public class MonitorItem
{
    public string Symbol { get; set; }           // 合约名称
    public MonitorType Type { get; set; }        // 多头/空头
    public decimal EntryPrice { get; set; }      // 选入价格
    public decimal LastPrice { get; set; }       // 最新价格
    public decimal CurrentEma { get; set; }      // 当前EMA
    public decimal DistancePercent { get; set; } // 距离百分比
    public bool IsAlerted { get; set; }          // 是否已预警
}

// 预警记录
public class MonitorAlert
{
    public string Symbol { get; set; }           // 合约名称
    public MonitorType Type { get; set; }        // 类型
    public decimal EntryPrice { get; set; }      // 选入价格
    public decimal AlertPrice { get; set; }      // 预警价格
    public decimal CurrentEma { get; set; }      // 当前EMA
    public DateTime AlertTime { get; set; }      // 预警时间
}
```

### 监控流程

```
定时器触发（每5分钟）
    ↓
获取所有监控项目
    ↓
对每个监控项目：
    ├─ 获取最新价格（Ticker API）
    ├─ 获取K线数据
    ├─ 重新计算EMA
    ├─ 计算距离百分比
    ├─ 检查预警条件
    └─ 触发预警 → 添加到预警列表
    ↓
刷新显示
    ↓
更新状态
```

### EMA计算

- 使用 `HourlyEmaService.GetHourlyKlineDataAsync(symbol)` 获取K线和EMA数据
- EMA数据已在小时监控服务中计算并缓存
- 每次监控直接读取最新的EMA值

### 预警判断逻辑

```csharp
// 多头预警
if (monitor.Type == MonitorType.Long)
{
    var threshold = monitor.CurrentEma * (1 + _config.LongAlertRange / 100);
    if (monitor.LastPrice < threshold && !monitor.IsAlerted)
    {
        // 触发预警
        CreateAlert(monitor);
        monitor.IsAlerted = true;
    }
}

// 空头预警
if (monitor.Type == MonitorType.Short)
{
    var threshold = monitor.CurrentEma * (1 - _config.ShortAlertRange / 100);
    if (monitor.LastPrice > threshold && !monitor.IsAlerted)
    {
        // 触发预警
        CreateAlert(monitor);
        monitor.IsAlerted = true;
    }
}
```

## 文件结构

```
src/BinanceApps.Core/Models/
├─ FloatingMonitorModels.cs         数据模型

src/BinanceApps.WPF/
├─ FloatingMonitorWindow.xaml       浮动窗口UI
├─ FloatingMonitorWindow.xaml.cs    浮动窗口逻辑
├─ AddMonitorDialog.xaml            添加对话框UI
├─ AddMonitorDialog.xaml.cs         添加对话框逻辑
└─ HourlyEmaMonitorWindow.xaml.cs   (集成右键菜单)

工作目录/
└─ floating_monitor_config.json     配置文件
```

## 使用注意事项

### 预警范围设置建议
- **保守策略**：5-8%（频繁预警，适合短线）
- **平衡策略**：10-15%（中等频率，推荐）
- **激进策略**：20%+（较少预警，适合长线）

### 监控间隔
- 默认5分钟
- 可在代码中修改 `MonitorIntervalMinutes`
- 建议不低于3分钟（避免API限流）

### 预警机制
- 每个合约只预警一次（IsAlerted标志）
- 重新添加合约会重置预警状态
- 预警记录保留在预警列表中

### 删除监控项
- 选中目标行
- 点击"➖ 删除"按钮
- 删除后配置立即保存

## 常见问题

### Q1：为什么启动后没有立即预警？
**A**：启动后需要等待数据更新，立即执行一次监控，之后每5分钟更新一次。

### Q2：预警后如何重置？
**A**：删除该监控项，然后重新添加，预警状态会重置。

### Q3：可以同时监控多少个合约？
**A**：理论上无限制，但建议不超过50个（性能和API限流考虑）。

### Q4：浮动窗口关闭后如何重新打开？
**A**：重新打开小时均线监控窗口，浮动窗口会自动显示。

### Q5：数据保存在哪里？
**A**：`floating_monitor_config.json` 文件，与程序exe在同一目录。

### Q6：预警条件可以修改吗？
**A**：可以随时修改多头/空头预警范围，修改后需要重新启动监控。

## 版本信息

- **功能版本**: v1.0.0
- **创建日期**: 2025-11-07
- **状态**: ✅ 已完成并编译成功

## 相关文档

- [小时均线监控-功能说明](./小时均线监控-功能说明.md)
- [小时均线监控-高级筛选条件](./小时均线监控-高级筛选条件.md)

