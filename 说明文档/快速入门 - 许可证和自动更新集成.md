# å¿«é€Ÿå…¥é—¨ - è®¸å¯è¯å’Œè‡ªåŠ¨æ›´æ–°é›†æˆ

## ğŸš€ 5 åˆ†é’Ÿå¿«é€Ÿé›†æˆ

### å‰ææ¡ä»¶
- âœ… Visual Studio 2022
- âœ… .NET 9.0 SDK
- âœ… RegisterSrv æœåŠ¡å™¨å·²éƒ¨ç½²

---

## ç¬¬ 1 æ­¥ï¼šå®‰è£… NuGet åŒ…ï¼ˆ1 åˆ†é’Ÿï¼‰

åœ¨ **ç¨‹åºåŒ…ç®¡ç†å™¨æ§åˆ¶å°** ä¸­è¿è¡Œï¼š

```powershell
Install-Package RegisterSrv.Client
Install-Package RegisterSrv.AutoUpdate
```

---

## ç¬¬ 2 æ­¥ï¼šé…ç½® App.configï¼ˆ1 åˆ†é’Ÿï¼‰

```xml
<?xml version="1.0" encoding="utf-8"?>
<configuration>
    <appSettings>
        <!-- âš ï¸ å¿…é¡»ä¿®æ”¹ä¸ºæ‚¨çš„æœåŠ¡å™¨åœ°å€ï¼ˆç»Ÿä¸€ç®¡ç†æ‰€æœ‰APIåœ°å€ï¼‰ -->
        <add key="LicenseServerUrl" value="http://your-server:8080" />
        
        <!-- ğŸ†• åˆçº¦APIåœ°å€ï¼ˆå¯é€‰ï¼‰ï¼šå¦‚æœªé…ç½®ï¼Œè‡ªåŠ¨ä½¿ç”¨ LicenseServerUrl -->
        <!-- <add key="ContractApiServerUrl" value="http://your-server:8080" /> -->
        
        <!-- âš ï¸ å¿…é¡»ä¿®æ”¹ä¸ºæ‚¨çš„åº”ç”¨IDï¼ˆä»æœåŠ¡å™¨è·å–ï¼‰ -->
        <add key="ApplicationId" value="App_YourAppId" />
        
        <add key="ApplicationName" value="YourAppName" />
        
        <!-- ğŸ†• å½“å‰ç‰ˆæœ¬ï¼ˆè‡ªåŠ¨æ›´æ–°åä¼šè‡ªåŠ¨ä¿®æ”¹ï¼‰ -->
        <add key="CurrentAppVersion" value="1.0.0" />
        
        <!-- æ³¨å†Œç ï¼ˆç”±ç³»ç»Ÿè‡ªåŠ¨ç®¡ç†ï¼Œä¹Ÿä¼šåŒæ­¥ä¿å­˜åˆ° AppDataï¼‰ -->
        <add key="LicenseKey" value="" />
    </appSettings>
</configuration>
```

**ğŸ†• é…ç½®ä¼˜åŒ–è¯´æ˜**ï¼š
- **ç»Ÿä¸€æœåŠ¡å™¨åœ°å€**ï¼šåªéœ€é…ç½® `LicenseServerUrl`ï¼Œæ‰€æœ‰åŠŸèƒ½ï¼ˆè®¸å¯è¯éªŒè¯ã€è‡ªåŠ¨æ›´æ–°ã€åˆçº¦APIï¼‰éƒ½ä¼šä½¿ç”¨è¿™ä¸ªåœ°å€
- **å¯é€‰çš„ ContractApiServerUrl**ï¼šå¦‚æœæ‚¨çš„åˆçº¦APIæœåŠ¡å™¨åœ°å€ä¸åŒï¼Œå¯ä»¥å•ç‹¬é…ç½®
- **ç‰ˆæœ¬è‡ªåŠ¨ç®¡ç†**ï¼šæ›´æ–°åç³»ç»Ÿä¼šè‡ªåŠ¨ä¿®æ”¹ `CurrentAppVersion`

---

## ç¬¬ 3 æ­¥ï¼šæ·»åŠ  LicenseKeyStorage ç±»ï¼ˆ1 åˆ†é’Ÿï¼‰

**æ–°å»ºæ–‡ä»¶**: `LicenseKeyStorage.cs`

**å¤åˆ¶ç²˜è´´ä»¥ä¸‹ä»£ç **ï¼š

<details>
<summary>ç‚¹å‡»å±•å¼€å®Œæ•´ä»£ç </summary>

```csharp
using System;
using System.IO;

namespace YourApp
{
    public static class LicenseKeyStorage
    {
        private static readonly string AppDataFolder = Path.Combine(
            Environment.GetFolderPath(Environment.SpecialFolder.LocalApplicationData),
            "YourAppName"  // âš ï¸ ä¿®æ”¹ä¸ºæ‚¨çš„åº”ç”¨åç§°
        );

        private static readonly string LicenseFilePath = Path.Combine(AppDataFolder, "license.dat");

        public static void SaveLicenseKey(string licenseKey)
        {
            try
            {
                if (!Directory.Exists(AppDataFolder))
                    Directory.CreateDirectory(AppDataFolder);
                File.WriteAllText(LicenseFilePath, licenseKey);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"âŒ ä¿å­˜æ³¨å†Œç å¤±è´¥: {ex.Message}");
            }
        }

        public static string LoadLicenseKey()
        {
            try
            {
                if (File.Exists(LicenseFilePath))
                    return File.ReadAllText(LicenseFilePath).Trim();
                return string.Empty;
            }
            catch
            {
                return string.Empty;
            }
        }
    }
}
```

</details>

---

## ç¬¬ 4 æ­¥ï¼šä¿®æ”¹ App.xaml.csï¼ˆ2 åˆ†é’Ÿï¼‰

åœ¨ `OnStartup` æ–¹æ³•ä¸­æ·»åŠ ï¼š

```csharp
using System.Configuration;
using RegisterSrv.Client;

protected override void OnStartup(StartupEventArgs e)
{
    // 1. è¯»å–é…ç½®
    string appId = ConfigurationManager.AppSettings["ApplicationId"];
    string serverUrl = ConfigurationManager.AppSettings["LicenseServerUrl"];
    
    // 2. åŠ è½½æ³¨å†Œç 
    LoadLicenseKeyFromAppData();
    
    // 3. åˆå§‹åŒ–è®¸å¯è¯ç®¡ç†å™¨
    LicenseManager.Initialize(appId, serverUrl);
    
    base.OnStartup(e);
    
    // 4. éªŒè¯è®¸å¯è¯
    Task.Run(async () =>
    {
        var result = await LicenseManager.ValidateCurrentLicenseAsync();
        await Dispatcher.InvokeAsync(() =>
        {
            if (result.IsValid)
                ShowMainWindow();
            else
                ShowLicenseDialog();
        });
    });
}

// ä» AppData åŠ è½½æ³¨å†Œç 
private void LoadLicenseKeyFromAppData()
{
    var savedKey = LicenseKeyStorage.LoadLicenseKey();
    if (!string.IsNullOrWhiteSpace(savedKey))
    {
        ConfigurationManager.AppSettings["LicenseKey"] = savedKey;
        SaveLicenseKeyToConfig(savedKey);
    }
}

// ä¿å­˜æ³¨å†Œç åˆ° App.config
private void SaveLicenseKeyToConfig(string licenseKey)
{
    try
    {
        var config = ConfigurationManager.OpenExeConfiguration(ConfigurationUserLevel.None);
        if (config.AppSettings.Settings["LicenseKey"] != null)
        {
            config.AppSettings.Settings["LicenseKey"].Value = licenseKey;
            config.Save(ConfigurationSaveMode.Modified);
            ConfigurationManager.RefreshSection("appSettings");
        }
    }
    catch { }
}

// æ˜¾ç¤ºè®¸å¯è¯å¯¹è¯æ¡†
private void ShowLicenseDialog()
{
    // ç®€åŒ–ç‰ˆï¼šç›´æ¥å¼¹å‡ºè¾“å…¥æ¡†
    var licenseKey = Microsoft.VisualBasic.Interaction.InputBox(
        $"æœºå™¨ç ï¼š{LicenseManager.GetMachineCode()}\n\nè¯·è¾“å…¥æ³¨å†Œç ï¼š",
        "è®¸å¯è¯éªŒè¯",
        ""
    );
    
    if (!string.IsNullOrWhiteSpace(licenseKey))
    {
        LicenseKeyStorage.SaveLicenseKey(licenseKey);
        SaveLicenseKeyToConfig(licenseKey);
        LicenseManager.Initialize(
            ConfigurationManager.AppSettings["ApplicationId"],
            ConfigurationManager.AppSettings["LicenseServerUrl"]
        );
        ShowMainWindow();
    }
    else
    {
        Application.Current.Shutdown();
    }
}

private void ShowMainWindow()
{
    if (MainWindow == null)
        MainWindow = new MainWindow();
    MainWindow.Show();
}
```

**âš ï¸ æ³¨æ„**ï¼šå¦‚æœç¼–è¯‘é”™è¯¯ï¼Œéœ€æ·»åŠ å¼•ç”¨ `Microsoft.VisualBasic`

---

## ç¬¬ 5 æ­¥ï¼šåœ¨ MainWindow æ·»åŠ æ£€æŸ¥æ›´æ–°ï¼ˆå¯é€‰ï¼‰

### 5.1 åœ¨ MainWindow.xaml æ·»åŠ èœå•

```xml
<Menu DockPanel.Dock="Top">
    <MenuItem Header="å¸®åŠ©(_H)">
        <MenuItem Header="æ£€æŸ¥æ›´æ–°(_U)" Click="MenuItem_CheckUpdate_Click" />
    </MenuItem>
</Menu>
```

### 5.2 åœ¨ MainWindow.xaml.cs æ·»åŠ äº‹ä»¶

```csharp
using RegisterSrv.AutoUpdate;

// åœ¨ç±»ä¸­æ·»åŠ é™æ€å­—æ®µ
public static FixedUpdateManager UpdateManager { get; set; }

// åœ¨æ„é€ å‡½æ•°æˆ– Loaded äº‹ä»¶ä¸­åˆå§‹åŒ–
public MainWindow()
{
    InitializeComponent();
    
    if (UpdateManager == null)
    {
        var config = new UpdateConfig
        {
            ServerUrl = ConfigurationManager.AppSettings["LicenseServerUrl"],
            AppId = ConfigurationManager.AppSettings["ApplicationId"],
            AppName = ConfigurationManager.AppSettings["ApplicationName"],
            CurrentVersion = ConfigurationManager.AppSettings["CurrentAppVersion"],
            AutoCheckOnStartup = false
        };
        UpdateManager = new FixedUpdateManager(config);
    }
}

// æ£€æŸ¥æ›´æ–°äº‹ä»¶
private async void MenuItem_CheckUpdate_Click(object sender, RoutedEventArgs e)
{
    await UpdateManager.CheckAndUpdateAsync(this);
}
```

**âš ï¸ æ³¨æ„**ï¼šéœ€è¦ä»å®Œæ•´æ–‡æ¡£å¤åˆ¶ `FixedUpdateManager.cs` ç±»

---

## ç¬¬ 6 æ­¥ï¼šåˆ›å»ºæ‰“åŒ…è„šæœ¬ï¼ˆå¯é€‰ï¼‰

**æ–°å»ºæ–‡ä»¶**: `å¿«é€Ÿæ‰“åŒ….cmd`

```batch
@echo off
chcp 65001 >nul

:: âš ï¸ ä¿®æ”¹ä»¥ä¸‹è·¯å¾„
set PUBLISH_DIR=src\YourApp\publish
set ZIP_NAME=YourApp_v1.0.0.zip

echo ğŸ“¦ å¼€å§‹æ‰“åŒ…...
pushd %PUBLISH_DIR%
powershell -Command "Compress-Archive -Path '*' -DestinationPath '..\..\%ZIP_NAME%' -Force"
popd

if exist "%ZIP_NAME%" (
    echo âœ… æ‰“åŒ…æˆåŠŸ: %ZIP_NAME%
    explorer /select,"%CD%\%ZIP_NAME%"
) else (
    echo âŒ æ‰“åŒ…å¤±è´¥
)
pause
```

**ä½¿ç”¨æ–¹æ³•**ï¼š
1. åœ¨ VS2022 ä¸­å³é”®é¡¹ç›® â†’ å‘å¸ƒ
2. è¿è¡Œ `å¿«é€Ÿæ‰“åŒ….cmd`

---

## ğŸ“‹ å‘å¸ƒæ–°ç‰ˆæœ¬æµç¨‹

### å¼€å‘å®Œæˆå

1. **æ›´æ–°ç‰ˆæœ¬å·**ï¼ˆ3 ä¸ªä½ç½®ï¼‰
   - `YourApp.csproj` â†’ `<Version>1.0.1</Version>`
   - `App.config` â†’ `<add key="CurrentAppVersion" value="1.0.1" />`
   - `å¿«é€Ÿæ‰“åŒ….cmd` â†’ `set ZIP_NAME=YourApp_v1.0.1.zip`

2. **åœ¨ VS2022 ä¸­å‘å¸ƒ**
   - å³é”®é¡¹ç›® â†’ å‘å¸ƒ

3. **è¿è¡Œæ‰“åŒ…è„šæœ¬**
   - åŒå‡» `å¿«é€Ÿæ‰“åŒ….cmd`

4. **ä¸Šä¼ åˆ°æœåŠ¡å™¨**
   - ç™»å½•æœåŠ¡å™¨ç®¡ç†åå°
   - åˆ›å»ºæ–°ç‰ˆæœ¬
   - ä¸Šä¼  ZIP æ–‡ä»¶

5. **æµ‹è¯•**
   - å®¢æˆ·ç«¯ç‚¹å‡»"æ£€æŸ¥æ›´æ–°"
   - ç¡®è®¤æ›´æ–°æˆåŠŸ

---

## âš ï¸ å¸¸è§é—®é¢˜

### é—®é¢˜ 1ï¼šç¼–è¯‘é”™è¯¯"æœªæ‰¾åˆ° Microsoft.VisualBasic"

**è§£å†³**ï¼šåœ¨ `.csproj` ä¸­æ·»åŠ ï¼š

```xml
<ItemGroup>
  <Reference Include="Microsoft.VisualBasic" />
</ItemGroup>
```

æˆ–ä½¿ç”¨å®Œæ•´æ–‡æ¡£ä¸­çš„è‡ªå®šä¹‰å¯¹è¯æ¡†ä»£ç ã€‚

### é—®é¢˜ 2ï¼šè®¸å¯è¯éªŒè¯å¤±è´¥

**æ£€æŸ¥**ï¼š
- âœ… æœåŠ¡å™¨åœ°å€æ˜¯å¦æ­£ç¡®
- âœ… åº”ç”¨IDæ˜¯å¦æ­£ç¡®
- âœ… æœåŠ¡å™¨æ˜¯å¦åœ¨è¿è¡Œ

### é—®é¢˜ 3ï¼šæ›´æ–°åæ³¨å†Œç ä¸¢å¤±

**æ£€æŸ¥**ï¼š
- âœ… æ˜¯å¦è°ƒç”¨äº† `LicenseKeyStorage.SaveLicenseKey()`
- âœ… æ˜¯å¦åŒæ—¶è°ƒç”¨äº† `SaveLicenseKeyToConfig()`

### é—®é¢˜ 4ï¼šæ‰¾ä¸åˆ° FixedUpdateManager

**è§£å†³**ï¼šä»å®Œæ•´æ–‡æ¡£ `WPFåº”ç”¨é›†æˆè®¸å¯è¯éªŒè¯å’Œè‡ªåŠ¨æ›´æ–°æŒ‡å—.md` ä¸­å¤åˆ¶ `FixedUpdateManager.cs` å®Œæ•´ä»£ç ã€‚

---

## ğŸ“š æ·±å…¥å­¦ä¹ 

å®Œæˆå¿«é€Ÿå…¥é—¨åï¼Œå»ºè®®é˜…è¯»ï¼š

- **å®Œæ•´æ–‡æ¡£**: `WPFåº”ç”¨é›†æˆè®¸å¯è¯éªŒè¯å’Œè‡ªåŠ¨æ›´æ–°æŒ‡å—.md`
  - è¯¦ç»†çš„ API è¯´æ˜
  - å®Œæ•´çš„ä»£ç ç¤ºä¾‹
  - é«˜çº§åŠŸèƒ½å’Œæœ€ä½³å®è·µ

- **é…ç½®ç®¡ç†**: `æœåŠ¡å™¨åœ°å€é…ç½®è¯´æ˜.md`
  - å¦‚ä½•ä¿®æ”¹æœåŠ¡å™¨åœ°å€
  - åŠ¨æ€é…ç½®ç®¡ç†

- **æ„å»ºè¯´æ˜**: `æ„å»ºç›®å½•è¯´æ˜.md`
  - æ„å»ºè¾“å‡ºç»“æ„
  - ç›®å½•æ¸…ç†å’Œç»´æŠ¤

---

## âœ… å®Œæˆæ¸…å•

å®Œæˆä»¥ä¸‹æ­¥éª¤åï¼Œæ‚¨çš„åº”ç”¨å·²é›†æˆè®¸å¯è¯éªŒè¯å’Œè‡ªåŠ¨æ›´æ–°ï¼š

- [ ] å®‰è£…äº† 2 ä¸ª NuGet åŒ…
- [ ] é…ç½®äº† App.configï¼ˆæœåŠ¡å™¨åœ°å€ã€åº”ç”¨IDï¼‰
- [ ] æ·»åŠ äº† LicenseKeyStorage ç±»
- [ ] ä¿®æ”¹äº† App.xaml.csï¼ˆè®¸å¯è¯éªŒè¯ï¼‰
- [ ] æ·»åŠ äº†"æ£€æŸ¥æ›´æ–°"èœå•ï¼ˆå¯é€‰ï¼‰
- [ ] åˆ›å»ºäº†æ‰“åŒ…è„šæœ¬ï¼ˆå¯é€‰ï¼‰
- [ ] æµ‹è¯•äº†è®¸å¯è¯éªŒè¯åŠŸèƒ½
- [ ] æµ‹è¯•äº†è‡ªåŠ¨æ›´æ–°åŠŸèƒ½

---

## ğŸ¯ ä¸‹ä¸€æ­¥

1. **å¼€å‘ç¯å¢ƒæµ‹è¯•**
   - è¿è¡Œåº”ç”¨
   - è¾“å…¥æ³¨å†Œç 
   - éªŒè¯æ¿€æ´»æˆåŠŸ

2. **æ‰“åŒ…å’Œå‘å¸ƒ**
   - å‘å¸ƒç¬¬ä¸€ä¸ªç‰ˆæœ¬
   - ä¸Šä¼ åˆ°æœåŠ¡å™¨

3. **æ›´æ–°æµ‹è¯•**
   - ä¿®æ”¹ä»£ç 
   - å‘å¸ƒæ–°ç‰ˆæœ¬
   - æµ‹è¯•è‡ªåŠ¨æ›´æ–°

---

---

## ğŸ†• æœ€æ–°ä¼˜åŒ–ï¼ˆv2.3.3ï¼‰

### æœåŠ¡å™¨åœ°å€é…ç½®ä¼˜åŒ–

**é—®é¢˜**ï¼šåŸæ¥éœ€è¦é…ç½®å¤šä¸ªæœåŠ¡å™¨åœ°å€ï¼Œå®¹æ˜“é—æ¼æˆ–é…ç½®é”™è¯¯ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šç»Ÿä¸€ä½¿ç”¨ `LicenseServerUrl`

**é…ç½®è¯»å–ä¼˜å…ˆçº§**ï¼š
```
ContractApiServerUrlï¼ˆå¦‚æœé…ç½®äº†ï¼‰
    â†“
LicenseServerUrlï¼ˆå¦‚æœ ContractApiServerUrl æœªé…ç½®ï¼‰
    â†“
é»˜è®¤å€¼ localhost:8080ï¼ˆå¦‚æœä¸¤è€…éƒ½æœªé…ç½®ï¼‰
```

**æ—¥å¿—è¾“å‡ºç¤ºä¾‹**ï¼š
```
ğŸ” ContractApiServerUrl æœªé…ç½®ï¼Œä½¿ç”¨ LicenseServerUrl: http://your-server:8080
âœ… åˆçº¦APIæœ€ç»ˆåœ°å€: http://your-server:8080
```

### ç‰ˆæœ¬ç®¡ç†ä¼˜åŒ–

**æ”¹è¿›**ï¼š
- âœ… `CurrentAppVersion` å­˜å‚¨åœ¨ `App.config` ä¸­
- âœ… æ›´æ–°åè‡ªåŠ¨ä¿®æ”¹ç‰ˆæœ¬å·
- âœ… ä¼˜å…ˆè¯»å–é…ç½®æ–‡ä»¶ç‰ˆæœ¬ï¼Œè€Œä¸æ˜¯ç¨‹åºé›†ç‰ˆæœ¬
- âœ… é¿å…é‡å¤æ›´æ–°æç¤º

### é…ç½®æ–‡ä»¶ä¿æŠ¤

**è‡ªåŠ¨ä¿æŠ¤çš„æ–‡ä»¶**ï¼š
- âœ… `App.config` - åº”ç”¨é…ç½®ï¼ˆåŒ…æ‹¬æ³¨å†Œç ï¼‰
- âœ… `*.db` - æ•°æ®åº“æ–‡ä»¶
- âœ… `*.log` - æ—¥å¿—æ–‡ä»¶
- âœ… `*.dat` - AppData æ•°æ®æ–‡ä»¶

**å¥½å¤„**ï¼šæ›´æ–°åæ³¨å†Œç ä¸ä¼šä¸¢å¤±ï¼Œç”¨æˆ·æ•°æ®å¾—åˆ°ä¿æŠ¤ã€‚

### æ™ºèƒ½æ›´æ–°æœºåˆ¶

**å¤–éƒ¨æ›´æ–°è„šæœ¬**ï¼š
- âœ… é¿å… DLL æ–‡ä»¶é”å®šé—®é¢˜
- âœ… ä¸»ç¨‹åºé€€å‡ºåæ‰§è¡Œæ–‡ä»¶æ›¿æ¢
- âœ… MD5 æ ¡éªŒç¡®ä¿æ–‡ä»¶å®Œæ•´æ€§
- âœ… è‡ªåŠ¨é‡å¯åº”ç”¨ç¨‹åº

### é‡æ¯”æ’è¡ŒåŠŸèƒ½ï¼ˆæ–°å¢ï¼‰

**åŠŸèƒ½**ï¼š
- ä»åˆçº¦ API è·å–æµé€šé‡ä¿¡æ¯
- è®¡ç®—é‡æ¯”ï¼ˆ24Hæˆäº¤é¢ / æµé€šå¸‚å€¼ï¼‰
- æ˜¾ç¤º TOP20 æ’è¡Œæ¦œ

**é…ç½®**ï¼š
- è‡ªåŠ¨ä½¿ç”¨ `LicenseServerUrl`
- æˆ–å•ç‹¬é…ç½® `ContractApiServerUrl`

---

**å¿«é€Ÿå…¥é—¨ç‰ˆæœ¬**: 2.0  
**æ›´æ–°æ—¥æœŸ**: 2025-10-03  
**éš¾åº¦**: â­â­ (ç®€å•)  
**è€—æ—¶**: çº¦ 5-10 åˆ†é’Ÿ

**ğŸ’¡ æç¤º**: å¦‚éœ€æ›´è¯¦ç»†çš„è¯´æ˜å’Œé«˜çº§åŠŸèƒ½ï¼Œè¯·å‚è€ƒå®Œæ•´ç‰ˆæ–‡æ¡£ã€‚ 