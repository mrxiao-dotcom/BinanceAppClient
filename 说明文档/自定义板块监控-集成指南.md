# 自定义板块监控功能 - 集成指南

## ✅ 已完成的工作

### 1. 数据模型层 (Core/Models)
- ✅ `CustomPortfolio.cs` - 组合数据模型
- ✅ `PortfolioSymbol.cs` - 合约信息模型
- ✅ `PortfolioRuntimeData.cs` - 运行时数据模型
- ✅ `PortfolioSymbolData.cs` - 合约实时数据模型

### 2. 服务层 (Core/Services)
- ✅ `CustomPortfolioService.cs` - 组合管理服务
  - 数据持久化（JSON）
  - CRUD操作
  - 存储位置：`%LocalAppData%\BinanceApps\custom_portfolios.json`

### 3. UI界面层 (WPF)
- ✅ `CustomPortfolioWindow.xaml` - 主窗口界面
- ✅ `CustomPortfolioWindow.xaml.cs` - 主窗口逻辑（607行）
- ✅ `PortfolioEditorDialog.xaml` - 编辑对话框界面
- ✅ `PortfolioEditorDialog.xaml.cs` - 编辑对话框逻辑（462行）

---

## 🔌 集成步骤

### 步骤 1：添加菜单入口

在 `MainWindow.xaml` 中添加菜单项：

```xml
<!-- 在现有菜单中添加 -->
<MenuItem Header="工具(_T)">
    <MenuItem Header="自定义板块监控(_P)" Click="MenuCustomPortfolio_Click"/>
    <!-- 其他工具菜单项 -->
</MenuItem>
```

### 步骤 2：添加菜单点击事件

在 `MainWindow.xaml.cs` 中添加：

```csharp
/// <summary>
/// 自定义板块监控菜单点击
/// </summary>
private void MenuCustomPortfolio_Click(object sender, RoutedEventArgs e)
{
    try
    {
        // 创建并显示自定义板块监控窗口
        var window = new CustomPortfolioWindow(
            _logger,
            _customPortfolioService,
            _apiClient
        )
        {
            Owner = this
        };
        
        window.Show();
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "打开自定义板块监控窗口失败");
        MessageBox.Show($"打开窗口失败: {ex.Message}", "错误", 
            MessageBoxButton.OK, MessageBoxImage.Error);
    }
}
```

### 步骤 3：在 MainWindow 中初始化服务

在 `MainWindow.xaml.cs` 的字段中添加：

```csharp
// 在类的顶部添加字段
private CustomPortfolioService? _customPortfolioService;
```

在构造函数或初始化方法中：

```csharp
// 初始化自定义板块服务
_customPortfolioService = new CustomPortfolioService(_logger);
await _customPortfolioService.InitializeAsync();
```

---

## 📝 核心功能说明

### 功能1：创建组合
1. 点击"创建组合"按钮
2. 输入组合名称和说明
3. 搜索合约（模糊匹配）
4. 添加合约到组合，可为每个合约添加备注
5. 保存组合

### 功能2：查看组合数据
- 组合列表显示：名称、平均涨幅、成分数
- 涨幅颜色：绿色（上涨）、红色（下跌）、灰色（平）
- 点击组合查看详细数据

### 功能3：组合明细
- 合约名称
- 24H涨跌幅
- 当前价格
- 24H成交额
- 用户备注

### 功能4：修改/删除组合
- 修改：更新名称、说明、合约列表
- 删除：确认后永久删除

### 功能5：自动刷新
- 每5秒自动刷新行情数据
- 实时更新组合涨幅
- 显示最后更新时间

---

## 🔄 数据流程

```
启动窗口
   ↓
初始化服务（CustomPortfolioService）
   ↓
加载本地组合数据（JSON）
   ↓
启动定时器（每5秒）
   ↓
获取24H Ticker数据（BinanceApiClient）
   ↓
计算组合平均涨幅
   ↓
更新UI显示
```

---

## 💾 数据存储

### 存储位置
```
%LocalAppData%\BinanceApps\custom_portfolios.json
```

### 数据格式
```json
{
  "Version": "1.0",
  "LastUpdated": "2025-10-01T12:00:00Z",
  "Portfolios": [
    {
      "Id": "guid-xxxx-xxxx",
      "Name": "主流币板块",
      "Description": "包含主流大盘币种",
      "Symbols": [
        {
          "Symbol": "BTCUSDT",
          "Remark": "比特币",
          "AddedTime": "2025-10-01T10:00:00Z"
        }
      ],
      "CreatedTime": "2025-10-01T10:00:00Z",
      "LastModifiedTime": "2025-10-01T10:05:00Z"
    }
  ]
}
```

---

## 🎨 UI预览

### 主窗口布局
```
┌────────────────────────────────────────────┐
│ [创建组合] [刷新数据]  最后更新: 10:30:25   │
├─────────────┬──────────────────────────────┤
│ 组合列表     │ 组合明细                      │
│             │                              │
│ 主流币板块   │ BTCUSDT  +3.2%  $50,234     │
│ +5.23%  8个 │ 备注: 比特币                  │
│ [修改][删除]│                              │
│             │ ETHUSDT  +2.1%  $3,456      │
│ DeFi板块    │ 备注: 以太坊                  │
│ -2.15%  12个│                              │
│ [修改][删除]│                              │
└─────────────┴──────────────────────────────┘
```

### 编辑对话框
```
┌──────────────────────────┐
│ 创建/编辑组合             │
├──────────────────────────┤
│ 组合名称: [主流币板块]    │
│ 组合说明: [包含主流...    │
│                          │
│ 添加合约: [BTC] [搜索]    │
│                          │
│ 搜索结果:                 │
│ ├ BTCUSDT  [添加]        │
│ ├ BTCBUSD  [添加]        │
│ └ BTCEUR   [添加]        │
│                          │
│ 已添加的合约: (2个)       │
│ ├ BTCUSDT  [删除]        │
│ │  备注: [比特币]         │
│ └ ETHUSDT  [删除]        │
│    备注: [以太坊]         │
│                          │
│         [保存]  [取消]    │
└──────────────────────────┘
```

---

## ⚙️ 依赖项

### 已有依赖（无需添加）
- `BinanceApiClient` - 获取行情数据
- `ILogger<T>` - 日志记录
- `System.Text.Json` - JSON序列化
- WPF相关命名空间

### 新增服务
- `CustomPortfolioService` - 组合管理服务

---

## 🧪 测试建议

### 功能测试
1. ✅ 创建空组合
2. ✅ 创建包含多个合约的组合
3. ✅ 搜索合约（测试各种关键字）
4. ✅ 修改组合（名称、说明、合约列表）
5. ✅ 删除组合
6. ✅ 查看组合明细
7. ✅ 自动刷新功能
8. ✅ 数据持久化（重启应用）

### 边界测试
- 空组合（0个合约）
- 大组合（50+合约）
- 特殊字符处理
- 网络断开时的行为
- 重复添加同一合约

---

## 🚀 快速启动指南

### 1. 编译项目
```bash
dotnet build src/BinanceApps.WPF/BinanceApps.WPF.csproj -c Release
```

### 2. 运行应用
```bash
dotnet run --project src/BinanceApps.WPF/BinanceApps.WPF.csproj
```

### 3. 打开自定义板块监控
- 菜单：工具 → 自定义板块监控
- 或在代码中直接调用窗口

### 4. 创建第一个组合
1. 点击"创建组合"
2. 输入名称（如："主流币板块"）
3. 搜索"BTC"，添加 BTCUSDT
4. 搜索"ETH"，添加 ETHUSDT
5. 为每个合约添加备注
6. 点击"保存"

---

## 📞 常见问题

### Q1: 如何修改自动刷新间隔？
**A**: 在 `CustomPortfolioWindow.xaml.cs` 的 `StartAutoUpdate()` 方法中修改：
```csharp
TimeSpan.FromSeconds(5)  // 改为你想要的秒数
```

### Q2: 数据保存在哪里？
**A**: `%LocalAppData%\BinanceApps\custom_portfolios.json`

### Q3: 如何导出组合数据？
**A**: 直接复制上述JSON文件即可。

### Q4: 涨幅是如何计算的？
**A**: 算数平均值 = 所有合约的24H涨跌幅之和 ÷ 合约数量

### Q5: 如果合约被下架怎么办？
**A**: 当前会跳过该合约的数据，后续可添加"已下架"标识。

---

## 🔧 故障排除

### 问题1：窗口打开失败
- 检查 `CustomPortfolioService` 是否正确初始化
- 检查 `BinanceApiClient` 是否可用
- 查看日志了解详细错误

### 问题2：无法获取行情数据
- 检查网络连接
- 检查API是否正常
- 查看日志中的API调用错误

### 问题3：数据不持久化
- 检查 `%LocalAppData%\BinanceApps` 目录是否有写权限
- 检查JSON文件是否损坏
- 查看日志中的保存错误

---

## 📄 相关文档

- [自定义板块监控功能开发文档.md](./自定义板块监控功能开发文档.md) - 完整的设计和实现文档
- [MainWindow.xaml.cs](src/BinanceApps.WPF/MainWindow.xaml.cs) - 主窗口代码
- [CustomPortfolioService.cs](src/BinanceApps.Core/Services/CustomPortfolioService.cs) - 服务实现

---

**集成完成后，请进行完整测试并更新此文档！**

---

**创建日期**: 2025-10-01  
**版本**: 1.0  
**负责人**: 开发团队 