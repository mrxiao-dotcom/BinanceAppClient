# 自定义板块监控 - 流通市值和量比功能说明

## 📊 功能概述

在自定义板块监控的合约明细中添加三个新字段：
1. **流通市值**：流通数量 × 最新价格
2. **24H量比**：24H成交额 ÷ 流通市值
3. **合约备注**：从API获取的合约备注信息

---

## ✨ 新增字段说明

### 1. 流通市值（Circulating Market Cap）

**定义**：合约的流通数量乘以当前价格

**计算公式**：
```
流通市值 = 流通数量(CirculatingSupply) × 最新价格(LastPrice)
```

**数据来源**：
- 流通数量：从ContractInfoService缓存获取
- 最新价格：从实时Ticker数据获取

**显示格式**：
- `$XXX.XXB`（≥10亿）
- `$XXX.XM`（≥100万）
- `$XXX.XK`（≥1000）
- `$XXX.XX`（<1000）
- `-`（无数据）

**示例**：
```
$125.50B  - BTC的流通市值
$45.8M    - 某个小币种的流通市值
$1.2K     - 超小币种的流通市值
-         - 无流通数据
```

---

### 2. 24H量比（Volume Ratio）

**定义**：24小时成交额与流通市值的比值，反映市场活跃度

**计算公式**：
```
量比 = 24H成交额(QuoteVolume) ÷ 流通市值(CirculatingMarketCap)
```

**意义**：
- **> 0.5**：🔴 **超活跃**（红色加粗）- 成交额超过市值50%，市场极度活跃
- **0.2 ~ 0.5**：🟠 **活跃**（橙色）- 成交额占市值20-50%，市场较活跃
- **< 0.2**：⚪ **一般**（灰色）- 成交额低于市值20%，市场活跃度一般

**显示格式**：
- `X.XX`（≥1）
- `0.XXX`（≥0.01）
- `0.XXXX`（<0.01）
- `-`（无数据）

**示例**：
```
1.25  - 量比125%，超高活跃度（红色加粗）
0.45  - 量比45%，高活跃度（橙色）
0.15  - 量比15%，一般活跃度（灰色）
0.003 - 量比0.3%，低活跃度（灰色）
-     - 无数据
```

---

### 3. 合约备注（Contract Remark）

**定义**：从合约信息API获取的备注或描述信息

**数据来源优先级**：
1. **Remark字段**（优先）
2. **Description字段**（Remark为空时）
3. **空字符串**（两者都为空）

**显示特点**：
- 灰色小字
- 支持多行显示
- 最大高度60px（超出显示省略号）
- 列宽120px

**示例**：
```
"比特币 - 数字黄金"
"以太坊 - 智能合约平台"
"DeFi龙头项目"
""（空）
```

---

## 🎨 UI布局

### 表头结构（12列）

| 列序 | 字段名称 | 宽度 | 可排序 | 说明 |
|-----|---------|-----|-------|-----|
| 0 | 序号 | 45px | ❌ | 显示序号 |
| 1 | 合约 | 110px | ❌ | 合约代码（可双击复制）|
| 2 | 24H涨幅 | 75px | ✅ | 24小时涨跌幅 |
| 3 | 价格 | 90px | ✅ | 当前价格 |
| 4 | 30天涨幅 | 75px | ✅ | 30天涨跌幅 |
| 5 | 30天最高 | 80px | ❌ | 30天最高价 |
| 6 | 30天最低 | 80px | ❌ | 30天最低价 |
| 7 | **24H成交额** | 75px | ✅ | 24小时成交额 |
| 8 | **流通市值** 🆕 | 85px | ✅ | 流通数量×当前价 |
| 9 | **24H量比** 🆕 | 70px | ✅ | 成交额÷流通市值 |
| 10 | **合约备注** 🆕 | 120px | ❌ | API返回的备注 |
| 11 | 用户备注 | 自适应 | ❌ | 用户自定义备注 |

---

### 显示效果

```
┌────┬────────┬────────┬────────┬────────┬────────┬────────┬────────┬────────┬────────┬──────────┬──────────┐
│序号│ 合约   │24H涨幅 │ 价格   │30天涨幅│30天最高│30天最低│24H成交额│流通市值│24H量比 │合约备注   │用户备注   │
├────┼────────┼────────┼────────┼────────┼────────┼────────┼────────┼────────┼────────┼──────────┼──────────┤
│ 1  │BTCUSDT │ +5.2%  │$65,320 │ +8.5%  │$67,200 │$60,100 │$2.5B   │$1.28T  │ 0.19   │比特币     │优质标的   │
│    │        │(绿色粗)│        │(绿色粗)│(灰色)  │(灰色)  │(灰色)  │(灰色)  │(灰色)  │(灰色小)   │(灰色斜体) │
├────┼────────┼────────┼────────┼────────┼────────┼────────┼────────┼────────┼────────┼──────────┼──────────┤
│ 2  │ETHUSDT │ +3.8%  │$3,450  │ +12.3% │$3,600  │$3,050  │$850M   │$415B   │ 0.52   │以太坊     │重点关注   │
│    │        │(绿色粗)│        │(绿色粗)│(灰色)  │(灰色)  │(灰色)  │(灰色)  │(红色粗)│(灰色小)   │(灰色斜体) │
└────┴────────┴────────┴────────┴────────┴────────┴────────┴────────┴────────┴────────┴──────────┴──────────┘
```

---

## 🔧 技术实现

### 1. 数据模型修改

#### ContractInfo.cs
```csharp
public class ContractInfo
{
    // ... 现有字段 ...
    
    /// <summary>
    /// 备注（从API获取）
    /// </summary>
    public string? Remark { get; set; }
}
```

#### CustomPortfolio.cs - PortfolioSymbolData
```csharp
public class PortfolioSymbolData
{
    // ... 现有字段 ...
    
    /// <summary>
    /// 流通市值（流通数量 × 当前价格）
    /// </summary>
    public decimal CirculatingMarketCap { get; set; }
    
    /// <summary>
    /// 24H量比（24H成交额 ÷ 流通市值）
    /// </summary>
    public decimal VolumeRatio { get; set; }
    
    /// <summary>
    /// 合约备注（从API获取）
    /// </summary>
    public string ContractRemark { get; set; } = string.Empty;
    
    // 显示属性
    public string CirculatingMarketCapDisplay { get; }
    public string VolumeRatioDisplay { get; }
}
```

---

### 2. 数据计算逻辑

#### CustomPortfolioWindow.xaml.cs - RefreshPortfolioDataAsync()

```csharp
// 获取合约信息（流通量、备注）
var contractInfo = _contractInfoService.GetContractInfo(symbol.Symbol);
decimal circulatingMarketCap = 0;
decimal volumeRatio = 0;
string contractRemark = string.Empty;

if (contractInfo != null && contractInfo.CirculatingSupply > 0)
{
    // 计算流通市值
    circulatingMarketCap = contractInfo.CirculatingSupply * ticker.LastPrice;
    
    // 计算量比（24H成交额 / 流通市值）
    if (circulatingMarketCap > 0)
    {
        volumeRatio = ticker.QuoteVolume / circulatingMarketCap;
    }
    
    // 获取合约备注（优先使用Remark，如果没有则使用Description）
    contractRemark = !string.IsNullOrWhiteSpace(contractInfo.Remark) 
        ? contractInfo.Remark 
        : (contractInfo.Description ?? string.Empty);
}

symbolsData.Add(new PortfolioSymbolData
{
    // ... 其他字段 ...
    CirculatingMarketCap = circulatingMarketCap,
    VolumeRatio = volumeRatio,
    ContractRemark = contractRemark
});
```

---

### 3. 排序功能支持

#### ApplySorting方法
```csharp
switch (_currentSortColumn)
{
    // ... 现有排序 ...
    
    case "MarketCap":
        sorted = _sortAscending 
            ? data.OrderBy(s => s.CirculatingMarketCap)
            : data.OrderByDescending(s => s.CirculatingMarketCap);
        break;
        
    case "VolumeRatio":
        sorted = _sortAscending 
            ? data.OrderBy(s => s.VolumeRatio)
            : data.OrderByDescending(s => s.VolumeRatio);
        break;
}
```

---

### 4. UI显示逻辑

#### 流通市值显示
```csharp
var marketCapText = new TextBlock
{
    Text = symbolData.CirculatingMarketCapDisplay,
    FontSize = 10,
    Foreground = new SolidColorBrush(Color.FromRgb(100, 100, 100)),
    VerticalAlignment = VerticalAlignment.Center
};
Grid.SetColumn(marketCapText, 8);
```

#### 量比显示（带颜色）
```csharp
var volumeRatioColor = symbolData.VolumeRatio > 0.5m ? Colors.Red 
    : (symbolData.VolumeRatio > 0.2m ? Colors.Orange : Colors.Gray);

var volumeRatioText = new TextBlock
{
    Text = symbolData.VolumeRatioDisplay,
    FontSize = 10,
    FontWeight = symbolData.VolumeRatio > 0.5m ? FontWeights.Bold : FontWeights.Normal,
    Foreground = new SolidColorBrush(volumeRatioColor),
    VerticalAlignment = VerticalAlignment.Center
};
Grid.SetColumn(volumeRatioText, 9);
```

#### 合约备注显示
```csharp
var contractRemarkText = new TextBlock
{
    Text = string.IsNullOrEmpty(symbolData.ContractRemark) ? "" : symbolData.ContractRemark,
    FontSize = 10,
    Foreground = new SolidColorBrush(Color.FromRgb(100, 100, 100)),
    VerticalAlignment = VerticalAlignment.Center,
    TextWrapping = TextWrapping.Wrap,
    MaxHeight = 60
};
Grid.SetColumn(contractRemarkText, 10);
```

---

## 📊 数据依赖

### ContractInfoService

**作用**：提供合约流通量和备注信息

**初始化时机**：应用启动时从API加载

**缓存结构**：
```csharp
Dictionary<string, ContractInfo> _contractCache
// Key: 合约符号（如：BTCUSDT）
// Value: 合约信息（流通量、备注等）
```

**API端点**：
```
GET {baseUrl}/api/contract?includeDisabled=false
```

**API响应字段**（需包含）：
```json
{
  "Success": true,
  "Data": [
    {
      "Name": "BTCUSDT",
      "CirculatingSupply": 19500000,
      "Remark": "比特币 - 数字黄金",
      "Description": "Bitcoin - Digital Gold"
    }
  ]
}
```

---

## ⚠️ 注意事项

### 1. 数据准备

**启动时确保**：
- ✅ ContractInfoService已初始化
- ✅ 合约信息缓存已加载
- ✅ API返回了Remark或Description字段

**检查方式**：
```
控制台输出：
📊 开始从API加载合约流通量信息...
🌐 API地址: http://38.181.35.75:8080/api/contract
✅ API返回成功，共 XXX 个合约
📝 缓存: BTCUSDT, 流通量: 19,500,000
✅ 成功加载 XXX 个合约信息到缓存
```

---

### 2. 数据缺失处理

**流通量为0或缺失**：
- 流通市值显示：`-`
- 量比显示：`-`
- 颜色：灰色

**备注为空**：
- 显示空白
- 不占用额外空间

---

### 3. API字段映射

**Remark优先级**：
```
1. contractInfo.Remark（优先）
   ↓（如果为空）
2. contractInfo.Description
   ↓（如果都为空）
3. string.Empty
```

---

### 4. 服务注入

**MainWindow.xaml.cs修改**：
```csharp
// 获取ContractInfoService
var contractInfoService = _serviceProvider.GetService(typeof(BinanceApps.Core.Services.ContractInfoService)) 
    as BinanceApps.Core.Services.ContractInfoService;

if (contractInfoService == null)
{
    MessageBox.Show("合约信息服务未初始化，请稍后再试。", "错误", 
        MessageBoxButton.OK, MessageBoxImage.Error);
    return;
}

// 传入CustomPortfolioWindow
var window = new CustomPortfolioWindow(
    typedLogger,
    _customPortfolioService,
    portfolioGroupService,
    _apiClient,
    _klineStorageService,
    contractInfoService  // 新增参数
);
```

---

## 📝 修改文件清单

| 文件 | 修改内容 | 行数变化 |
|-----|---------|---------|
| `ContractInfo.cs` | 添加Remark字段 | +5行 |
| `CustomPortfolio.cs` | 添加流通市值、量比、合约备注字段及显示属性 | +60行 |
| `CustomPortfolioWindow.xaml.cs` | 注入ContractInfoService、计算新字段、更新UI | +120行 |
| `MainWindow.xaml.cs` | 传入ContractInfoService参数 | +12行 |

**总计**：4个文件，约197行代码

---

## 🎯 使用场景

### 1. 识别高活跃度合约
**量比 > 0.5（红色加粗）**：
- 市场极度活跃
- 可能存在重大消息或波动
- 适合短线交易

### 2. 评估市值规模
**流通市值**：
- `> $10B`：大市值，相对稳定
- `$100M ~ $10B`：中市值，有成长空间
- `< $100M`：小市值，高风险高回报

### 3. 对比同类项目
**量比对比**：
- 同一板块内，量比越高说明资金关注度越高
- 可用于发现热点和冷门

### 4. 查看项目说明
**合约备注**：
- 快速了解项目定位
- 辅助识别合约特点
- 补充用户自定义备注

---

## 🧪 测试要点

### 1. 数据正确性
- ✅ 流通市值 = 流通量 × 价格
- ✅ 量比 = 成交额 ÷ 流通市值
- ✅ 备注优先读取Remark字段

### 2. 显示格式
- ✅ 大数字简化显示（B/M/K）
- ✅ 小数位数正确
- ✅ 无数据显示"-"

### 3. 排序功能
- ✅ 点击表头可按流通市值排序
- ✅ 点击表头可按量比排序
- ✅ 升序/降序切换正常

### 4. 量比颜色
- ✅ > 0.5显示红色加粗
- ✅ 0.2~0.5显示橙色
- ✅ < 0.2显示灰色

### 5. 缺失数据处理
- ✅ 无流通量：流通市值和量比显示"-"
- ✅ 无备注：备注列显示空白
- ✅ 不影响其他字段显示

---

## 🔍 故障排查

### 问题1：流通市值显示为"-"

**可能原因**：
- ContractInfoService未初始化
- 缓存中无该合约信息
- 流通量为0

**解决方法**：
1. 检查启动日志，确认API加载成功
2. 检查API是否返回该合约
3. 检查CirculatingSupply是否 > 0

---

### 问题2：量比显示为"-"

**可能原因**：
- 流通市值为0（导致无法计算）
- 成交额为0

**解决方法**：
1. 先确保流通市值正常
2. 检查24H成交额是否有数据

---

### 问题3：合约备注显示空白

**可能原因**：
- API未返回Remark和Description字段
- 该合约确实无备注

**解决方法**：
1. 检查API响应JSON
2. 确认字段名称正确（区分大小写）
3. 如果API确实无备注，属于正常情况

---

### 问题4：服务未初始化错误

**错误信息**：
```
合约信息服务未初始化，请稍后再试。
```

**可能原因**：
- ContractInfoService未在DI容器注册
- ServiceProvider获取失败

**解决方法**：
1. 检查MainWindow.xaml.cs中的服务注册
2. 确保ContractInfoService在CreateServiceProvider中注册
3. 检查服务生命周期

---

## 📈 后续优化建议

### 1. 量比历史趋势
**功能**：显示量比的历史变化趋势
```
当前量比：0.45 ↑ (+0.12)
```

### 2. 流通市值排名
**功能**：显示该合约在所有合约中的市值排名
```
流通市值：$125.5B（排名 #1）
```

### 3. 量比预警
**功能**：量比异常时高亮提醒
```
量比：1.25 ⚠️（超过1.0，异常活跃）
```

### 4. 合约备注编辑
**功能**：允许用户补充或修改合约备注
```
[合约备注] [用户备注] [编辑]
```

### 5. 数据导出
**功能**：导出包含新字段的数据到CSV
```
导出选项：
☑ 流通市值
☑ 24H量比
☑ 合约备注
```

---

**功能版本**: 1.0.0  
**开发日期**: 2025-10-06  
**开发者**: AI Assistant  
**状态**: ✅ 已完成并通过编译测试

---

**关键词**：流通市值、量比、合约备注、市场活跃度、板块监控、数据分析

