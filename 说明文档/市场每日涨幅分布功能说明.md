# 市场每日涨幅分布功能说明

## 📊 功能概述

新增"市场每日涨幅分布"功能，用于分析最近5天的市场涨跌幅分布情况，帮助用户了解市场整体趋势和涨跌幅分布规律。

---

## ✨ 功能特性

### 1. 涨幅档位划分
将所有合约按照24H涨跌幅划分为12个档位：

| 档位序号 | 涨跌幅范围 | 说明 |
|---------|-----------|------|
| 1 | < -50% | 暴跌区 |
| 2 | -49% ~ -40% | 大跌区 |
| 3 | -39% ~ -30% | 深跌区 |
| 4 | -29% ~ -20% | 中跌区 |
| 5 | -19% ~ -10% | 轻跌区 |
| 6 | -9% ~ 0% | 微跌区 |
| 7 | 0% ~ 10% | 微涨区 |
| 8 | 11% ~ 20% | 轻涨区 |
| 9 | 21% ~ 30% | 中涨区 |
| 10 | 31% ~ 40% | 大涨区 |
| 11 | 41% ~ 50% | 暴涨区 |
| 12 | > 50% | 超涨区 |

### 2. 多天数据对比
- 统计最近 **5天** 的数据
- **今天（24H）**：使用实时ticker数据
- **历史日期**：使用K线历史数据计算

### 3. 数据展示方式

#### 📋 数据列表
- **表格样式**：一行展示一天的数据
- **突出显示**：今天的数据使用黄色背景 ⭐
- **完整信息**：显示日期、总合约数、各档位数量

#### 📈 折线图
- **5条折线**：每天一条折线
- **横坐标**：12个涨跌幅档位
- **纵坐标**：合约数量
- **视觉区分**：
  - **今天（最粗实线）**：深橙色 (RGB: 255, 87, 34)，线宽 3.5px
  - **昨天（实线）**：橙色 (RGB: 255, 152, 0)，线宽 2.5px
  - **前天（短虚线）**：黄色 (RGB: 255, 193, 7)，线宽 2.0px
  - **大前天（中虚线）**：浅绿 (RGB: 139, 195, 74)，线宽 1.5px
  - **5天前（长虚线）**：灰色 (RGB: 158, 158, 158)，线宽 1.0px

---

## 🗂️ 文件结构

### 新增文件

#### 1. 数据模型
**文件**：`src/BinanceApps.Core/Models/MarketDistributionModels.cs`

**类**：
- `PriceChangeRange`（枚举）：涨幅档位
- `DailyPriceChangeDistribution`：每日分布数据
- `MarketDistributionAnalysisResult`：多天分析结果

#### 2. 业务逻辑服务
**文件**：`src/BinanceApps.Core/Services/MarketDistributionService.cs`

**功能**：
- `GetDistributionAsync(int days)`：获取最近N天的分布数据
- `CalculateTodayDistributionAsync()`：计算今天的实时数据
- `CalculateHistoricalDistributionAsync()`：计算历史数据

#### 3. UI窗口
**文件**：
- `src/BinanceApps.WPF/MarketDistributionWindow.xaml`
- `src/BinanceApps.WPF/MarketDistributionWindow.xaml.cs`

**功能**：
- 数据加载和刷新
- 列表展示
- 折线图绘制

### 修改文件

#### 1. 主窗口 XAML
**文件**：`src/BinanceApps.WPF/MainWindow.xaml`

**修改**：在左侧导航菜单添加"📊 每日涨幅分布"按钮

#### 2. 主窗口 Code-behind
**文件**：`src/BinanceApps.WPF/MainWindow.xaml.cs`

**修改**：
- 添加 `_marketDistributionService` 字段
- 注册服务到 DI 容器
- 添加 `BtnMarketDistribution_Click` 事件处理器

---

## 🔧 技术实现

### 数据计算逻辑

#### 今日数据
```csharp
// 使用实时24H ticker数据
var tickers = await _apiClient.GetAllTicksAsync();
foreach (var ticker in tickers)
{
    var range = DailyPriceChangeDistribution.GetRange(ticker.PriceChangePercent);
    distribution.RangeCounts[range]++;
}
```

#### 历史数据
```csharp
// 从本地K线数据计算
var targetKline = klines.FirstOrDefault(k => k.OpenTime.Date == date.Date);
var previousKline = klines.FirstOrDefault(k => k.OpenTime.Date == previousDate);

// 计算涨跌幅：(当日收盘 - 前日收盘) / 前日收盘 * 100%
var priceChangePercent = ((targetKline.ClosePrice - previousKline.ClosePrice) 
    / previousKline.ClosePrice) * 100m;
```

### 折线图绘制

**使用原生 WPF 控件**：
- `Canvas` - 画布
- `Line` - 直线（坐标轴）
- `Polyline` - 折线
- `Ellipse` - 数据点
- `TextBlock` - 标签文字

**关键代码**：
```csharp
// 计算点坐标
var x = marginLeft + (chartWidth * i / (rangeCount - 1));
var y = marginTop + chartHeight - (chartHeight * count / maxValue);

// 绘制折线
var polyline = new Polyline
{
    Points = points,
    Stroke = GetLineColor(dayIndex),
    StrokeThickness = GetLineThickness(dayIndex),
    StrokeDashArray = GetLineDashArray(dayIndex)
};
```

---

## 🧪 使用指南

### 1. 打开窗口
- 点击左侧导航菜单中的 **"📊 每日涨幅分布"** 按钮
- 或使用快捷菜单（如有）

### 2. 查看数据
- **数据列表**：上方表格显示5天的详细数据
- **折线图**：下方图表展示趋势对比
- **今日标记**：带有 ⭐ 标记，黄色背景突出显示

### 3. 刷新数据
- 点击窗口顶部的 **"🔄 刷新数据"** 按钮
- 重新获取最新数据并更新图表

### 4. 数据解读

**高涨幅区（右侧）合约多**：
- 市场整体上涨
- 可能处于牛市或反弹行情

**高跌幅区（左侧）合约多**：
- 市场整体下跌
- 可能处于熊市或调整行情

**中间区域集中**：
- 市场波动较小
- 震荡或盘整行情

**分布对比变化**：
- 从历史到今天的折线变化趋势
- 可以判断市场情绪和资金流向

---

## 📊 数据来源

### 实时数据（今天）
- **来源**：Binance Futures WebSocket / REST API
- **数据类型**：24H Ticker Statistics
- **刷新频率**：实时（每次刷新按钮点击时更新）

### 历史数据（前4天）
- **来源**：本地K线数据存储
- **数据类型**：日K线（1D）
- **计算方式**：
  ```
  涨跌幅 = (当日收盘价 - 前一日收盘价) / 前一日收盘价 × 100%
  ```

---

## 🎨 UI 设计

### 配色方案
- **背景**：#F5F5F5（浅灰）
- **卡片**：#FFFFFF（白色）
- **按钮**：#4CAF50（绿色）
- **今日数据**：#FFF4E6（浅黄）
- **边框**：#E0E0E0（灰色）

### 折线颜色（渐变）
```
今天 → 昨天 → 前天 → 大前天 → 5天前
深橙 → 橙色 → 黄色 → 浅绿 → 灰色
实线 → 实线 → 短虚 → 中虚 → 长虚
 3.5  →  2.5  →  2.0  →  1.5  →  1.0  (线宽 px)
```

### 响应式布局
- 窗口大小：1200 × 700
- 列表区高度：200px
- 图表区高度：自适应（* 剩余空间）

---

## 🚀 性能优化

### 数据加载
- **异步处理**：所有数据计算使用 `async/await`
- **并行计算**：多天数据计算可并行处理（已实现串行，可优化为并行）
- **本地缓存**：历史K线数据从本地读取，无需重复下载

### UI 渲染
- **延迟绘制**：等待Canvas加载完成后再绘制
- **避免重绘**：只在数据更新时重绘图表
- **加载覆盖**：显示加载状态，避免UI卡顿感知

---

## 📝 注意事项

### 1. 数据完整性
- 历史数据依赖本地K线存储
- 如果K线数据不完整，可能导致统计不准确
- 建议定期更新K线数据

### 2. 合约筛选
- 只统计活跃交易的合约（`IsTrading = true`）
- 只统计USDT永续合约
- 已下架或停止交易的合约不计入统计

### 3. 计算时间
- 首次加载可能需要5-10秒（取决于合约数量）
- 后续刷新速度较快（1-3秒）

### 4. 图表显示
- 如果某个档位合约数为0，折线会经过该点（y=0）
- 所有档位都会显示，即使数量为0

---

## 🔄 后续优化建议

### 功能增强
1. **自定义天数**：允许用户选择统计天数（5天/7天/10天）
2. **导出功能**：导出数据到CSV/Excel
3. **截图功能**：保存图表为图片
4. **趋势预测**：根据历史数据预测未来趋势

### 性能优化
1. **并行计算**：多天数据并行计算，提升加载速度
2. **增量更新**：只更新今天的数据，历史数据缓存
3. **数据预加载**：后台预先计算，提升响应速度

### UI 增强
1. **图表库集成**：使用 LiveCharts / OxyPlot 替代原生绘制
2. **交互功能**：鼠标悬停显示详细数据
3. **缩放拖动**：支持图表缩放和拖动
4. **主题切换**：支持亮色/暗色主题

---

## 🆘 故障排查

### 问题 1：数据加载失败
**症状**：点击刷新后提示"加载数据失败"

**可能原因**：
- 网络连接问题
- API服务未启动
- 本地K线数据缺失

**解决方法**：
1. 检查网络连接
2. 确认API设置正确
3. 尝试重新下载K线数据

### 问题 2：图表不显示
**症状**：列表有数据，但图表区域空白

**可能原因**：
- Canvas尺寸为0（未完全加载）
- 所有数据为0

**解决方法**：
1. 调整窗口大小触发重绘
2. 点击刷新按钮重新加载
3. 检查数据是否有效

### 问题 3：历史数据不准确
**症状**：历史数据的合约数量明显偏少

**可能原因**：
- 本地K线数据不完整
- 部分合约的K线数据缺失

**解决方法**：
1. 前往"获取K线数据"页面
2. 重新下载完整的K线数据
3. 确保所有合约都有历史数据

---

**功能版本**: 1.0.0  
**创建日期**: 2025-10-05  
**文档版本**: 1.0  
**开发者**: AI Assistant  
**状态**: ✅ 已完成并通过编译测试

