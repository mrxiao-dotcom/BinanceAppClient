# 小时均线监控 - 增量更新和筛选功能测试指南

## 📋 快速测试步骤

### 测试1：基本功能测试
```
1. 启动应用程序
2. 点击左侧"⏱️ 小时均线监控"按钮
3. 在参数区输入：
   - N天均线：26
   - X根K线：100
4. 点击"📥 获取小时K线"按钮
5. 等待下载完成（会自动计算EMA）
6. ✅ 验证点：
   - 表格显示合约列表
   - "更新K线"、"计算"、"启动监控"按钮变为可用
```

### 测试2：增量更新功能
```
1. 完成测试1后
2. 点击"🔄 更新K线"按钮
3. 观察控制台输出
4. ✅ 验证点：
   - 显示每个合约的最后K线时间
   - 显示距离现在的时间差
   - 对于超过1小时的合约，显示更新信息
   - 对于已是最新的合约，显示"无需更新"
```

**预期控制台输出示例：**
```
🔄 开始增量更新K线数据...
🔍 [1/150] BTCUSDT 最后K线时间: 2025-11-06 10:00:00, 距现在: 2.5小时
🔄 BTCUSDT 需要更新 4 根K线
✅ BTCUSDT 更新成功：添加了 4 根K线，当前总数: 100
🔍 [2/150] ETHUSDT 最后K线时间: 2025-11-06 11:30:00, 距现在: 0.5小时
✅ ETHUSDT 数据已是最新，无需更新
```

### 测试3：计算连续数量
```
1. 完成测试1或测试2后
2. 点击"🔢 计算"按钮
3. 观察表格中的"大于EMA数量"和"小于EMA数量"列
4. ✅ 验证点：
   - 两列都显示数值
   - 数值大于等于0
   - 每个合约只有一列有值（另一列为0）
```

**预期结果示例：**
| 合约名 | 大于EMA数量 | 小于EMA数量 |
|--------|-------------|-------------|
| BTCUSDT | 5 | 0 |
| ETHUSDT | 0 | 3 |
| BNBUSDT | 8 | 0 |

### 测试4：筛选功能 - 大于EMA
```
1. 完成测试3后
2. 在"大于EMA数量 ≥"输入框输入：3
3. 点击"🔍 筛选"按钮
4. ✅ 验证点：
   - 表格只显示"大于EMA数量"≥3的合约
   - 标题显示"监控结果 (筛选后: X 个合约)"
   - 状态栏显示筛选结果数量
```

### 测试5：筛选功能 - 小于EMA
```
1. 点击"清除筛选"按钮（恢复全部显示）
2. 在"小于EMA数量 ≥"输入框输入：2
3. 点击"🔍 筛选"按钮
4. ✅ 验证点：
   - 表格只显示"小于EMA数量"≥2的合约
   - 可以正确恢复全部显示
```

### 测试6：组合筛选
```
1. 清除筛选后
2. 同时输入：
   - 大于EMA数量 ≥ 5
   - 小于EMA数量 ≥ 3
3. 点击"筛选"
4. ✅ 验证点：
   - 显示同时满足两个条件之一的合约
   - 可以正确筛选
```

### 测试7：排序功能
```
1. 清除筛选，显示全部合约
2. 点击"大于EMA数量"列标题
3. ✅ 验证点：
   - 第一次点击：升序排序
   - 第二次点击：降序排序
   - 第三次点击：恢复原始排序
4. 点击"小于EMA数量"列标题
5. ✅ 验证点：同上
```

### 测试8：监控状态
```
1. 点击"▶️ 启动监控"
2. ✅ 验证点：
   - "获取K线"、"更新K线"、"计算"按钮变为禁用
   - "启动监控"按钮变为禁用
   - "停止监控"按钮变为可用
   - 参数输入框变为禁用
3. 点击"⏸️ 停止监控"
4. ✅ 验证点：
   - 所有按钮恢复可用状态
```

### 测试9：清除缓存
```
1. 点击"🗑️ 清除缓存"
2. 在确认对话框中选择"是"
3. ✅ 验证点：
   - 表格清空
   - "更新K线"、"计算"、"启动监控"按钮变为禁用
   - 标题显示"监控结果 (共 0 个合约)"
```

---

## 🔍 详细测试场景

### 场景A：找出强势上涨合约
```
目标：找出连续5根以上K线都在EMA上方的合约

步骤：
1. 获取K线数据
2. 点击"计算"
3. 在"大于EMA数量 ≥"输入：5
4. 点击"筛选"
5. 点击"大于EMA数量"列标题排序（降序）

预期结果：
- 显示连续大于EMA至少5根的合约
- 按数量从大到小排列
- 这些合约通常是强势上涨趋势
```

### 场景B：找出弱势下跌合约
```
目标：找出连续3根以上K线都在EMA下方的合约

步骤：
1. 获取K线数据
2. 点击"计算"
3. 在"小于EMA数量 ≥"输入：3
4. 点击"筛选"
5. 点击"小于EMA数量"列标题排序（降序）

预期结果：
- 显示连续小于EMA至少3根的合约
- 按数量从大到小排列
- 这些合约通常是弱势下跌趋势
```

### 场景C：日常监控流程
```
早上：
1. 打开应用
2. 点击"获取小时K线"（初次）
3. 点击"计算"
4. 查看结果

中午/下午：
1. 点击"更新K线"（增量更新）
2. 点击"计算"（重新计算）
3. 应用筛选条件查看目标合约

晚上：
1. 再次"更新K线"
2. "计算"
3. 导出关注的合约列表（双击复制合约名）
```

---

## ⚠️ 边界条件测试

### 测试10：参数验证
```
测试无效参数输入：

1. N天均线输入：0
   预期：提示"请输入有效的N天均线参数"

2. X根K线输入：-1
   预期：提示"请输入有效的X根K线参数"

3. X < N（如 X=20, N=26）
   预期：提示"X根K线数量必须大于等于N天均线"

4. 筛选条件输入：abc（非数字）
   预期：提示"请输入有效的数量"

5. 筛选条件输入：0
   预期：提示"请输入有效的数量（大于0的整数）"

6. 筛选条件两个都为空
   预期：提示"请至少输入一个筛选条件"
```

### 测试11：空数据处理
```
1. 未获取K线就点击"更新K线"
   预期：提示"没有可用的缓存数据，请先获取K线数据"

2. 未获取K线就点击"计算"
   预期：提示"没有可用的缓存数据"

3. 未获取K线就点击"启动监控"
   预期：提示"请先获取小时K线数据"

4. 筛选后无结果
   预期：表格为空，显示"筛选后: 0 个合约"
```

### 测试12：网络异常处理
```
1. 断开网络后点击"获取K线"
   预期：提示"获取K线数据失败，请检查网络连接和API设置"

2. 断开网络后点击"更新K线"
   预期：部分合约更新失败，显示错误信息
```

---

## 📊 控制台日志验证

### 增量更新日志示例
```
🔄 开始增量更新K线数据...
🔍 [1/150] BTCUSDT 最后K线时间: 2025-11-06 10:00:00, 距现在: 2.5小时
🔄 BTCUSDT 需要更新 4 根K线
📊 BTCUSDT 下载数据验证: 时间间隔 1.0 小时
✅ BTCUSDT 更新成功：添加了 4 根K线，当前总数: 100
✅ K线增量更新完成！更新了 50/150 个合约
```

### 计算日志示例
```
📊 开始计算连续大于/小于EMA的K线数量...
✅ BTCUSDT: 连续大于EMA=5, 连续小于EMA=0
✅ ETHUSDT: 连续大于EMA=0, 连续小于EMA=3
✅ BNBUSDT: 连续大于EMA=8, 连续小于EMA=0
✅ 连续数量计算完成！
```

### 筛选日志示例
```
✅ 筛选完成，共 25 个合约符合条件
✅ 筛选已清除，显示全部 150 个合约
```

---

## 🎯 预期行为总结

### 按钮状态转换表
| 操作 | 获取K线 | 更新K线 | 计算 | 启动监控 | 停止监控 | 清除缓存 |
|------|---------|---------|------|----------|----------|----------|
| 初始 | ✅ | ❌ | ❌ | ❌ | ❌ | ✅ |
| 获取成功 | ✅ | ✅ | ✅ | ✅ | ❌ | ✅ |
| 监控中 | ❌ | ❌ | ❌ | ❌ | ✅ | ✅ |
| 停止监控 | ✅ | ✅ | ✅ | ✅ | ❌ | ✅ |
| 清除后 | ✅ | ❌ | ❌ | ❌ | ❌ | ✅ |

### 数据验证
1. **大于EMA数量 + 小于EMA数量**：每个合约只有一个为正数，另一个必为0
2. **时间戳递增**：K线的OpenTime必须严格递增
3. **去重正确**：同一时间戳的K线只保留一条
4. **覆盖最后一根**：增量更新时正确覆盖可能不完整的最后一根K线

---

## 🐛 已知问题排查

### 问题1：更新K线后连续数量没变化
**原因**：更新K线后需要重新点击"计算"按钮
**解决**：每次更新K线后，手动点击"计算"按钮

### 问题2：筛选后排序失效
**原因**：筛选会重新设置ItemsSource
**解决**：筛选后再次点击列标题排序

### 问题3：连续数量都是0
**原因**：未点击"计算"按钮
**解决**：获取或更新K线后，必须点击"计算"按钮

---

## ✅ 测试检查清单

### 功能测试
- [ ] 基本获取K线功能正常
- [ ] 增量更新K线功能正常
- [ ] 计算连续数量功能正常
- [ ] 大于EMA筛选功能正常
- [ ] 小于EMA筛选功能正常
- [ ] 清除筛选功能正常
- [ ] 列排序功能正常
- [ ] 双击复制合约名正常

### 按钮状态测试
- [ ] 初始状态按钮正确
- [ ] 获取成功后按钮正确
- [ ] 启动监控后按钮正确
- [ ] 停止监控后按钮正确
- [ ] 清除缓存后按钮正确

### 参数验证测试
- [ ] N天均线参数验证正常
- [ ] X根K线参数验证正常
- [ ] 筛选条件参数验证正常
- [ ] 空输入处理正常

### 数据正确性测试
- [ ] K线时间戳递增
- [ ] K线周期为1小时
- [ ] K线去重正确
- [ ] 最后一根K线正确覆盖
- [ ] 连续数量计算正确
- [ ] 筛选结果正确

### UI测试
- [ ] 表格显示正常
- [ ] 进度条更新正常
- [ ] 状态栏显示正常
- [ ] 消息提示正常
- [ ] 控制台日志完整

---

## 📞 测试反馈

测试过程中如发现问题，请记录：
1. 问题描述
2. 复现步骤
3. 预期结果
4. 实际结果
5. 控制台日志
6. 错误截图（如有）

---

**测试指南结束** ✅

