# 许可证到期时间手动设置说明

## 问题描述

经过详细的测试和调试，我们发现：

### 服务器API返回情况

所有三种请求格式都返回了错误：
- ❌ **方式1**（表单数据）：`415 Unsupported Media Type` - 服务器不支持表单格式
- ❌ **方式2**（JSON小写字段名）：`{"success":false,"message":"参数不完整"}`
- ❌ **方式3**（JSON PascalCase字段名）：`{"success":false,"message":"参数不完整"}`

### SDK返回情况

RegisterSrv.ClientSDK 返回的验证结果：
```
IsValid = False
Message = 验证成功  ← 矛盾：验证成功但IsValid=False
ExpiresAt = (空)
LicenseType = (空)
```

### 结论

**服务器端没有返回有效的许可证到期时间和类型信息。**

可能的原因：
1. 服务器API需要额外的参数（如签名、时间戳等）
2. SDK内部使用了特殊的验证机制
3. 服务器端设计上就没有返回这些字段
4. API版本不匹配

## 解决方案

### 方案1：手动设置到期时间（临时方案）

我已经为你添加了一个本地缓存机制和手动设置功能。

#### 使用方法

在程序启动后，在控制台或调试器中调用：

```csharp
// 获取主窗口实例
var mainWindow = Application.Current.MainWindow as MainWindow;

// 设置到期时间为一年后
mainWindow.SetLicenseExpiryManually();

// 或者指定具体的到期时间
mainWindow.SetLicenseExpiryManually(
    new DateTime(2026, 10, 20), // 到期时间
    "年度许可"                   // 许可证类型
);
```

#### 缓存位置

许可证信息会缓存到：
```
C:\Users\{用户名}\AppData\Local\BinanceApps\license_info.json
```

内容示例：
```json
{
  "ExpiresAt": "2025-10-20 00:00:00",
  "LicenseType": "年度许可",
  "SavedAt": "2024-10-20 10:30:00"
}
```

### 方案2：直接修改缓存文件

1. 创建或编辑文件：`C:\Users\Administrator\AppData\Local\BinanceApps\license_info.json`

2. 写入以下内容：
```json
{
  "ExpiresAt": "2025-10-20 00:00:00",
  "LicenseType": "年度许可",
  "SavedAt": "2024-10-20 00:00:00"
}
```

3. 重启应用

### 方案3：联系服务器开发者

建议联系 RegisterSrv API 的开发者，询问：

1. **API文档**：完整的API参数说明
2. **到期时间字段**：服务器是否返回 `ExpiresAt` 或类似字段
3. **许可证类型字段**：服务器是否返回 `LicenseType` 或类似字段
4. **额外参数**：是否需要签名、时间戳等额外验证参数

## 实现的功能

### 1. 多级获取机制

程序现在会按以下顺序尝试获取到期时间：
1. SDK 返回的 `ExpiresAt`
2. 直接调用服务器API（尝试三种格式）
3. 本地缓存的许可证信息
4. 默认值（364天）

### 2. 自动缓存

当成功获取到有效的到期时间时，会自动缓存到本地，避免每次都调用服务器。

### 3. 详细日志

所有尝试过程都会输出到控制台，方便调试：
- SDK返回的所有属性
- 服务器请求的详细参数
- 服务器响应的原始内容
- 所有响应字段的名称和值

## 测试结果

根据你提供的日志：

```
🔍 尝试方式1: 表单数据
   application_id=App_20250928132921
   license_key=SOKS-9GC3-75CM-R15D
   machine_code=BC0694E280B711CBD7B893CB3677B26A
🔍 服务器响应 (表单方式): {"type":"...","status":415,...}

🔍 尝试方式2: JSON 数据 (小写字段名)
   JSON: {"application_id":"...","license_key":"...","machine_code":"..."}
🔍 服务器响应 (JSON方式): {"success":false,"message":"参数不完整"}

🔍 尝试方式3: JSON 数据 (PascalCase字段名)
   JSON: {"ApplicationId":"...","LicenseKey":"...","MachineCode":"..."}
🔍 服务器响应 (PascalCase方式): {"success":false,"message":"参数不完整"}
```

**所有方式都失败了，证明服务器端需要额外的参数或使用了不同的验证机制。**

## 建议

### 短期方案
使用手动设置功能 + 本地缓存，可以正常显示到期时间。

### 长期方案
1. 获取 RegisterSrv.ClientSDK 的源代码或详细文档
2. 查看 SDK 内部如何调用服务器API
3. 或直接联系服务器API开发者获取正确的调用方式

## 注意事项

1. 本地缓存的许可证信息仅用于显示，不影响实际的许可证验证
2. 实际的许可证验证仍由 `LicenseManager.ValidateCurrentLicenseAsync()` 完成
3. 缓存文件可以手动编辑，但建议使用程序提供的方法设置

## 相关文件

- `src/BinanceApps.WPF/LicenseKeyStorage.cs` - 许可证信息存储和缓存
- `src/BinanceApps.WPF/MainWindow.xaml.cs` - 主窗口，包含获取和显示逻辑
- `C:\Users\{用户名}\AppData\Local\BinanceApps\license_info.json` - 本地缓存文件

