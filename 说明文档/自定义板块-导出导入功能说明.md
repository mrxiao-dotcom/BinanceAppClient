# 自定义板块 - 导出导入功能说明

## 📊 功能概述

在自定义板块监控中添加导出和导入功能，支持将所有组合数据备份到JSON文件，也可以从文件恢复数据。

---

## ✨ 功能特性

### 1. 导出组合 📤
- **功能**：将所有组合数据导出到JSON文件
- **包含内容**：
  - 所有组合信息（ID、名称、描述、分组）
  - 所有合约列表
  - 合约备注
  - 创建时间和修改时间
  - 所有关系数据

- **用途**：
  - 数据备份
  - 跨设备同步
  - 分享组合配置
  - 版本管理

### 2. 导入组合 📥
- **功能**：从JSON文件导入组合数据
- **特性**：
  - 覆盖当前所有组合
  - 自动备份原数据
  - 验证文件格式
  - 显示导入统计

- **安全性**：
  - 导入前警告确认
  - 自动创建备份
  - 失败不影响原数据

---

## 🎨 UI界面

### 按钮位置
```
┌────────────────────────────────────────────────────────┐
│ 自定义板块监控                                    [X]   │
├────────────────────────────────────────────────────────┤
│ [创建组合] [刷新数据] [创建分组] [导出组合] [导入组合]  │
│                               ↑新增     ↑新增           │
├────────────────────────────────────────────────────────┤
│  组合列表         │  组合详情                          │
│  ...              │  ...                               │
└────────────────────────────────────────────────────────┘
```

### 按钮样式
- **导出组合**：青蓝色背景 (#17A2B8)
- **导入组合**：琥珀色背景 (#FFC107)
- **尺寸**：宽度100px，高度32px

---

## 🔧 使用方法

### 导出组合

**步骤1：点击"导出组合"按钮**
```
显示确认对话框：
┌─────────────────────────────┐
│ 确认导出                     │
├─────────────────────────────┤
│ 即将导出以下数据：           │
│                             │
│ 组合数量：5 个              │
│ 合约总数：38 个             │
│ 分组数量：3 个              │
│ 分组列表：经典组、次新组... │
│                             │
│ 是否继续？                   │
│                             │
│      [是(Y)]  [否(N)]       │
└─────────────────────────────┘
```

**步骤2：选择保存位置**
```
┌─────────────────────────────────────┐
│ 导出组合到JSON文件                   │
├─────────────────────────────────────┤
│ 保存位置: D:\Backup\                │
│ 文件名: custom_portfolios_20251005_143025.json │
│ 文件类型: JSON文件 (*.json)         │
│                                     │
│          [保存]  [取消]             │
└─────────────────────────────────────┘
```

**步骤3：导出成功**
```
┌─────────────────────────────┐
│ 导出成功                     │
├─────────────────────────────┤
│ 文件路径：D:\Backup\...     │
│ 组合数量：5 个              │
│ 合约总数：38 个             │
│                             │
│           [确定]            │
└─────────────────────────────┘
```

---

### 导入组合

**步骤1：点击"导入组合"按钮**
```
显示警告对话框：
┌─────────────────────────────────┐
│ 确认导入                  ⚠️    │
├─────────────────────────────────┤
│ 警告：导入组合将会覆盖当前所有  │
│ 组合数据！                      │
│                                 │
│ 系统会自动创建当前数据的备份。  │
│                                 │
│ 是否继续？                       │
│                                 │
│      [是(Y)]  [否(N)]           │
└─────────────────────────────────┘
```

**步骤2：选择导入文件**
```
┌─────────────────────────────────────┐
│ 选择要导入的JSON文件                 │
├─────────────────────────────────────┤
│ 查找范围: D:\Backup\                │
│ 文件名: custom_portfolios_*.json   │
│ 文件类型: JSON文件 (*.json)         │
│                                     │
│          [打开]  [取消]             │
└─────────────────────────────────────┘
```

**步骤3：导入成功**
```
┌─────────────────────────────┐
│ 导入成功                     │
├─────────────────────────────┤
│ 组合数量：5 个              │
│ 合约总数：38 个             │
│ 分组数量：3 个              │
│                             │
│ 原数据已自动备份。           │
│                             │
│           [确定]            │
└─────────────────────────────┘
```

---

## 📄 JSON文件格式

### 文件结构
```json
{
  "Version": "1.0",
  "LastUpdated": "2025-10-05T14:30:25.123Z",
  "Portfolios": [
    {
      "Id": "guid-1234-5678",
      "Name": "优质币种组合",
      "Description": "经过精选的优质币种",
      "GroupName": "经典组",
      "Symbols": [
        {
          "Symbol": "BTCUSDT",
          "Remark": "比特币",
          "AddedTime": "2025-10-01T10:00:00Z"
        },
        {
          "Symbol": "ETHUSDT",
          "Remark": "以太坊",
          "AddedTime": "2025-10-01T10:05:00Z"
        }
      ],
      "CreatedTime": "2025-10-01T10:00:00Z",
      "LastModifiedTime": "2025-10-05T12:00:00Z"
    }
  ]
}
```

### 字段说明

**顶层字段**：
- `Version`：文件格式版本（当前为"1.0"）
- `LastUpdated`：文件最后更新时间
- `Portfolios`：组合列表数组

**组合字段（Portfolio）**：
- `Id`：组合唯一标识（GUID）
- `Name`：组合名称
- `Description`：组合说明
- `GroupName`：所属分组名称
- `Symbols`：合约列表
- `CreatedTime`：创建时间
- `LastModifiedTime`：最后修改时间

**合约字段（Symbol）**：
- `Symbol`：合约代码（如：BTCUSDT）
- `Remark`：备注信息
- `AddedTime`：添加时间

---

## 🔒 安全特性

### 1. 数据备份机制
**导入时自动备份**：
- 备份文件名：`custom_portfolios.json.backup_yyyyMMdd_HHmmss`
- 备份位置：与原数据文件相同目录
- 备份时机：导入操作执行前

**示例**：
```
原文件：C:\Users\...\AppData\Local\BinanceApps\custom_portfolios.json
备份文件：C:\Users\...\AppData\Local\BinanceApps\custom_portfolios.json.backup_20251005_143025
```

### 2. 确认机制
- **导出前确认**：显示统计信息，用户确认后才执行
- **导入前警告**：明确告知会覆盖数据，需要用户确认

### 3. 错误处理
- **文件格式验证**：导入前验证JSON格式
- **异常捕获**：所有操作都有异常处理
- **失败回滚**：导入失败不影响原数据

---

## 🎯 使用场景

### 场景 1：定期备份
**需求**：定期备份组合数据

**方法**：
1. 每周或每月点击"导出组合"
2. 保存到备份目录
3. 文件名自动包含日期时间戳

**建议备份频率**：
- 经常修改：每周备份
- 偶尔修改：每月备份
- 重要操作前：立即备份

---

### 场景 2：跨设备同步
**需求**：在多台电脑使用相同的组合配置

**方法**：
1. 在电脑A上导出组合
2. 将JSON文件复制到电脑B
3. 在电脑B上导入组合

**同步流程**：
```
电脑A（工作机）        云盘/U盘         电脑B（家里）
    ↓                     ↓                 ↓
[导出组合] ──→ [上传文件] ──→ [下载文件] ──→ [导入组合]
```

---

### 场景 3：分享配置
**需求**：与他人分享自己的组合配置

**方法**：
1. 导出组合到JSON文件
2. 发送文件给对方
3. 对方导入后获得相同配置

**注意事项**：
- JSON文件是纯文本，可以直接查看和编辑
- 可以手动修改JSON文件中的内容
- 导入前确认文件来源可信

---

### 场景 4：版本管理
**需求**：管理不同版本的组合配置

**方法**：
1. 每次重大修改前导出当前配置
2. 按版本号命名文件
3. 需要时可以恢复到任意版本

**命名建议**：
```
portfolios_v1.0_基础版本.json
portfolios_v1.1_添加DeFi板块.json
portfolios_v2.0_重组分类.json
```

---

### 场景 5：数据迁移
**需求**：重装系统或更换电脑

**方法**：
1. 重装前导出组合
2. 重装后安装程序
3. 导入之前的组合文件

**重要提示**：
- 重装系统前务必导出备份
- 备份文件保存到非系统盘
- 验证备份文件可以正常打开

---

## 🔧 技术实现

### 后端服务（CustomPortfolioService）

#### 导出方法
```csharp
public async Task<bool> ExportToFileAsync(string filePath)
{
    // 1. 验证数据
    if (_portfolioData == null)
    {
        _logger.LogWarning("没有数据可以导出");
        return false;
    }
    
    // 2. 创建导出数据
    var exportData = new CustomPortfolioFile
    {
        Version = _portfolioData.Version,
        LastUpdated = DateTime.UtcNow,
        Portfolios = _portfolioData.Portfolios
    };
    
    // 3. 序列化为JSON（格式化输出）
    var options = new JsonSerializerOptions
    {
        WriteIndented = true,  // 格式化输出
        Encoder = System.Text.Encodings.Web.JavaScriptEncoder.UnsafeRelaxedJsonEscaping  // 支持中文
    };
    
    var json = JsonSerializer.Serialize(exportData, options);
    
    // 4. 写入文件
    await File.WriteAllTextAsync(filePath, json);
    
    return true;
}
```

#### 导入方法
```csharp
public async Task<bool> ImportFromFileAsync(string filePath)
{
    // 1. 验证文件存在
    if (!File.Exists(filePath))
    {
        return false;
    }
    
    // 2. 读取并反序列化JSON
    var json = await File.ReadAllTextAsync(filePath);
    var importData = JsonSerializer.Deserialize<CustomPortfolioFile>(json);
    
    // 3. 验证数据有效性
    if (importData == null || importData.Portfolios == null)
    {
        return false;
    }
    
    // 4. 备份当前数据
    var backupPath = _dataFilePath + $".backup_{DateTime.Now:yyyyMMdd_HHmmss}";
    if (File.Exists(_dataFilePath))
    {
        File.Copy(_dataFilePath, backupPath, true);
    }
    
    // 5. 覆盖现有数据
    _portfolioData = importData;
    _portfolioData.LastUpdated = DateTime.UtcNow;
    
    // 6. 保存到本地
    await SaveDataAsync();
    
    return true;
}
```

#### 统计方法
```csharp
public (int portfolioCount, int totalSymbols, List<string> groups) GetStatistics()
{
    var portfolioCount = _portfolioData.Portfolios.Count;
    var totalSymbols = _portfolioData.Portfolios.Sum(p => p.SymbolCount);
    var groups = _portfolioData.Portfolios
        .Select(p => p.GroupName)
        .Where(g => !string.IsNullOrWhiteSpace(g))
        .Distinct()
        .OrderBy(g => g)
        .ToList();
    
    return (portfolioCount, totalSymbols, groups);
}
```

---

### 前端UI（CustomPortfolioWindow）

#### 导出按钮事件
```csharp
private async void BtnExportPortfolios_Click(object sender, RoutedEventArgs e)
{
    // 1. 获取统计信息
    var (portfolioCount, totalSymbols, groups) = _portfolioService.GetStatistics();
    
    // 2. 显示确认对话框
    var message = $"即将导出以下数据：\n\n" +
                 $"组合数量：{portfolioCount} 个\n" +
                 $"合约总数：{totalSymbols} 个\n" +
                 $"分组数量：{groups.Count} 个\n" +
                 $"\n是否继续？";
    
    if (MessageBox.Show(message, "确认导出", MessageBoxButton.YesNo) != MessageBoxResult.Yes)
        return;
    
    // 3. 打开保存文件对话框
    var saveDialog = new Microsoft.Win32.SaveFileDialog
    {
        Title = "导出组合到JSON文件",
        Filter = "JSON文件 (*.json)|*.json|所有文件 (*.*)|*.*",
        DefaultExt = "json",
        FileName = $"custom_portfolios_{DateTime.Now:yyyyMMdd_HHmmss}.json"
    };
    
    if (saveDialog.ShowDialog() != true)
        return;
    
    // 4. 执行导出
    var success = await _portfolioService.ExportToFileAsync(saveDialog.FileName);
    
    // 5. 显示结果
    if (success)
    {
        MessageBox.Show("导出成功！", "导出成功", MessageBoxButton.OK);
    }
}
```

#### 导入按钮事件
```csharp
private async void BtnImportPortfolios_Click(object sender, RoutedEventArgs e)
{
    // 1. 警告提示
    var warningResult = MessageBox.Show(
        "警告：导入组合将会覆盖当前所有组合数据！\n\n" +
        "系统会自动创建当前数据的备份。\n\n" +
        "是否继续？",
        "确认导入",
        MessageBoxButton.YesNo,
        MessageBoxImage.Warning);
    
    if (warningResult != MessageBoxResult.Yes)
        return;
    
    // 2. 打开文件选择对话框
    var openDialog = new Microsoft.Win32.OpenFileDialog
    {
        Title = "选择要导入的JSON文件",
        Filter = "JSON文件 (*.json)|*.json|所有文件 (*.*)|*.*",
        DefaultExt = "json"
    };
    
    if (openDialog.ShowDialog() != true)
        return;
    
    // 3. 执行导入
    var success = await _portfolioService.ImportFromFileAsync(openDialog.FileName);
    
    // 4. 重新加载数据
    if (success)
    {
        await LoadPortfoliosAsync();
        MessageBox.Show("导入成功！", "导入成功", MessageBoxButton.OK);
    }
}
```

---

## 📝 修改文件清单

| 文件 | 修改内容 | 行数变化 |
|-----|---------|---------|
| `CustomPortfolioService.cs` | 添加导出导入方法 | 新增 120行 |
| `CustomPortfolioWindow.xaml` | 添加导出导入按钮 | 新增 10行 |
| `CustomPortfolioWindow.xaml.cs` | 添加按钮事件处理 | 新增 140行 |

**总计**：3个文件，约270行代码

---

## ✅ 功能清单

### 后端功能
- [x] ExportToFileAsync 方法
- [x] ImportFromFileAsync 方法
- [x] GetStatistics 方法
- [x] 自动备份机制
- [x] JSON格式化输出
- [x] 中文支持
- [x] 异常处理和日志

### 前端功能
- [x] 导出按钮UI
- [x] 导入按钮UI
- [x] 导出确认对话框
- [x] 导入警告对话框
- [x] 文件保存对话框
- [x] 文件打开对话框
- [x] 成功提示信息
- [x] 错误提示信息
- [x] 数据刷新

---

## 🧪 测试验证

### 导出功能测试
✅ **测试步骤**：
1. 创建几个测试组合
2. 点击"导出组合"按钮
3. 确认导出信息
4. 选择保存位置
5. 打开导出的JSON文件

✅ **预期结果**：
- JSON文件格式正确
- 包含所有组合数据
- 中文正常显示
- 文件可以用文本编辑器打开

---

### 导入功能测试
✅ **测试步骤**：
1. 准备一个导出的JSON文件
2. 点击"导入组合"按钮
3. 确认警告信息
4. 选择JSON文件
5. 查看导入结果

✅ **预期结果**：
- 导入成功
- 所有组合恢复
- 自动创建备份
- 界面自动刷新

---

### 备份机制测试
✅ **测试步骤**：
1. 导入一个JSON文件
2. 检查AppData目录

✅ **预期结果**：
- 生成备份文件
- 备份文件名包含时间戳
- 备份文件内容正确

---

### 错误处理测试
✅ **测试步骤**：
1. 尝试导入无效的JSON文件
2. 尝试导入格式错误的文件
3. 尝试导入到只读目录

✅ **预期结果**：
- 显示友好的错误提示
- 不影响现有数据
- 日志记录错误信息

---

## 📊 使用统计

### 导出统计
导出时显示的信息：
- 组合数量
- 合约总数
- 分组数量
- 分组列表

### 导入统计
导入成功后显示的信息：
- 组合数量
- 合约总数
- 分组数量
- 备份提示

---

## ⚠️ 注意事项

### 1. 数据覆盖
- 导入操作会**完全覆盖**当前所有组合
- 覆盖前会自动创建备份
- 请确认导入文件内容正确

### 2. 文件安全
- JSON文件是纯文本，可以直接查看
- 不要从不可信的来源导入文件
- 导入前可以先用文本编辑器检查内容

### 3. 版本兼容
- 当前版本：1.0
- 未来版本可能扩展字段
- 向后兼容旧版本文件

### 4. 备份管理
- 备份文件不会自动清理
- 定期清理旧备份文件
- 保留重要的备份

---

## 🔄 后续优化建议

### 1. 增量导入
**功能**：支持追加导入，不覆盖现有数据
```
选项：
☐ 覆盖导入（替换所有数据）
☑ 追加导入（合并到现有数据）
```

### 2. 选择性导出
**功能**：只导出选中的组合
```
[导出全部组合]
[导出选中组合]（当有选中时启用）
```

### 3. 导入预览
**功能**：导入前预览文件内容
```
┌────────────────────────────┐
│ 导入预览                    │
├────────────────────────────┤
│ 文件信息：                  │
│ - 组合数量：5 个            │
│ - 合约总数：38 个           │
│                            │
│ 组合列表：                  │
│ ☑ 优质币种组合（8个）       │
│ ☑ DeFi板块（12个）          │
│ ☑ ...                      │
│                            │
│    [全选]  [确认]  [取消]  │
└────────────────────────────┘
```

### 4. 云同步
**功能**：支持云端备份和同步
```
[导出到云盘]
[从云盘导入]
[自动同步]（定时）
```

### 5. 版本对比
**功能**：对比两个JSON文件的差异
```
[选择文件A]  [选择文件B]
[对比差异]
```

---

**功能版本**: 1.0.0  
**开发日期**: 2025-10-05  
**开发者**: AI Assistant  
**状态**: ✅ 已完成并通过编译测试

---

**关键词**：导出组合、导入组合、JSON备份、数据迁移、跨设备同步、版本管理

