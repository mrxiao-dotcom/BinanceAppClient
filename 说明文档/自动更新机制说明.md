# 自动更新机制说明

## 🎯 问题

在应用程序运行时，Windows 会锁定正在使用的 `.exe` 和 `.dll` 文件，导致无法直接覆盖这些文件，更新失败。

**错误现象**：
```
❌ 复制失败: xxx.dll - 文件正在被另一个进程使用
```

---

## ✅ 解决方案

采用**外部更新脚本**方案：

### 工作流程

```
1. 主程序检查更新
   ↓
2. 下载更新包到临时目录
   ↓
3. 生成更新脚本（.cmd）
   ↓
4. 启动更新脚本
   ↓
5. 主程序退出
   ↓
6. 更新脚本等待主程序退出
   ↓
7. 更新脚本解压并复制文件
   ↓
8. 更新脚本启动新版本
   ↓
9. 更新脚本自我删除
```

---

## 📋 技术实现

### 1. UpdateHelper 类

**位置**: `src/BinanceApps.WPF/UpdateHelper.cs`

**功能**:
- 生成 Windows 批处理脚本（.cmd）
- 启动更新脚本
- 处理进程管理

**关键方法**:
```csharp
public static void StartUpdate(
    string updatePackagePath,  // 更新包ZIP文件路径
    string targetDirectory,    // 目标安装目录
    string currentExePath,     // 当前程序路径
    string newVersion          // 新版本号
)
```

### 2. 更新脚本功能

**脚本文件**: 临时生成在 `%TEMP%\BinanceApps_Update_xxxxx.cmd`

**执行步骤**:

#### 步骤 1：等待主程序退出
```batch
taskkill /PID {processId} /F
timeout /t 2 /nobreak
```

#### 步骤 2：解压更新包
```batch
powershell -Command "Expand-Archive -Path '{updatePackage}' -DestinationPath '{tempDir}' -Force"
```

#### 步骤 3：备份当前版本
```batch
mkdir "backup_{timestamp}"
copy "{current.exe}" "backup_{timestamp}\"
```

#### 步骤 4：智能复制文件
```batch
robocopy "{tempDir}" "{targetDir}" /E /XO /XF App.config *.db *.log *.dat /NFL /NDL
```

**保护的文件**:
- `App.config` - 配置文件（含注册码）
- `appsettings.json` - 应用配置
- `*.db` - 数据库文件
- `*.log` - 日志文件
- `*.dat` - 数据文件（如 license.dat）

#### 步骤 5：清理并重启
```batch
:: 清理临时文件
del /f /q "{updatePackage}"
rd /s /q "{tempDir}"

:: 启动新版本
start "" "{app.exe}"

:: 自我删除
del /f /q "{script.cmd}"
```

---

## 🔄 集成到 FixedUpdateManager

**修改文件**: `src/BinanceApps.WPF/FixedUpdateManager.cs`

### 关键改动

#### 之前（直接复制，失败）
```csharp
// ❌ 在程序运行时直接复制DLL会失败
System.IO.File.Copy(sourceFile, targetFile, true);
```

#### 之后（外部脚本，成功）
```csharp
// ✅ 下载到临时目录
var updatePackagePath = Path.Combine(Path.GetTempPath(), $"Update_{version}.zip");
await DownloadUpdatePackageAsync(updateInfo, updatePackagePath);

// ✅ 启动外部更新脚本
UpdateHelper.StartUpdate(updatePackagePath, appDirectory, exePath, version);

// ✅ 关闭主程序（释放文件锁）
await Task.Delay(1000);
Application.Current.Shutdown();
```

---

## 🛡️ 文件保护机制

### 保护的文件类型

| 文件 | 原因 | 处理方式 |
|------|------|---------|
| `App.config` | 包含注册码和配置 | 不覆盖 |
| `appsettings.json` | 应用配置 | 不覆盖 |
| `*.db` | 数据库文件 | 不覆盖 |
| `*.log` | 日志文件 | 不覆盖 |
| `license.dat` | 许可证文件 | 不覆盖（在 AppData） |

### Robocopy 参数说明

```batch
robocopy 源 目标 /E /XO /XF App.config *.db *.log *.dat
```

- `/E` - 复制子目录（包括空目录）
- `/XO` - 排除较旧的文件（只复制更新的）
- `/XF` - 排除指定的文件模式

---

## 🧪 测试流程

### 1. 准备测试环境

```bash
# 1. 当前版本 1.0.8
# 2. 服务器版本 1.0.9
# 3. 确保 App.config 中有 CurrentAppVersion = 1.0.8
```

### 2. 测试更新

1. 运行应用程序（v1.0.8）
2. 点击"帮助" → "检查更新"
3. 确认发现新版本 v1.0.9
4. 点击"确定"开始更新
5. **观察更新脚本窗口**（会短暂显示）
6. 应用自动关闭
7. **更新脚本执行**：
   - 解压更新包
   - 复制文件
   - 备份旧版本
8. 应用自动重启（v1.0.9）
9. 验证：
   - 版本号显示 v1.0.9
   - 注册码仍然有效（未丢失）
   - 数据库文件完整
   - 日志文件保留

### 3. 验证点

- ✅ DLL 文件成功更新
- ✅ 配置文件未丢失
- ✅ 注册码仍然有效
- ✅ 数据库文件完整
- ✅ 应用程序自动重启
- ✅ 版本号正确显示

---

## 🔍 故障排查

### 问题 1：更新脚本闪退

**原因**: 脚本执行时间太短

**解决**: 修改 `UpdateHelper.cs`，在脚本中添加 `pause` 命令查看错误

```csharp
script.AppendLine("echo ========================================");
script.AppendLine("pause");  // ← 添加暂停，查看错误
```

### 问题 2：文件复制失败

**原因**: Robocopy 权限不足或路径错误

**解决**: 
1. 检查应用程序是否以管理员权限运行
2. 查看临时目录权限：`%TEMP%`
3. 查看脚本日志（在临时目录）

### 问题 3：更新后注册码丢失

**原因**: App.config 被覆盖

**解决**: 
1. 检查 robocopy 命令是否正确排除 `App.config`
2. 确认 license.dat 在 AppData 目录
3. 验证 `LicenseKeyStorage` 正确加载

### 问题 4：应用未自动重启

**原因**: 启动命令路径错误

**解决**:
```batch
:: 确保使用绝对路径
start "" "D:\完整路径\BinanceApps.WPF.exe"
```

---

## 📊 与其他方案对比

| 方案 | 优点 | 缺点 | 适用场景 |
|------|------|------|---------|
| 直接覆盖 | 简单 | ❌ DLL锁定失败 | ❌ 不适用 |
| 外部更新器 | 独立程序 | 需要额外打包 | 大型应用 |
| **批处理脚本** | ✅ 简单可靠 | Windows专用 | ✅ WPF应用 |
| MSI安装包 | 专业 | 复杂，需签名 | 企业应用 |

---

## 🎯 最佳实践

### 1. 版本号管理

```xml
<!-- .csproj -->
<Version>1.0.9</Version>

<!-- App.config -->
<add key="CurrentAppVersion" value="1.0.9" />

<!-- 快速打包更新.cmd -->
set ZIP_NAME=BinanceApps_v1.0.9.zip
```

### 2. 更新包结构

```
BinanceApps_v1.0.9.zip
├── BinanceApps.WPF.exe           ← 主程序（必须更新）
├── *.dll                         ← 依赖库（必须更新）
├── runtimes/                     ← 运行时
├── KlineData/                    ← 数据目录（保留）
└── [不包含]
    ├── App.config                ← 配置文件（保护）
    ├── *.db                      ← 数据库（保护）
    └── *.log                     ← 日志（保护）
```

### 3. 发布流程

1. **修改版本号**（3个位置）
2. **在 VS2022 中发布**
3. **运行 `快速打包更新.cmd`**
4. **上传 ZIP 到服务器**
5. **在服务器创建新版本**
6. **客户端测试更新**

---

## 📚 相关文档

- `WPF应用集成许可证验证和自动更新指南.md` - 完整集成指南
- `发布和打包工作流程.md` - 发布流程
- `服务器地址配置说明.md` - 服务器配置

---

## ✅ 总结

### 核心优势

1. ✅ **解决DLL锁定问题** - 外部脚本在主程序退出后执行
2. ✅ **保护用户数据** - 智能识别并保护配置文件
3. ✅ **自动化程度高** - 无需用户手动操作
4. ✅ **故障恢复** - 自动备份旧版本
5. ✅ **简单可靠** - 使用标准 Windows 工具

### 关键技术

- Windows Batch Script
- Process Management
- File System Operations
- Robocopy (智能文件复制)
- PowerShell (解压ZIP)

---

**文档版本**: 1.0  
**更新日期**: 2025-10-01  
**适用版本**: BinanceApps 1.0.8+  
**解决问题**: ✅ DLL 锁定导致更新失败 