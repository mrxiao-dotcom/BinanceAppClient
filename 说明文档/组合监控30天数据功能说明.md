# 组合监控30天数据功能说明

## ✨ 新增功能

### 1. 合约明细新增30天数据

在组合监控的**合约明细区域**，新增以下数据列：

| 列名 | 说明 | 数据来源 |
|------|------|----------|
| **30天涨幅** | 当前价相对30天最低价的涨幅 | `(当前价 - 30天最低价) / 30天最低价 * 100%` |
| **30天最高** | 最近30天的最高价 | 基于本地K线数据 |
| **30天最低** | 最近30天的最低价 | 基于本地K线数据 |

**显示效果**：
- 30天涨幅：带颜色显示（绿色/红色），支持排序
- 30天最高/最低：灰色显示，便于对比当前价格位置

### 2. 组合增加30天平均涨幅

在**组合列表区域**，新增组合30天平均涨幅：

```
组合名称
24H:+2.50% ↑  30天:+15.30% ↑  5个  $25.3M
```

**计算逻辑**：
- 30天平均涨幅 = 所有成分合约的30天涨幅的**算术平均值**
- 带颜色显示（绿色/红色）和箭头方向指示

---

## 📊 明细区域完整列表

| 序号 | 列名 | 宽度 | 可排序 | 说明 |
|------|------|------|--------|------|
| 1 | 合约 | 110 | ❌ | 合约名称，双击可复制 |
| 2 | 24H涨幅 | 75 | ✅ | 24小时涨跌幅 |
| 3 | 价格 | 90 | ✅ | 当前价格 |
| 4 | **30天涨幅** | 75 | ✅ | **新增**：相对30天最低价涨幅 |
| 5 | **30天最高** | 80 | ❌ | **新增**：30天内最高价 |
| 6 | **30天最低** | 80 | ❌ | **新增**：30天内最低价 |
| 7 | 成交额 | 75 | ✅ | 24H成交额 |
| 8 | 备注 | * | ❌ | 自定义备注 |

---

## 🔧 技术实现

### 1. 数据模型扩展

**`PortfolioSymbolData` 新增字段**：

```csharp
/// <summary>
/// 30天最高价
/// </summary>
public decimal HighPrice30d { get; set; }

/// <summary>
/// 30天最低价
/// </summary>
public decimal LowPrice30d { get; set; }

/// <summary>
/// 30天涨幅（当前价相对30天最低价的涨幅）
/// </summary>
public decimal PriceChangePercent30d { get; set; }
```

**`PortfolioRuntimeData` 新增字段**：

```csharp
/// <summary>
/// 组合30天涨幅（算数平均）
/// </summary>
public decimal AveragePriceChangePercent30d { get; set; }
```

### 2. 数据计算逻辑

**方法**: `Calculate30DayDataAsync(string symbol, decimal currentPrice)`

**流程**：
```
1. 加载本地K线数据 (LoadKlineDataAsync)
2. 取最近30天数据 (OrderByDescending → Take(30))
3. 计算最高价 (Max(k => k.HighPrice))
4. 计算最低价 (Min(k => k.LowPrice))
5. 计算涨幅 ((当前价 - 最低价) / 最低价 * 100)
```

**数据源**：
- ✅ 使用本地K线数据（`KlineDataStorageService`）
- ❌ 不重复下载K线数据
- ⚡ 如果没有K线数据，返回 (0, 0, 0)

### 3. UI更新频率

- 自动刷新周期：**5秒**
- 每次刷新都会重新计算30天数据
- 确保数据实时性

---

## 📋 使用场景

### 场景 1：观察合约中长期涨幅

**问题**：24H涨幅只能看到短期波动，无法了解中期趋势

**解决**：通过30天涨幅，可以：
- 看到合约从30天最低点到现在的累计涨幅
- 判断合约是否处于上升趋势
- 对比24H涨幅和30天涨幅，判断近期走势

**示例**：
```
BTCUSDT
24H: +2.5%  价格: $68,500  30天涨幅: +25.3%
30天最高: $70,000  30天最低: $54,000
```

**分析**：
- 30天涨幅为+25.3%，说明从30天低点反弹强劲
- 当前价接近30天最高，可能处于高位
- 24H涨幅仅+2.5%，短期上涨动能减弱

### 场景 2：识别组合整体表现

**问题**：只看24H数据无法判断组合的中期表现

**解决**：组合30天平均涨幅显示：
- 组合作为整体的中期收益情况
- 是否跑赢大盘
- 组合配置是否合理

**示例**：
```
DeFi板块组合
24H: -1.2% ↓  30天: +35.8% ↑  8个
```

**分析**：
- 尽管今天下跌了1.2%，但30天累计上涨35.8%
- 说明组合中期表现强劲
- 短期调整可能是买入机会

### 场景 3：寻找回调买点

**问题**：不知道当前价格是否处于合理位置

**解决**：对比当前价、30天最高、30天最低：
- 接近30天最高 → 可能高位
- 接近30天最低 → 可能低位
- 处于中间 → 相对合理

**示例**：
```
ETHUSDT
价格: $3,200  30天最高: $3,800  30天最低: $2,600
30天涨幅: +23.1%
```

**分析**：
- 当前价 $3,200
- 30天区间：$2,600 ~ $3,800
- 位置：((3200-2600)/(3800-2600)) = 50%
- 处于30天区间的中位，相对合理

---

## 🎯 排序功能

### 可排序列

1. **24H涨幅** - 查看短期强势合约
2. **价格** - 查看高价/低价合约
3. **30天涨幅** ⭐ **新增** - 查看中期强势合约
4. **成交额** - 查看活跃度

### 排序使用

**点击列标题**：
- 第1次点击：降序排序 ▼
- 第2次点击：升序排序 ▲
- 第3次点击：恢复默认（按24H涨幅降序）

**示例**：
```
点击 "30天涨幅" → 显示30天涨幅最高的合约在前
再次点击 → 显示30天涨幅最低的合约在前
```

---

## ⚙️ 配置和依赖

### 前置条件

1. **K线数据**：
   - 需要有本地存储的K线数据
   - 数据路径：`D:\AppData\kline\{symbol}.json`
   - 如果没有数据，30天相关字段显示为 "-" 或 "0%"

2. **服务依赖**：
   - `KlineDataStorageService` - 加载K线数据
   - `IBinanceSimulatedApiClient` - 获取实时Ticker数据
   - `CustomPortfolioService` - 组合CRUD操作

### 性能影响

| 操作 | 性能影响 | 说明 |
|------|---------|------|
| 初次加载 | 轻微延迟 | 需计算所有合约的30天数据 |
| 自动刷新 | 5秒一次 | 后台异步计算，不影响UI |
| K线数据读取 | 本地文件读取 | 速度快，缓存友好 |

### 错误处理

**场景 1：K线数据不存在**
```
结果：30天相关字段显示为 0 或 "-"
日志：不记录警告（避免日志过多）
```

**场景 2：K线数据不足30天**
```
结果：使用现有数据计算（例如只有10天）
计算：仍然正常计算最高/最低/涨幅
```

**场景 3：计算异常**
```
结果：返回 (0, 0, 0)
日志：记录警告信息
显示：该合约30天数据显示为 0 或 "-"
```

---

## 🧪 测试验证

### 测试步骤

1. **启动应用程序**

2. **打开自定义组合监控**
   - 主窗口 → 左侧菜单 → "自定义板块监控"

3. **创建测试组合**（如果没有）
   ```
   组合名称：测试30天数据
   合约：BTCUSDT, ETHUSDT, BNBUSDT
   ```

4. **观察组合列表**
   - ✅ 检查是否显示 "24H: ..." 和 "30天: ..."
   - ✅ 检查30天涨幅的颜色是否正确（绿色/红色）

5. **选中组合查看明细**
   - ✅ 检查是否有 "30天涨幅"、"30天最高"、"30天最低" 列
   - ✅ 检查数据是否合理（最高 > 当前价 > 最低 或其他合理关系）
   - ✅ 检查如果没有K线数据，是否显示 "-"

6. **测试排序功能**
   - ✅ 点击 "30天涨幅" 列标题
   - ✅ 检查是否按30天涨幅降序排列
   - ✅ 再次点击，检查是否变为升序

7. **等待自动刷新**
   - ✅ 等待5秒，观察数据是否自动更新

### 预期结果

**正常情况**（有K线数据）：
```
BTCUSDT
24H涨幅: +2.5%  价格: $68,500
30天涨幅: +25.3%  30天最高: $70,000  30天最低: $54,000
成交额: $2.5B  备注: -
```

**无K线数据情况**：
```
TESTUSDT
24H涨幅: +1.2%  价格: $0.5000
30天涨幅: -  30天最高: -  30天最低: -
成交额: $100K  备注: 测试合约
```

---

## 📝 数据说明

### 30天涨幅的含义

**公式**：
```
30天涨幅 = (当前价 - 30天最低价) / 30天最低价 × 100%
```

**示例计算**：
```
当前价：$68,500
30天最低：$54,000
30天涨幅 = (68500 - 54000) / 54000 × 100% = 26.85%
```

**与24H涨幅的区别**：
- **24H涨幅**：相对于24小时前的价格变化
- **30天涨幅**：相对于30天内最低价的涨幅（反弹幅度）

**意义**：
- 显示从最低点的反弹强度
- 适合判断趋势强度和是否过度买入

### 组合30天平均涨幅

**公式**：
```
组合30天涨幅 = Σ(每个合约的30天涨幅) / 合约数量
```

**示例计算**：
```
BTCUSDT: +25.3%
ETHUSDT: +30.5%
BNBUSDT: +18.2%

组合30天涨幅 = (25.3 + 30.5 + 18.2) / 3 = 24.67%
```

---

## 🔄 更新日志

| 版本 | 日期 | 更新内容 |
|------|------|---------|
| 1.0.8 | 2025-10-02 | 新增30天数据功能 |

---

## 🚀 后续计划

### 可能的优化方向

1. **性能优化**
   - 缓存30天数据计算结果
   - 只在K线数据更新时重新计算

2. **功能扩展**
   - 支持自定义天数（7天、14天、60天等）
   - 增加30天平均价显示
   - 增加价格在30天区间的位置百分比

3. **可视化增强**
   - 添加迷你K线图
   - 价格位置可视化（进度条）

---

**功能版本**: 1.0.8  
**实现日期**: 2025-10-02  
**测试状态**: ✅ 待验证 