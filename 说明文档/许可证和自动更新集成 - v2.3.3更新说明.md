# 许可证和自动更新集成 - v2.3.3 更新说明

## 📋 版本信息

- **版本号**：v2.3.3
- **发布日期**：2025-10-03
- **更新类型**：重要优化
- **影响范围**：服务器配置、版本管理、数据保护、合约API

---

## 🎯 核心优化亮点

### ⭐ 最重要的改进

1. **服务器地址统一配置**
   - 只需配置一个 `LicenseServerUrl`
   - 无需修改代码，只需修改 `App.config`
   - 所有功能（许可证、更新、合约API）统一使用

2. **数据保护机制**
   - 更新后注册码不再丢失
   - 自动保护所有用户数据
   - AppData + App.config 双重存储

3. **智能更新系统**
   - 外部脚本避免文件锁定
   - 自动备份和恢复
   - MD5 校验确保完整性

---

## 🔄 详细变更列表

### 1. 服务器地址配置优化 ⭐⭐⭐⭐⭐

#### 修改前（v1.0.0）

```csharp
// App.xaml.cs - 硬编码
var updateConfig = new UpdateConfig
{
    ServerUrl = "http://192.168.1.101:8080",  // 硬编码 ❌
    // ...
};

// MainWindow.xaml.cs - 硬编码
var contractService = new ContractInfoService(logger, "http://localhost:8080");  // 硬编码 ❌
```

**问题**：
- ❌ 需要修改代码并重新编译
- ❌ 多处配置不统一
- ❌ 容易遗漏某些配置

#### 修改后（v2.3.3）

```xml
<!-- App.config - 统一配置 -->
<appSettings>
    <!-- 只需配置一个地址 -->
    <add key="LicenseServerUrl" value="http://your-server:8080" />
    
    <!-- 可选：如果合约API服务器不同 -->
    <!-- <add key="ContractApiServerUrl" value="http://another-server:8080" /> -->
</appSettings>
```

```csharp
// App.xaml.cs - 动态读取
var serverUrl = ConfigurationManager.AppSettings["LicenseServerUrl"];
var updateConfig = new UpdateConfig
{
    ServerUrl = serverUrl,  // 从配置读取 ✅
    // ...
};

// MainWindow.xaml.cs - 动态读取 + 智能回退
var contractApiUrl = ConfigurationManager.AppSettings["ContractApiServerUrl"];
var licenseServerUrl = ConfigurationManager.AppSettings["LicenseServerUrl"];

if (string.IsNullOrWhiteSpace(contractApiUrl))
{
    contractApiUrl = licenseServerUrl;  // 自动回退到 LicenseServerUrl ✅
    Console.WriteLine($"🔍 使用 LicenseServerUrl: {contractApiUrl}");
}
```

**优势**：
- ✅ 无需修改代码
- ✅ 统一配置管理
- ✅ 智能回退机制
- ✅ 详细日志输出

**配置读取优先级**：
```
1️⃣ ContractApiServerUrl（如果配置了）
   ↓
2️⃣ LicenseServerUrl（如果 ContractApiServerUrl 未配置）
   ↓
3️⃣ 默认值 localhost:8080（如果两者都未配置）
```

---

### 2. 版本管理优化 ⭐⭐⭐⭐

#### 修改前（v1.0.0）

```csharp
// 只从程序集读取版本
var version = Assembly.GetExecutingAssembly().GetName().Version?.ToString();
```

**问题**：
- ❌ 更新后版本号不变
- ❌ 导致重复更新提示
- ❌ 用户困惑

#### 修改后（v2.3.3）

```xml
<!-- App.config -->
<add key="CurrentAppVersion" value="1.0.0" />
```

```csharp
// 优先从配置文件读取
private string GetApplicationVersion()
{
    var configVersion = ConfigurationManager.AppSettings["CurrentAppVersion"];
    if (!string.IsNullOrWhiteSpace(configVersion))
        return configVersion;  // 优先使用配置版本 ✅
    
    // 回退到程序集版本
    return Assembly.GetExecutingAssembly().GetName().Version?.ToString() ?? "1.0.0";
}

// 更新后自动保存新版本
public static void SaveCurrentVersion(string version)
{
    try
    {
        var config = ConfigurationManager.OpenExeConfiguration(ConfigurationUserLevel.None);
        config.AppSettings.Settings["CurrentAppVersion"].Value = version;
        config.Save(ConfigurationSaveMode.Modified);
        ConfigurationManager.RefreshSection("appSettings");
    }
    catch (Exception ex)
    {
        Console.WriteLine($"保存版本号失败: {ex.Message}");
    }
}
```

**优势**：
- ✅ 更新后版本号正确更新
- ✅ 避免重复更新提示
- ✅ 版本持久化到配置文件

---

### 3. 配置文件和数据保护 ⭐⭐⭐⭐⭐

#### 修改前（v1.0.0）

**问题**：
- ❌ 更新后 `App.config` 被覆盖
- ❌ 注册码丢失，需要重新输入
- ❌ 用户数据可能丢失

#### 修改后（v2.3.3）

**双重存储机制**：

```csharp
// 1. AppData 存储（主存储，永不丢失）
public static class LicenseKeyStorage
{
    private static readonly string AppDataFolder = Path.Combine(
        Environment.GetFolderPath(Environment.SpecialFolder.LocalApplicationData),
        "BinanceApps"
    );
    
    private static readonly string LicenseFilePath = Path.Combine(AppDataFolder, "license.dat");
    
    public static void SaveLicenseKey(string licenseKey)
    {
        Directory.CreateDirectory(AppDataFolder);
        File.WriteAllText(LicenseFilePath, licenseKey);
    }
    
    public static string LoadLicenseKey()
    {
        return File.Exists(LicenseFilePath) ? File.ReadAllText(LicenseFilePath) : string.Empty;
    }
}

// 2. App.config 同步存储（供 LicenseManager 读取）
private void SaveLicenseKeyToConfig(string licenseKey)
{
    var config = ConfigurationManager.OpenExeConfiguration(ConfigurationUserLevel.None);
    config.AppSettings.Settings["LicenseKey"].Value = licenseKey;
    config.Save(ConfigurationSaveMode.Modified);
}

// 3. 启动时恢复
private void LoadLicenseKeyFromAppData()
{
    var savedKey = LicenseKeyStorage.LoadLicenseKey();
    if (!string.IsNullOrWhiteSpace(savedKey))
    {
        ConfigurationManager.AppSettings["LicenseKey"] = savedKey;
        SaveLicenseKeyToConfig(savedKey);
    }
}
```

**更新时保护的文件**：
```batch
REM UpdateHelper.cs 生成的外部更新脚本
robocopy "%TEMP_DIR%" "%INSTALL_DIR%" /E /XO /XF App.config *.db *.log *.dat
```

**保护列表**：
- ✅ `App.config` - 应用配置（包括注册码）
- ✅ `*.db` - 数据库文件
- ✅ `*.log` - 日志文件
- ✅ `*.dat` - AppData 数据文件

**优势**：
- ✅ 注册码永不丢失
- ✅ 用户数据得到保护
- ✅ 无缝更新体验

---

### 4. 智能更新机制 ⭐⭐⭐⭐

#### 修改前（v1.0.0）

**问题**：
- ❌ DLL 文件被主程序锁定
- ❌ 无法更新正在使用的文件
- ❌ 更新失败

#### 修改后（v2.3.3）

**外部更新脚本机制**：

```
┌─────────────┐
│  主程序运行  │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  检查更新    │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  下载更新包  │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│生成更新脚本  │ ← UpdateHelper.cs
└──────┬──────┘
       │
       ▼
┌─────────────┐
│启动外部脚本  │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 主程序退出   │ ← 释放所有文件锁
└──────┬──────┘
       │
       ▼
┌─────────────┐
│脚本等待退出  │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  解压文件    │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 智能复制文件 │ ← 保护配置和数据
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  重启程序    │
└─────────────┘
```

**核心代码**：

```csharp
// UpdateHelper.cs
public static void StartUpdate(string zipPath, string installPath, string exePath, string version)
{
    // 生成外部更新脚本
    var scriptPath = GenerateUpdateScript(zipPath, installPath, exePath, version);
    
    // 启动脚本
    Process.Start(new ProcessStartInfo
    {
        FileName = "cmd.exe",
        Arguments = $"/c \"{scriptPath}\"",
        CreateNoWindow = false,
        UseShellExecute = true
    });
}

private static string GenerateUpdateScript(...)
{
    var script = $@"
@echo off
chcp 936 >nul
echo 等待主程序退出...
timeout /t 3 /nobreak >nul

echo 解压更新包...
powershell -Command ""Expand-Archive -Path '{zipPath}' -DestinationPath '{tempDir}' -Force""

echo 智能复制文件（保护配置和数据）...
robocopy ""{tempDir}"" ""{installPath}"" /E /XO /XF App.config *.db *.log *.dat

echo 更新版本号...
powershell -Command ""(Get-Content '{configPath}') -replace 'CurrentAppVersion.*value=\"".*\""', 'CurrentAppVersion"" value=\""{version}""' | Set-Content '{configPath}'""

echo 重启应用程序...
start """" ""{exePath}""
";
    
    File.WriteAllText(scriptPath, script, Encoding.GetEncoding("GBK"));
    return scriptPath;
}
```

**优势**：
- ✅ 完全避免 DLL 锁定问题
- ✅ MD5 校验确保完整性
- ✅ 自动备份旧版本
- ✅ 失败后可手动回滚
- ✅ 无缝重启应用

---

### 5. 合约API集成 ⭐⭐⭐

#### 新增功能

**量比排行 TOP20**：
- 从合约 API 获取流通量信息
- 计算量比：`24H成交额 / 流通市值`
- 流通市值：`流通数量 × 币价`

**配置优化**：

```csharp
// 统一使用 LicenseServerUrl
services.AddSingleton<ContractInfoService>(sp =>
{
    var logger = sp.GetRequiredService<ILogger<ContractInfoService>>();
    
    // 优先使用 ContractApiServerUrl，未配置则使用 LicenseServerUrl
    var contractApiUrl = ConfigurationManager.AppSettings["ContractApiServerUrl"];
    var licenseServerUrl = ConfigurationManager.AppSettings["LicenseServerUrl"];
    
    if (string.IsNullOrWhiteSpace(contractApiUrl))
    {
        contractApiUrl = licenseServerUrl;
        Console.WriteLine($"🔍 使用 LicenseServerUrl: {contractApiUrl}");
    }
    
    return new ContractInfoService(logger, contractApiUrl);
});
```

---

### 6. 符号匹配修复 ⭐⭐⭐

#### 问题

API 返回的合约名称已经包含 `USDT` 后缀，但代码又重复添加：

```
API返回: BTCUSDT
代码处理: BTCUSDT + USDT = BTCUSDTUSDT ❌
Ticker:   BTCUSDT
结果:     无法匹配 ❌
```

#### 修复

```csharp
// ContractInfoService.cs

// 修改前
var symbol = contract.Name.ToUpper() + "USDT";  // 重复添加 ❌

// 修改后
var symbol = contract.Name.ToUpper();  // 直接使用 ✅

// 过滤无效符号
if (symbol.Contains("#") || symbol.Contains("!") || symbol.Contains("ERROR"))
{
    Console.WriteLine($"⏭️ 跳过无效合约: {contract.Name}");
    continue;
}
```

**效果**：
- ✅ 符号正确匹配
- ✅ 量比排行正常显示数据
- ✅ 过滤 Excel 错误值（如 `#VALUE!`）

---

## 📊 功能对比表

| 功能 | v1.0.0 (原版) | v2.3.3 (最新) | 改进程度 |
|------|--------------|--------------|---------|
| **配置管理** | 硬编码 | App.config 动态读取 | ⭐⭐⭐⭐⭐ |
| **版本管理** | 程序集版本 | 配置文件版本 + 自动更新 | ⭐⭐⭐⭐ |
| **注册码持久化** | 仅 App.config | AppData + App.config 双重存储 | ⭐⭐⭐⭐⭐ |
| **数据保护** | 无 | 自动保护配置和数据文件 | ⭐⭐⭐⭐⭐ |
| **更新机制** | 主程序内更新 | 外部脚本智能更新 | ⭐⭐⭐⭐ |
| **DLL 锁定** | 存在问题 | 完全解决 | ⭐⭐⭐⭐⭐ |
| **量比功能** | 无 | 已集成 | ⭐⭐⭐ |
| **配置统一性** | 分散多处 | 统一管理 | ⭐⭐⭐⭐⭐ |
| **错误处理** | 简单提示 | 详细日志 + 友好提示 | ⭐⭐⭐⭐ |
| **向后兼容** | N/A | 完全兼容 | ⭐⭐⭐⭐⭐ |

---

## 🚀 升级指南

### 从 v1.0.x 升级到 v2.3.3

#### 步骤1：更新配置文件

修改 `App.config`：

```xml
<!-- 添加或修改以下配置 -->
<add key="LicenseServerUrl" value="http://your-server:8080" />
<add key="CurrentAppVersion" value="2.3.3" />

<!-- 可选：如果合约API服务器不同 -->
<!-- <add key="ContractApiServerUrl" value="http://another-server:8080" /> -->
```

#### 步骤2：更新项目文件

确保 `.csproj` 文件中版本号正确：

```xml
<Version>2.3.3</Version>
<AssemblyVersion>2.3.3.0</AssemblyVersion>
<FileVersion>2.3.3.0</FileVersion>
```

#### 步骤3：重新编译和发布

```powershell
# 清理
dotnet clean

# 编译
dotnet build -c Release

# 发布
dotnet publish -c Release -o publish
```

#### 步骤4：打包并上传

```powershell
# 打包为 ZIP
Compress-Archive -Path publish\* -DestinationPath YourApp_v2.3.3.zip

# 上传到服务器管理后台
```

#### 步骤5：测试更新

1. 客户端点击"检查更新"
2. 确认更新对话框显示正确
3. 执行更新
4. 验证版本号已更新
5. 验证注册码未丢失

---

## ⚠️ 重要提示

### 配置迁移

如果您的旧版本有以下情况，需要注意：

1. **硬编码服务器地址**
   - 检查所有代码中的服务器地址
   - 全部改为从 `App.config` 读取

2. **注册码存储位置**
   - 确保同时保存到 AppData 和 App.config
   - 启动时从 AppData 恢复

3. **版本号管理**
   - 在 `App.config` 中添加 `CurrentAppVersion`
   - 更新后调用 `SaveCurrentVersion()`

### 测试检查清单

- [ ] 服务器地址配置正确
- [ ] 许可证验证正常
- [ ] 检查更新功能正常
- [ ] 更新下载和安装正常
- [ ] 更新后版本号正确
- [ ] 更新后注册码未丢失
- [ ] 量比排行显示正常（如使用）
- [ ] 所有配置从 `App.config` 读取
- [ ] 日志输出清晰详细

---

## 📚 相关文档

- **快速入门**: `快速入门 - 许可证和自动更新集成.md` (v2.0)
- **详细说明**: `BinanceApps自动更新集成说明.md` (v2.0)
- **配置管理**: `统一使用LicenseServerUrl配置说明.md`
- **完整指南**: `WPF应用集成许可证验证和自动更新指南.md`

---

## 🎉 总结

### 关键改进

1. **配置管理现代化** - 从硬编码到配置文件
2. **数据保护机制** - 双重存储确保数据安全
3. **智能更新系统** - 外部脚本避免文件锁定
4. **统一配置方案** - 一个地址管理所有功能
5. **向后兼容** - 平滑升级，无破坏性变更

### 用户体验提升

- ✅ 修改配置无需重新编译
- ✅ 更新后注册码不丢失
- ✅ 更新流程更稳定可靠
- ✅ 版本管理更清晰
- ✅ 错误提示更友好

### 开发体验提升

- ✅ 配置集中管理
- ✅ 代码结构更清晰
- ✅ 调试日志更详细
- ✅ 易于维护和扩展

---

**文档版本**: 1.0  
**发布日期**: 2025-10-03  
**适用版本**: BinanceApps v2.3.3  
**作者**: AI Assistant  
**状态**: ✅ 已完成并测试

