# BinanceApps 更新包制作指南

## 📦 更新包基本要求

### 核心原则
**更新包的内部目录结构必须与应用程序的安装目录结构完全一致**

RegisterSrv.AutoUpdate 会将 ZIP 包内的文件**按原有结构**解压并覆盖到应用程序目录。

## 🏗️ 应用程序目录结构

BinanceApps 的典型发布目录结构如下：

```
BinanceApps.WPF/
├── BinanceApps.WPF.exe           # 主程序
├── BinanceApps.WPF.dll
├── BinanceApps.Core.dll          # 依赖库
├── BinanceApps.Trading.dll
├── BinanceApps.Account.dll
├── BinanceApps.MarketData.dll
├── BinanceApps.Storage.dll
├── RegisterSrv.ClientSDK.dll
├── RegisterSrv.AutoUpdate.dll    # 自动更新库
├── Newtonsoft.Json.dll
├── Microsoft.Extensions.*.dll    # 其他依赖
├── appsettings.json              # 配置文件
├── App.config
├── favicon.ico
├── Data/                         # 子文件夹
│   └── ...
├── KlineData/                    # 子文件夹
│   └── ...
└── ... 其他文件和文件夹
```

## 🔨 更新包制作步骤

### 方法 1：完整更新包（推荐）

#### 步骤 1：发布应用程序

```bash
# 导航到项目目录
cd D:\CSharpProjects\BinanceAppsClient\src\BinanceApps.WPF

# 发布应用程序（Release 模式）
dotnet publish -c Release -r win-x64 --self-contained false -o .\publish
```

**说明：**
- `-c Release`：使用 Release 配置
- `-r win-x64`：目标平台为 Windows x64
- `--self-contained false`：不包含 .NET 运行时（依赖系统安装的 .NET）
- `-o .\publish`：输出到 publish 文件夹

#### 步骤 2：检查发布目录

查看 `publish` 文件夹，确认包含：
- ✅ 所有 .exe 和 .dll 文件
- ✅ 所有配置文件（.json, .config）
- ✅ 所有资源文件（图标、图片等）
- ✅ 所有子文件夹及其内容

#### 步骤 3：制作 ZIP 包

**重要：ZIP 包的根目录应该直接是文件，不要有额外的父文件夹**

##### 方法 A：使用 Windows 资源管理器

1. 打开 `publish` 文件夹
2. **选择文件夹内的所有内容**（不是选择 publish 文件夹本身）
3. 右键 → **发送到** → **压缩(zipped)文件夹**
4. 重命名为 `BinanceApps_v1.0.1.zip`（根据版本号命名）

##### 方法 B：使用 PowerShell

```powershell
# 导航到 publish 父目录
cd D:\CSharpProjects\BinanceAppsClient\src\BinanceApps.WPF

# 压缩 publish 目录的内容（不包含 publish 文件夹本身）
Compress-Archive -Path ".\publish\*" -DestinationPath ".\BinanceApps_v1.0.1.zip" -Force
```

##### 方法 C：使用 7-Zip（推荐，压缩率更高）

```bash
# 确保安装了 7-Zip
cd D:\CSharpProjects\BinanceAppsClient\src\BinanceApps.WPF\publish

# 压缩当前目录的所有内容
7z a ..\BinanceApps_v1.0.1.zip *
```

#### 步骤 4：验证 ZIP 包结构

**打开 ZIP 包，确认结构正确：**

✅ **正确的结构**（ZIP 根目录直接是文件）：
```
BinanceApps_v1.0.1.zip
├── BinanceApps.WPF.exe
├── BinanceApps.WPF.dll
├── appsettings.json
├── Data/
│   └── ...
└── KlineData/
    └── ...
```

❌ **错误的结构**（多了一层文件夹）：
```
BinanceApps_v1.0.1.zip
└── publish/                    ← ❌ 不应该有这一层
    ├── BinanceApps.WPF.exe
    ├── BinanceApps.WPF.dll
    └── ...
```

如果结构错误，会导致更新后文件放在错误的位置！

---

### 方法 2：增量更新包（仅更新变化的文件）

如果只修改了部分文件，可以只打包变化的文件以减小更新包大小。

#### 适用场景
- 修复 Bug（只更新了几个 DLL）
- 配置文件更新
- 资源文件更新

#### 制作步骤

1. **确定需要更新的文件**，例如：
   ```
   BinanceApps.WPF.exe
   BinanceApps.Core.dll
   appsettings.json
   ```

2. **创建临时文件夹并复制文件**：
   ```powershell
   # 创建临时文件夹
   mkdir update-temp
   
   # 复制需要更新的文件（保持目录结构）
   copy .\publish\BinanceApps.WPF.exe .\update-temp\
   copy .\publish\BinanceApps.Core.dll .\update-temp\
   copy .\publish\appsettings.json .\update-temp\
   
   # 如果有子文件夹中的文件，也要保持结构
   mkdir .\update-temp\Data
   copy .\publish\Data\*.* .\update-temp\Data\
   ```

3. **压缩临时文件夹的内容**：
   ```powershell
   Compress-Archive -Path ".\update-temp\*" -DestinationPath ".\BinanceApps_v1.0.1_patch.zip" -Force
   ```

4. **验证 ZIP 包结构**（同上）

5. **清理临时文件夹**：
   ```powershell
   Remove-Item .\update-temp -Recurse -Force
   ```

---

## 📤 上传到服务器

### 步骤 1：访问服务器管理界面

浏览器打开：`http://192.168.1.101:8080`

### 步骤 2：注册应用程序（首次）

1. 导航到"应用程序管理"
2. 点击"添加应用程序"
3. 填写信息：
   - **应用程序 ID**：`App_20250928132921`（与 App.config 中的 ApplicationId 一致）
   - **应用程序名称**：`BinanceApps`
   - **描述**：币安自动化交易应用

### 步骤 3：上传版本

1. 导航到"版本管理"
2. 选择应用程序：`BinanceApps`
3. 点击"上传新版本"
4. 填写版本信息：
   - **版本号**：`1.0.1`（必须大于当前版本 1.0.0）
   - **更新说明**：
     ```
     【新功能】
     - 添加了自动更新功能
     - 优化了界面性能
     
     【Bug 修复】
     - 修复了数据加载问题
     ```
   - **是否强制更新**：根据需要勾选
5. **选择 ZIP 文件**：选择刚才制作的 `BinanceApps_v1.0.1.zip`
6. 点击"上传"

### 步骤 4：验证上传

- 上传成功后，服务器会自动计算 MD5 值
- 确认版本列表中显示新版本
- 检查文件大小是否正确

---

## 🧪 测试更新

### 测试前准备

1. **确认当前版本**：应用程序当前版本为 1.0.0
2. **确认服务器上有新版本**：1.0.1 或更高

### 测试步骤

#### 测试 1：启动时自动检查

1. 启动 BinanceApps 应用程序
2. 观察控制台输出：
   ```
   ✅ 自动更新管理器已初始化 (版本: 1.0.0)
   ✅ 许可证验证成功，检查更新...
   ```
3. 如果有新版本，会弹出更新对话框
4. 点击"立即更新"
5. 观察下载进度和安装过程
6. 等待应用重启
7. 验证版本已更新到 1.0.1

#### 测试 2：手动检查更新

1. 启动应用程序
2. 点击菜单：**帮助** → **检查更新**
3. 查看更新对话框
4. 执行更新流程（同上）

---

## ❗ 常见问题

### 问题 1：更新后文件在错误的位置

**原因**：ZIP 包结构不正确，多了一层文件夹

**解决**：重新制作 ZIP 包，确保 ZIP 根目录直接是文件，参考上面的"验证 ZIP 包结构"

### 问题 2：更新后应用无法启动

**可能原因**：
1. 缺少必要的 DLL 文件
2. 配置文件损坏
3. 主程序文件损坏

**解决**：
1. 使用完整更新包（不要使用增量包）
2. 检查 ZIP 包是否包含所有必要文件
3. 验证发布目录的完整性

### 问题 3：子文件夹没有更新

**原因**：ZIP 包中没有包含子文件夹或结构不正确

**解决**：
1. 确保压缩时使用递归模式（`-r` 参数或选择"包含子文件夹"）
2. 检查 ZIP 包是否包含子文件夹
3. 验证子文件夹的路径是否正确

### 问题 4：配置文件被覆盖了

**说明**：更新包会**覆盖**所有同名文件，包括配置文件

**解决方案**：

#### 方案 A：不更新配置文件
如果用户的配置文件可能被修改过，更新包中不要包含配置文件：
```powershell
# 制作更新包时，排除配置文件
Compress-Archive -Path ".\publish\*" -DestinationPath ".\update.zip" -Exclude "appsettings.json","App.config"
```

#### 方案 B：使用配置迁移
在代码中添加配置迁移逻辑，更新后自动合并配置。

#### 方案 C：备份和恢复
更新前自动备份配置文件，更新后恢复。

---

## 📝 最佳实践

### ✅ 推荐做法

1. **使用完整更新包**：避免遗漏文件
2. **验证 ZIP 结构**：每次制作完都检查一遍
3. **测试更新流程**：在测试环境先验证
4. **写清楚更新说明**：让用户知道更新了什么
5. **版本号递增**：严格按照语义化版本号管理
6. **保留历史版本**：服务器上保留至少最近 3 个版本

### ❌ 避免做法

1. ❌ ZIP 包包含多余的父文件夹
2. ❌ 更新包缺少必要的依赖文件
3. ❌ 版本号不连续或重复
4. ❌ 没有写更新说明
5. ❌ 没有在测试环境验证就直接发布

---

## 🔄 版本发布流程（完整）

### 1. 开发阶段
- 修改代码
- 更新版本号（`BinanceApps.WPF.csproj`）
- 更新 CHANGELOG

### 2. 构建阶段
```powershell
# 清理旧的发布文件
Remove-Item .\publish -Recurse -Force -ErrorAction SilentlyContinue

# 发布应用程序
dotnet publish -c Release -r win-x64 --self-contained false -o .\publish

# 测试发布版本
.\publish\BinanceApps.WPF.exe
```

### 3. 打包阶段
```powershell
# 制作 ZIP 包
Compress-Archive -Path ".\publish\*" -DestinationPath ".\BinanceApps_v1.0.1.zip" -Force

# 验证 ZIP 包
Expand-Archive -Path ".\BinanceApps_v1.0.1.zip" -DestinationPath ".\verify-temp"
# 检查 verify-temp 目录结构
Remove-Item .\verify-temp -Recurse -Force
```

### 4. 上传阶段
- 登录服务器管理界面
- 上传 ZIP 包
- 填写版本信息和更新说明
- 设置强制更新（如有需要）

### 5. 测试阶段
- 启动旧版本应用程序
- 验证自动更新提示
- 执行更新流程
- 验证新版本功能

### 6. 发布阶段
- 通知用户有新版本可用
- 监控更新失败的反馈
- 准备回滚方案（保留旧版本）

---

## 🛠️ 实用脚本

### PowerShell 自动化脚本

保存为 `build-and-pack.ps1`：

```powershell
# BinanceApps 构建和打包脚本

param(
    [Parameter(Mandatory=$true)]
    [string]$Version  # 例如：1.0.1
)

# 配置
$ProjectDir = "D:\CSharpProjects\BinanceAppsClient\src\BinanceApps.WPF"
$PublishDir = "$ProjectDir\publish"
$OutputZip = "$ProjectDir\BinanceApps_v$Version.zip"

# 步骤 1：清理旧文件
Write-Host "🧹 清理旧文件..." -ForegroundColor Yellow
Remove-Item $PublishDir -Recurse -Force -ErrorAction SilentlyContinue
Remove-Item $OutputZip -Force -ErrorAction SilentlyContinue

# 步骤 2：发布应用程序
Write-Host "🔨 构建应用程序..." -ForegroundColor Yellow
cd $ProjectDir
dotnet publish -c Release -r win-x64 --self-contained false -o $PublishDir

if ($LASTEXITCODE -ne 0) {
    Write-Host "❌ 构建失败" -ForegroundColor Red
    exit 1
}

# 步骤 3：制作 ZIP 包
Write-Host "📦 制作更新包..." -ForegroundColor Yellow
Compress-Archive -Path "$PublishDir\*" -DestinationPath $OutputZip -Force

# 步骤 4：显示信息
$ZipSize = (Get-Item $OutputZip).Length / 1MB
Write-Host "✅ 更新包制作完成！" -ForegroundColor Green
Write-Host "📄 文件：$OutputZip"
Write-Host "📊 大小：$([math]::Round($ZipSize, 2)) MB"
Write-Host ""
Write-Host "📤 下一步：将 ZIP 包上传到服务器 http://192.168.1.101:8080"
```

**使用方法：**
```powershell
.\build-and-pack.ps1 -Version "1.0.1"
```

---

## 📞 需要帮助？

如果在制作更新包过程中遇到问题，请参考：
- **集成文档**：`BinanceApps自动更新集成说明.md`
- **原始指南**：`RegisterSrv.AutoUpdate 客户端集成指南.md`
- **项目地址**：https://github.com/registerSrv/RegisterSrv

---

**文档版本**：1.0  
**更新日期**：2025-09-30  
**适用版本**：RegisterSrv.AutoUpdate 1.0.0 