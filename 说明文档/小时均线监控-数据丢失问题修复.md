# å°æ—¶å‡çº¿ç›‘æ§ - æ•°æ®ä¸¢å¤±é—®é¢˜ä¿®å¤

## ğŸ“‹ é—®é¢˜æè¿°

**ç”¨æˆ·åé¦ˆ**ï¼šç‚¹å‡»"è®¡ç®—"æŒ‰é’®åï¼ŒEMAã€è·ç¦»ç­‰åŸæœ¬å·²ç»è®¡ç®—å¥½çš„æ•°æ®å˜æˆäº†0ï¼Œæ•°æ®ä¸¢å¤±ã€‚

## ğŸ” é—®é¢˜åŸå› 

åœ¨åˆå§‹å®ç°ä¸­ï¼Œæˆ‘ä½¿ç”¨äº†ä¸€ä¸ª**ä¸åˆç†çš„æ•°æ®å­˜å‚¨æ–¹æ¡ˆ**ï¼š

```csharp
// âŒ é”™è¯¯çš„åšæ³•ï¼šä½¿ç”¨ç‰¹æ®Šé”®åœ¨EmaValueså­—å…¸ä¸­å­˜å‚¨è®¡æ•°
_cachedData[symbol].EmaValues[DateTime.MinValue] = aboveCount;
_cachedData[symbol].EmaValues[DateTime.MinValue.AddSeconds(1)] = belowCount;
```

è¿™ç§åšæ³•å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š
1. **æ··æ·†æ•°æ®ç±»å‹**ï¼š`EmaValues`æ˜¯`Dictionary<DateTime, decimal>`ç±»å‹ï¼Œç”¨äºå­˜å‚¨æ—¶é—´åˆ°EMAå€¼çš„æ˜ å°„ï¼Œä½†æˆ‘å´ç”¨ç‰¹æ®Šçš„`DateTime.MinValue`é”®æ¥å­˜å‚¨æ•´æ•°è®¡æ•°
2. **æ•°æ®å¹²æ‰°**ï¼šä½¿ç”¨ç‰¹æ®Šé”®å¯èƒ½å¹²æ‰°æ­£å¸¸çš„EMAæ•°æ®è¯»å–ï¼Œå¯¼è‡´`.Values.Last()`ç­‰æ“ä½œè¿”å›é”™è¯¯çš„å€¼
3. **è¯­ä¹‰ä¸æ¸…æ™°**ï¼šä»£ç å¯è¯»æ€§å·®ï¼Œå…¶ä»–å¼€å‘è€…å¾ˆéš¾ç†è§£è¿™ç§hackæ‰‹æ®µ

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. æ›´æ–°æ•°æ®æ¨¡å‹

åœ¨`HourlyKlineData`ç±»ä¸­æ·»åŠ ä¸“ç”¨å­—æ®µï¼š

```csharp
public class HourlyKlineData
{
    public string Symbol { get; set; } = string.Empty;
    public List<Kline> Klines { get; set; } = new List<Kline>();
    public Dictionary<DateTime, decimal> EmaValues { get; set; } = new Dictionary<DateTime, decimal>();
    
    // âœ… æ–°å¢ï¼šä¸“ç”¨å­—æ®µå­˜å‚¨è¿ç»­æ•°é‡
    public int AboveEmaCount { get; set; }
    public int BelowEmaCount { get; set; }
    
    public DateTime LastUpdateTime { get; set; } = DateTime.Now;
}
```

### 2. æ›´æ–°è®¡ç®—é€»è¾‘

åœ¨`CalculateAboveBelowEmaCountsAsync`æ–¹æ³•ä¸­ï¼š

```csharp
// âœ… æ­£ç¡®çš„åšæ³•ï¼šç›´æ¥å­˜å‚¨åœ¨ä¸“ç”¨å­—æ®µä¸­
lock (_cacheLock)
{
    if (_cachedData.ContainsKey(symbol))
    {
        _cachedData[symbol].AboveEmaCount = aboveCount;
        _cachedData[symbol].BelowEmaCount = belowCount;
    }
}
```

### 3. æ›´æ–°è¯»å–é€»è¾‘

åœ¨`GetMonitorResultsAsync`æ–¹æ³•ä¸­ï¼š

```csharp
var result = new HourlyEmaMonitorResult
{
    Symbol = symbol,
    LastPrice = ticker.LastPrice,
    CurrentEma = latestEma,
    DistancePercent = distancePercent,
    PriceChangePercent = ticker.PriceChangePercent,
    KlineCount = klineData.Klines.Count,
    
    // âœ… ä»ä¸“ç”¨å­—æ®µè¯»å–
    AboveEmaCount = klineData.AboveEmaCount,
    BelowEmaCount = klineData.BelowEmaCount,
    
    UpdateTime = DateTime.Now
};
```

---

## ğŸ“Š ä¿®æ”¹å¯¹æ¯”

### ä¿®æ”¹å‰ï¼ˆé”™è¯¯ï¼‰

```csharp
// å­˜å‚¨
_cachedData[symbol].EmaValues[DateTime.MinValue] = aboveCount;
_cachedData[symbol].EmaValues[DateTime.MinValue.AddSeconds(1)] = belowCount;

// è¯»å–
var aboveCount = klineData.EmaValues.ContainsKey(DateTime.MinValue) 
    ? (int)klineData.EmaValues[DateTime.MinValue] : 0;
var belowCount = klineData.EmaValues.ContainsKey(DateTime.MinValue.AddSeconds(1)) 
    ? (int)klineData.EmaValues[DateTime.MinValue.AddSeconds(1)] : 0;
```

### ä¿®æ”¹åï¼ˆæ­£ç¡®ï¼‰

```csharp
// å­˜å‚¨
_cachedData[symbol].AboveEmaCount = aboveCount;
_cachedData[symbol].BelowEmaCount = belowCount;

// è¯»å–
AboveEmaCount = klineData.AboveEmaCount,
BelowEmaCount = klineData.BelowEmaCount,
```

---

## ğŸ¯ ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰
- âŒ EMAæ•°æ®å¯èƒ½è¢«è¦†ç›–æˆ–å¹²æ‰°
- âŒ è·ç¦»ç™¾åˆ†æ¯”è®¡ç®—é”™è¯¯
- âŒ æ•°æ®æ˜¾ç¤ºä¸º0

### ä¿®å¤å
- âœ… EMAæ•°æ®ä¿æŒå®Œæ•´
- âœ… è·ç¦»ç™¾åˆ†æ¯”è®¡ç®—æ­£ç¡®
- âœ… æ‰€æœ‰æ•°æ®æ­£å¸¸æ˜¾ç¤º

---

## ğŸ“ ä¿®æ”¹æ–‡ä»¶

### 1. src/BinanceApps.Core/Models/HourlyEmaModels.cs

**ä¿®æ”¹å†…å®¹**ï¼šåœ¨`HourlyKlineData`ç±»ä¸­æ·»åŠ ä¸¤ä¸ªå­—æ®µ

```csharp
/// <summary>
/// è¿ç»­å¤§äºEMAçš„Kçº¿æ•°é‡
/// </summary>
public int AboveEmaCount { get; set; }

/// <summary>
/// è¿ç»­å°äºEMAçš„Kçº¿æ•°é‡
/// </summary>
public int BelowEmaCount { get; set; }
```

### 2. src/BinanceApps.Core/Services/HourlyEmaService.cs

**ä¿®æ”¹å†…å®¹**ï¼š

#### ä¿®æ”¹ç‚¹1ï¼šå­˜å‚¨é€»è¾‘
```csharp
// ä½ç½®ï¼šCalculateAboveBelowEmaCountsAsync æ–¹æ³•
lock (_cacheLock)
{
    if (_cachedData.ContainsKey(symbol))
    {
        // å°†è®¡æ•°å­˜å‚¨åœ¨ä¸“ç”¨å­—æ®µä¸­
        _cachedData[symbol].AboveEmaCount = aboveCount;
        _cachedData[symbol].BelowEmaCount = belowCount;
    }
}
```

#### ä¿®æ”¹ç‚¹2ï¼šè¯»å–é€»è¾‘
```csharp
// ä½ç½®ï¼šGetMonitorResultsAsync æ–¹æ³•
var result = new HourlyEmaMonitorResult
{
    // ... å…¶ä»–å­—æ®µ ...
    AboveEmaCount = klineData.AboveEmaCount,
    BelowEmaCount = klineData.BelowEmaCount,
    // ...
};
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•æ­¥éª¤

1. **è·å–Kçº¿æ•°æ®**
   ```
   ç‚¹å‡»"ğŸ“¥ è·å–å°æ—¶Kçº¿"
   â†’ ç­‰å¾…å®Œæˆ
   â†’ éªŒè¯EMAå’Œè·ç¦»æ•°æ®æ­£å¸¸æ˜¾ç¤º
   ```

2. **ç‚¹å‡»è®¡ç®—**
   ```
   ç‚¹å‡»"ğŸ”¢ è®¡ç®—"
   â†’ ç­‰å¾…å®Œæˆ
   â†’ éªŒè¯EMAå’Œè·ç¦»æ•°æ®ä»ç„¶æ­£å¸¸
   â†’ éªŒè¯å¤§äº/å°äºEMAæ•°é‡æ­£ç¡®æ˜¾ç¤º
   ```

3. **ç­›é€‰åŠŸèƒ½**
   ```
   è¾“å…¥ç­›é€‰æ¡ä»¶
   â†’ ç‚¹å‡»"ğŸ” ç­›é€‰"
   â†’ éªŒè¯æ‰€æœ‰åˆ—çš„æ•°æ®éƒ½å®Œæ•´
   ```

### é¢„æœŸç»“æœ

| åˆ—å | æ•°æ®çŠ¶æ€ |
|------|---------|
| åˆçº¦å | âœ… æ­£å¸¸ |
| æœ€æ–°ä»·æ ¼ | âœ… æ­£å¸¸ |
| å½“å‰EMA | âœ… æ­£å¸¸ï¼ˆä¸å†æ˜¯0ï¼‰ |
| è·ç¦»EMA(%) | âœ… æ­£å¸¸ï¼ˆæ­£ç¡®è®¡ç®—ï¼‰ |
| å¤§äºEMAæ•°é‡ | âœ… æ­£å¸¸ |
| å°äºEMAæ•°é‡ | âœ… æ­£å¸¸ |
| 24Hæ¶¨å¹…(%) | âœ… æ­£å¸¸ |
| Kçº¿æ•°é‡ | âœ… æ­£å¸¸ |
| æ›´æ–°æ—¶é—´ | âœ… æ­£å¸¸ |

---

## ğŸ’¡ ç»éªŒæ€»ç»“

### è®¾è®¡åŸåˆ™

1. **ç±»å‹å®‰å…¨**ï¼šä½¿ç”¨æ­£ç¡®çš„ç±»å‹å­˜å‚¨æ•°æ®ï¼Œé¿å…ç±»å‹è½¬æ¢hack
2. **è¯­ä¹‰æ¸…æ™°**ï¼šå­—æ®µåç§°åº”è¯¥ç›´æ¥åæ˜ å…¶ç”¨é€”
3. **æ•°æ®éš”ç¦»**ï¼šä¸åŒç±»å‹çš„æ•°æ®åº”è¯¥å­˜å‚¨åœ¨ä¸åŒçš„å­—æ®µ/é›†åˆä¸­
4. **å¯ç»´æŠ¤æ€§**ï¼šä»£ç åº”è¯¥æ˜“äºç†è§£å’Œç»´æŠ¤

### ä»£ç å®¡æŸ¥è¦ç‚¹

- âŒ **åæ¨¡å¼**ï¼šä½¿ç”¨ç‰¹æ®Šé”®ï¼ˆå¦‚`DateTime.MinValue`ï¼‰å­˜å‚¨éæ—¶é—´æ•°æ®
- âŒ **åæ¨¡å¼**ï¼šåœ¨ä¸€ä¸ªé›†åˆä¸­æ··åˆå­˜å‚¨ä¸åŒç±»å‹çš„æ•°æ®
- âœ… **æœ€ä½³å®è·µ**ï¼šä¸ºæ¯ç§æ•°æ®ç±»å‹æä¾›ä¸“ç”¨çš„å­—æ®µæˆ–å±æ€§
- âœ… **æœ€ä½³å®è·µ**ï¼šä½¿ç”¨å¼ºç±»å‹ï¼Œé¿å…ç±»å‹è½¬æ¢

---

## ğŸ”„ å‡çº§æ­¥éª¤

å¦‚æœæ‚¨çš„æœ¬åœ°æœ‰æ—§ç‰ˆæœ¬çš„ç¼“å­˜æ•°æ®ï¼š

1. **æ¸…é™¤ç¼“å­˜**
   ```
   ç‚¹å‡»"ğŸ—‘ï¸ æ¸…é™¤ç¼“å­˜"æŒ‰é’®
   ```

2. **é‡æ–°è·å–æ•°æ®**
   ```
   ç‚¹å‡»"ğŸ“¥ è·å–å°æ—¶Kçº¿"
   ```

3. **è®¡ç®—è¿ç»­æ•°é‡**
   ```
   ç‚¹å‡»"ğŸ”¢ è®¡ç®—"
   ```

---

## âœ… ä¿®å¤çŠ¶æ€

- [x] é—®é¢˜å·²è¯†åˆ«
- [x] æ•°æ®æ¨¡å‹å·²æ›´æ–°
- [x] å­˜å‚¨é€»è¾‘å·²ä¿®å¤
- [x] è¯»å–é€»è¾‘å·²ä¿®å¤
- [x] ä»£ç ç¼–è¯‘é€šè¿‡
- [x] æ–‡æ¡£å·²æ›´æ–°

---

## ğŸ“… ç‰ˆæœ¬ä¿¡æ¯

- **é—®é¢˜å‘ç°æ—¥æœŸ**ï¼š2025-11-06
- **ä¿®å¤å®Œæˆæ—¥æœŸ**ï¼š2025-11-06
- **å½±å“ç‰ˆæœ¬**ï¼šv2.0ï¼ˆåˆå§‹ç‰ˆæœ¬ï¼‰
- **ä¿®å¤ç‰ˆæœ¬**ï¼šv2.0.1

---

## ğŸ“ åç»­æ”¯æŒ

å¦‚ä¿®å¤åä»æœ‰é—®é¢˜ï¼Œè¯·ï¼š
1. æ¸…é™¤ç¼“å­˜
2. é‡æ–°è·å–Kçº¿æ•°æ®
3. é‡æ–°è®¡ç®—
4. æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—
5. åé¦ˆé—®é¢˜

---

**é—®é¢˜å·²ä¿®å¤** âœ…

