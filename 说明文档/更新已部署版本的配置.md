# 更新已部署版本的配置

## 🔍 问题分析

### 发现的问题

**日志显示**：
```
主程序配置文件路径: D:\Apps\SearchCoins\appsettings.json
基础目录: D:\Apps\SearchCoins\
🌐 API地址: http://localhost:8080/api/contract
```

**问题原因**：
1. 您运行的是 **`D:\Apps\SearchCoins\`** 目录下的已部署版本
2. 该版本使用的是**旧代码编译的**，可能还没有从 `App.config` 读取配置的逻辑
3. 我们刚才编译的新版本在 `src\BinanceApps.WPF\bin\Release\net9.0-windows\`

## ✅ 解决方案

### 方案1：手动更新已部署目录的配置文件（快速）

#### 步骤1：找到配置文件

在 `D:\Apps\SearchCoins\` 目录下查找：
- `BinanceApps.WPF.dll.config` 
- 或 `App.config`

#### 步骤2：编辑配置文件

用记事本打开配置文件，找到：
```xml
<add key="ContractApiServerUrl" value="http://localhost:8080" />
```

修改为：
```xml
<add key="ContractApiServerUrl" value="http://38.181.35.75:8080" />
```

#### 步骤3：保存并重启程序

保存文件后，重新启动程序。

**⚠️ 注意**：这个方法只是临时解决，如果重新部署程序，需要重新修改。

---

### 方案2：重新发布最新版本到已部署目录（推荐）

#### 步骤1：发布最新版本

```powershell
# 发布到临时目录
dotnet publish src/BinanceApps.WPF/BinanceApps.WPF.csproj -c Release -o publish
```

#### 步骤2：停止运行的程序

确保 `D:\Apps\SearchCoins\` 目录下的程序已关闭。

#### 步骤3：备份旧版本

```powershell
# 创建备份
Copy-Item -Path "D:\Apps\SearchCoins" -Destination "D:\Apps\SearchCoins_backup_$(Get-Date -Format 'yyyyMMdd_HHmmss')" -Recurse
```

#### 步骤4：复制新版本

```powershell
# 复制新文件（不覆盖配置和数据文件）
Copy-Item -Path "publish\*" -Destination "D:\Apps\SearchCoins\" -Recurse -Force -Exclude "*.db","*.log","*.dat","App.config"
```

#### 步骤5：确保配置文件正确

检查 `D:\Apps\SearchCoins\BinanceApps.WPF.dll.config` 内容：
```xml
<add key="LicenseServerUrl" value="http://38.181.35.75:8080" />
<add key="ContractApiServerUrl" value="http://38.181.35.75:8080" />
```

#### 步骤6：重新启动程序

从 `D:\Apps\SearchCoins\` 目录启动程序。

---

### 方案3：创建自动部署脚本（最佳实践）

我来创建一个自动部署脚本，它会：
1. 编译最新版本
2. 发布到临时目录
3. 备份旧版本
4. 更新到已部署目录
5. 保护配置和数据文件

请告诉我您是否需要这个脚本。

---

## 🎯 验证步骤

### 方法1：检查配置文件

```powershell
# 查看已部署目录的配置文件
type "D:\Apps\SearchCoins\BinanceApps.WPF.dll.config" | findstr ContractApiServerUrl
```

**应该看到**：
```xml
<add key="ContractApiServerUrl" value="http://38.181.35.75:8080" />
```

### 方法2：运行程序查看日志

重新启动程序，查看启动日志：

**修复前（错误）**：
```
🌐 API地址: http://localhost:8080/api/contract
```

**修复后（正确）**：
```
🔍 读取配置: ContractApiServerUrl = http://38.181.35.75:8080
✅ 使用配置的合约API地址: http://38.181.35.75:8080
🌐 API地址: http://38.181.35.75:8080/api/contract
📡 HTTP响应状态: OK
✅ 成功加载 203 个合约信息到缓存
```

---

## 📋 关键配置项说明

### 1. LicenseServerUrl（许可证服务器）

```xml
<add key="LicenseServerUrl" value="http://38.181.35.75:8080" />
```

**用途**：
- 验证注册码
- 检查更新

### 2. ContractApiServerUrl（合约API服务器）

```xml
<add key="ContractApiServerUrl" value="http://38.181.35.75:8080" />
```

**用途**：
- 获取合约流通量信息
- 计算量比排行

### 建议：统一使用同一个服务器

如果许可证服务器和合约API服务器是同一个，建议配置为相同的地址。

---

## 🛠️ 代码层面的统一（已完成）

### 当前状态

✅ **LicenseServerUrl** - 已从 `App.config` 动态读取  
**位置**：`src/BinanceApps.WPF/App.xaml.cs`

✅ **ContractApiServerUrl** - 已从 `App.config` 动态读取  
**位置**：`src/BinanceApps.WPF/MainWindow.xaml.cs`

### 确认无硬编码

已检查所有代码，确认：
- ❌ 无硬编码的 `localhost:8080`
- ❌ 无硬编码的固定IP地址
- ✅ 所有服务器地址都从 `App.config` 读取
- ✅ 提供了默认值（`localhost:8080`）以防配置缺失

---

## 💡 为什么需要重新部署？

### 旧版本的问题

1. **可能缺少配置读取逻辑**
   - 旧代码可能直接使用硬编码的 `localhost:8080`
   - 或使用构造函数的默认参数

2. **可能缺少调试输出**
   - 无法看到 `🔍 读取配置: ContractApiServerUrl = ...`
   - 无法诊断配置是否被正确读取

3. **可能有其他已修复的bug**
   - 符号匹配问题
   - 双击复制功能
   - 版式优化

### 新版本的改进

1. ✅ 从 `App.config` 动态读取所有服务器地址
2. ✅ 详细的调试日志
3. ✅ 更好的错误处理
4. ✅ 所有最新的功能和修复

---

## 🎯 推荐流程

### 立即解决（临时）

1. 手动编辑 `D:\Apps\SearchCoins\BinanceApps.WPF.dll.config`
2. 修改 `ContractApiServerUrl` 为正确地址
3. 重启程序验证

### 长期方案（推荐）

1. 重新发布最新版本到 `D:\Apps\SearchCoins\`
2. 使用自动部署脚本（我可以帮您创建）
3. 确保配置文件始终正确

---

## 📝 常见问题

### Q1：为什么修改源代码目录的 App.config 没用？

**A**：因为您运行的是 `D:\Apps\SearchCoins\` 目录的程序，不是源代码编译输出目录的程序。

### Q2：每次更新都要手动改配置吗？

**A**：不需要。使用正确的部署流程，配置文件会被保护，不会被覆盖。

### Q3：如何确保以后不会有这个问题？

**A**：
1. 使用自动部署脚本
2. 配置文件统一管理
3. 更新时保护用户数据和配置

---

## 🚀 下一步

请告诉我您想使用哪个方案：

1. **方案1（快速）**：我告诉您如何手动修改配置文件
2. **方案2（推荐）**：我帮您创建自动部署脚本
3. **方案3（简单）**：您手动复制最新编译的文件到 `D:\Apps\SearchCoins\`

或者，您可以：
- 提供 `D:\Apps\SearchCoins\BinanceApps.WPF.dll.config` 的内容
- 我帮您确认需要修改哪些地方

