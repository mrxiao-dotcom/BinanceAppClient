# 📊 量比排行功能实现说明

## 🎯 功能概述

在综合信息仪表板中添加"量比最大前20"区域，用于分析市场热度。

### 核心概念
- **量比** = 24H成交额 / 流通市值
- **流通市值** = 流通数量 × 当前币价
- **数据来源**: 用户搭建的本地API服务器（http://localhost:8080）

## 📋 已完成的工作

### 1. ✅ 数据模型
**文件**: `src/BinanceApps.Core/Models/ContractInfo.cs`
- `ContractInfo`: 合约信息（名称、流通量、发行总量等）
- `ContractApiResponse`: API响应包装
- `ContractListApiResponse`: API列表响应包装

**文件**: `src/BinanceApps.Core/Models/DashboardModels.cs`
- `VolumeRatioItem`: 量比排行项目
- 在`DashboardSummary`中添加`VolumeRatioTop20`属性

### 2. ✅ 服务层
**文件**: `src/BinanceApps.Core/Services/ContractInfoService.cs`
- `LoadContractInfoAsync()`: 从API加载合约信息到缓存
- `GetCirculatingMarketCap()`: 计算流通市值
- `GetContractInfo()`: 获取单个合约信息
- 缓存机制：启动时加载一次，全局使用

**文件**: `src/BinanceApps.Core/Services/DashboardService.cs`
- `GetVolumeRatioTop20()`: 计算量比排行
- 过滤逻辑：
  - 只计算有流通市值数据的合约
  - 流通市值必须 > 0
  - 按量比降序排列，取前20

### 3. ✅ 应用集成
**文件**: `src/BinanceApps.WPF/MainWindow.xaml.cs`
- 注册`ContractInfoService`到DI容器
- 在`InitializeAsync`中加载合约信息缓存
- 启动时输出日志信息

## 🔧 API接口说明

### 基础 URL
```
http://localhost:8080/api/contract
```

### 获取所有合约
```http
GET /api/contract?includeDisabled=false
```

### 响应示例
```json
{
  "success": true,
  "data": [
    {
      "name": "BTC",
      "symbol": "Bitcoin",
      "totalSupply": 21000000,
      "circulatingSupply": 19000000,
      "decimals": 18
    }
  ]
}
```

## 📊 量比计算逻辑

```csharp
// 1. 获取流通市值
流通市值 = 流通数量 × 当前价格

// 2. 计算量比
量比 = 24H成交额 / 流通市值

// 3. 过滤条件
- 必须有流通市值数据
- 流通市值 > 0
- 按量比降序排序

// 4. 取TOP20
VolumeRatioTop20 = 排序后的前20个合约
```

## 🎨 待添加：UI显示

### 需要在 `DashboardWindow.xaml` 中添加：

```xml
<!-- 量比排行TOP20 -->
<Border Grid.Row="3" Grid.Column="0" Style="{StaticResource CardStyle}">
    <StackPanel>
        <TextBlock Text="📊 量比最大TOP20" Style="{StaticResource TitleStyle}" Margin="0,0,0,15"/>
        <TextBlock Text="量比 = 成交额/流通市值" FontSize="11" Foreground="#999" Margin="0,0,0,10"/>
        
        <ScrollViewer MaxHeight="300" VerticalScrollBarVisibility="Auto">
            <StackPanel x:Name="panelVolumeRatio"/>
        </ScrollViewer>
        
        <TextBlock x:Name="txtVolumeRatioUpdate" Text="🕒 更新: --:--:--" FontSize="12" 
                   Foreground="#999" HorizontalAlignment="Right" Margin="0,10,0,0"/>
    </StackPanel>
</Border>
```

### 需要在 `DashboardWindow.xaml.cs` 中添加：

```csharp
/// <summary>
/// 更新量比排行UI
/// </summary>
private void UpdateVolumeRatioUI(List<VolumeRatioItem> volumeRatioTop20, DateTime updateTime)
{
    panelVolumeRatio.Children.Clear();
    
    if (volumeRatioTop20 == null || volumeRatioTop20.Count == 0)
    {
        var noDataText = new TextBlock
        {
            Text = "暂无数据（需要加载合约流通量信息）",
            FontSize = 12,
            Foreground = new SolidColorBrush(Colors.Gray),
            FontStyle = FontStyles.Italic,
            Margin = new Thickness(0, 5, 0, 5)
        };
        panelVolumeRatio.Children.Add(noDataText);
        return;
    }
    
    int rank = 1;
    foreach (var item in volumeRatioTop20)
    {
        var itemPanel = new StackPanel
        {
            Orientation = Orientation.Horizontal,
            Margin = new Thickness(0, 3, 0, 3)
        };
        
        // 排名
        itemPanel.Children.Add(new TextBlock
        {
            Text = $"{rank}. ",
            FontSize = 11,
            Width = 25,
            Foreground = new SolidColorBrush(Color.FromRgb(100, 100, 100))
        });
        
        // 合约名称
        itemPanel.Children.Add(new TextBlock
        {
            Text = item.Symbol,
            FontSize = 11,
            Width = 100,
            FontWeight = FontWeights.SemiBold
        });
        
        // 量比
        itemPanel.Children.Add(new TextBlock
        {
            Text = item.VolumeRatioDisplay,
            FontSize = 11,
            Width = 80,
            Foreground = new SolidColorBrush(Color.FromRgb(0, 120, 212)),
            FontWeight = FontWeights.Bold
        });
        
        // 成交额
        itemPanel.Children.Add(new TextBlock
        {
            Text = $"成交: {item.QuoteVolumeDisplay}",
            FontSize= 10,
            Width = 100,
            Foreground = new SolidColorBrush(Color.FromRgb(100, 100, 100))
        });
        
        // 流通市值
        itemPanel.Children.Add(new TextBlock
        {
            Text = $"市值: {item.MarketCapDisplay}",
            FontSize = 10,
            Width = 100,
            Foreground = new SolidColorBrush(Color.FromRgb(100, 100, 100))
        });
        
        // 涨跌幅
        var changeColor = item.PriceChangePercent >= 0
            ? Color.FromRgb(0, 160, 0)
            : Color.FromRgb(220, 50, 50);
        itemPanel.Children.Add(new TextBlock
        {
            Text = $"{(item.PriceChangePercent >= 0 ? "+" : "")}{item.PriceChangePercent:F2}%",
            FontSize = 10,
            Foreground = new SolidColorBrush(changeColor)
        });
        
        panelVolumeRatio.Children.Add(itemPanel);
        rank++;
    }
    
    txtVolumeRatioUpdate.Text = $"🕒 更新: {updateTime:HH:mm:ss}";
}
```

### 在 `UpdateUI` 方法中调用：

```csharp
private void UpdateUI(DashboardSummary summary)
{
    // ... 现有代码 ...
    
    // 量比排行
    UpdateVolumeRatioUI(summary.VolumeRatioTop20, summary.UpdateTime);
}
```

## 📋 测试步骤

### 1. 启动本地API服务器
确保 `http://localhost:8080/api/contract` 可以访问

### 2. 编译应用
```cmd
双击运行：彻底清理并重建.cmd
```

### 3. 启动应用
查看日志输出：
```
📊 正在从本地API加载合约流通量信息...
✅ 成功加载 XXX 个合约信息到缓存
```

### 4. 打开仪表板
点击"📊 综合信息仪表板"，查看是否显示量比排行

### 5. 验证清单
- ✅ 应用启动时成功加载合约信息
- ✅ 仪表板显示量比排行TOP20
- ✅ 量比计算正确（成交额/流通市值）
- ✅ 排序正确（量比降序）
- ✅ 显示数据完整（合约、量比、成交额、市值、涨跌幅）

## ⚠️ 注意事项

### 1. API服务器配置
如果API服务器地址不是默认的 `localhost:8080`，需要修改：

**文件**: `src/BinanceApps.Core/Services/ContractInfoService.cs`
```csharp
public ContractInfoService(ILogger<ContractInfoService> logger, string baseUrl = "http://localhost:8080")
```

或在注册服务时指定：
```csharp
services.AddSingleton<ContractInfoService>(sp =>
{
    var logger = sp.GetRequiredService<ILogger<ContractInfoService>>();
    return new ContractInfoService(logger, "http://your-server:port");
});
```

### 2. 合约符号匹配
- API返回: `BTC`
- 系统使用: `BTCUSDT`
- 自动转换: `BTC` → `BTCUSDT`

### 3. 错误处理
- 如果API服务器未启动，应用仍可正常运行
- 量比功能将不可用，但不影响其他功能
- 会在日志中显示警告信息

### 4. 缓存机制
- 应用启动时加载一次
- 全局共享使用
- 如需刷新，需重启应用

## 🔄 后续优化建议

1. **定时刷新缓存**
   - 添加定时器，每小时刷新一次
   - 或提供手动刷新按钮

2. **API配置管理**
   - 将API地址配置到 `appsettings.json`
   - 支持在界面中修改

3. **错误重试机制**
   - 如果首次加载失败，定时重试
   - 或在打开仪表板时再次尝试加载

4. **缓存持久化**
   - 将缓存数据保存到本地文件
   - 离线时也能显示（使用过期数据）

## 📝 更新日志

**版本**: 1.0.0  
**日期**: 2025-10-02  
**功能**: 新增量比排行TOP20功能  
**修改**: 
1. 创建ContractInfoService服务
2. 集成自定义API接口
3. 实现量比计算逻辑
4. 添加启动时缓存加载

---
**开发完成** ✅ | **待UI集成** 🔨 