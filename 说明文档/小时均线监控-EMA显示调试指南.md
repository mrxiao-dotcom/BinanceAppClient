# 小时均线监控 - EMA显示调试指南

## 问题现象

图表窗口中只显示绿色的K线Close曲线，看不到橙红色的EMA曲线。

---

## 调试步骤

### 1. 运行应用并打开图表

1. 启动 BinanceApps.WPF 应用
2. 打开"小时均线监控"
3. 点击"获取小时K线"
4. 点击"计算"按钮
5. Ctrl+双击任意合约打开图表
6. **重点：查看控制台输出**

### 2. 分析控制台日志

现在图表加载时会输出详细的调试信息，请**复制所有日志**并检查以下内容：

#### 2.1 K线和EMA数量

```
📊 开始匹配EMA数据，K线数量=100，EMA字典数量=75
```

**检查点**：
- K线数量应该是您设置的数量（如100根）
- EMA字典数量应该 < K线数量（因为前N根K线没有EMA）

#### 2.2 时间对比

```
🔍 前3个K线时间:
  K线[0]: 2025-11-07 06:00:00
  K线[1]: 2025-11-07 07:00:00
  K线[2]: 2025-11-07 08:00:00
🔍 前3个EMA时间:
  EMA时间: 2025-11-07 09:00:00, 值=0.00012345
  EMA时间: 2025-11-07 10:00:00, 值=0.00012346
  EMA时间: 2025-11-07 11:00:00, 值=0.00012347
```

**检查点**：
- K线时间和EMA时间是否对齐？
- 如果**EMA时间比K线时间晚**，说明前面的K线没有EMA（正常）
- 如果时间格式不一致（如UTC vs 本地时间），会导致匹配失败

#### 2.3 匹配结果

```
✓ 匹配[25]: K线时间=2025-11-07 09:00:00, EMA=0.00012345
✓ 匹配[26]: K线时间=2025-11-07 10:00:00, EMA=0.00012346
✓ 匹配[27]: K线时间=2025-11-07 11:00:00, EMA=0.00012347
```

**检查点**：
- 如果看到这些"✓ 匹配"日志，说明EMA数据正在匹配
- 注意匹配的索引（如[25]），说明前25根K线没有EMA

#### 2.4 匹配统计

```
✅ EMA数据匹配完成，K线=100，匹配EMA=75/75
📊 EMA值列表大小=100, 其中有效值=75
```

**检查点**：
- "匹配EMA=75/75" 说明所有75个EMA都成功匹配
- **如果是 "匹配EMA=0/75"**，说明没有任何匹配，问题出在时间对比上

#### 2.5 EMA列表统计

```
📊 EMA列表统计: 总数=100, 有效=75, NaN=25
```

**检查点**：
- 有效值数量应该 > 0
- NaN数量 = K线数量 - 有效值数量

#### 2.6 EMA值内容

```
🔍 前3个EMA值:
  [0] = NaN
  [1] = NaN
  [2] = NaN
🔍 后3个EMA值:
  [97] = 0.00012456
  [98] = 0.00012457
  [99] = 0.00012458
```

**检查点**：
- 前面几个应该是NaN（因为EMA还没开始）
- 后面几个应该是实际的EMA数值
- **如果全是NaN**，说明匹配完全失败

#### 2.7 系列数组

```
📊 图表系列数组已设置，共 2 个系列
  系列[0]: Name=K线Close
  系列[1]: Name=EMA
```

**检查点**：
- 应该有2个系列（K线Close 和 EMA）
- **如果只有1个系列**，说明EMA系列没有被添加

---

## 常见问题和解决方案

### 问题1：匹配EMA=0/75

**原因**：K线时间和EMA时间格式不一致，无法匹配

**解决方案**：
- 检查K线时间和EMA时间的输出
- 如果一个是UTC，一个是本地时间，需要统一转换

**可能的修复**（如果时间不一致）：
```csharp
// 在匹配前统一转换为UTC
var klineTimeUtc = kline.OpenTime.Kind == DateTimeKind.Local 
    ? kline.OpenTime.ToUniversalTime() 
    : kline.OpenTime;
```

### 问题2：EMA值全是NaN

**原因**：EMA字典为空，或者键值不匹配

**可能的原因**：
1. 没有点击"计算"按钮
2. 计算EMA时出错
3. EMA数据没有保存到缓存

**解决方案**：
- 确保点击了"计算"按钮
- 检查"小时均线监控"窗口的结果列表，是否显示了EMA值

### 问题3：只有1个系列

**原因**：`matchedCount = 0`，导致EMA系列没有被添加

**解决方案**：
- 查看日志中的 `matchedCount` 值
- 如果为0，按"问题1"排查时间匹配问题

### 问题4：有2个系列但EMA线不显示

**可能的原因**：
1. EMA线被K线遮挡（可能性小，因为是不同颜色）
2. LiveCharts的NaN处理有问题
3. EMA值的范围和K线差异太大

**尝试方案**：
1. **加粗EMA线**（已实现，StrokeThickness=3）
2. **显示EMA数据点**（已实现，GeometrySize=5）
3. **检查Y轴范围**：确保包含EMA值

---

## 临时调试功能

当前版本添加了以下调试功能：

1. **加粗EMA线**：StrokeThickness=3（原来是2）
2. **显示EMA数据点**：GeometrySize=5（红色圆点）
3. **详细日志输出**：所有关键步骤都有日志

**注意**：如果能看到橙红色的数据点（即使没有线），说明EMA数据已经加载，问题在于LiveCharts的线条渲染。

---

## 提供反馈

请运行应用并打开图表后，提供以下信息：

1. **完整的控制台日志**（从 "📊 开始匹配EMA数据" 到 "系列[1]: Name=EMA"）
2. **图表截图**
3. **是否看到橙红色的数据点？**
4. **测试的合约名称**
5. **设置的参数**（N天均线、X根K线）

### 示例反馈格式

```
控制台日志：
📊 开始匹配EMA数据，K线数量=100，EMA字典数量=75
🔍 前3个K线时间:
  K线[0]: 2025-11-07 06:00:00
...（完整日志）

图表情况：
- 能看到绿色K线：是
- 能看到橙红色数据点：否
- 能看到橙红色线条：否

测试参数：
- 合约：BTCUSDT
- N天均线：25
- X根K线：100
```

---

## 下一步计划

根据您提供的日志，我们可以：

1. **如果matchedCount=0**：修复时间匹配问题
2. **如果有匹配但看不到线**：尝试不使用NaN，改用其他方式
3. **如果能看到数据点但没有线**：调整LiveCharts配置

---

**创建时间**: 2025-11-07  
**用于版本**: v2.1-debug

