# BinanceApps 发布和打包工作流程

## 🔄 当前工作流程

### 完整流程（5个步骤）

```
1. 修改代码 → 2. VS2022发布 → 3. 打包ZIP → 4. 上传服务器 → 5. 测试更新
```

---

## 📝 详细步骤

### 步骤 1：修改代码和版本号

1. **修改代码**（根据需求）

2. **更新版本号**（3个位置）：
   
   **A. 项目文件** `src/BinanceApps.WPF/BinanceApps.WPF.csproj`
   ```xml
   <Version>1.0.9</Version>
   <AssemblyVersion>1.0.9.0</AssemblyVersion>
   <FileVersion>1.0.9.0</FileVersion>
   ```
   
   **B. 配置文件** `src/BinanceApps.WPF/App.config`
   ```xml
   <add key="CurrentAppVersion" value="1.0.9" />
   ```
   
   **C. 打包脚本** `快速打包更新.cmd`
   ```batch
   set ZIP_NAME=BinanceApps_v1.0.9.zip
   ```

---

### 步骤 2：使用 VS2022 发布

**方式一：通过 VS2022 界面**

1. 在 VS2022 中右键点击 `BinanceApps.WPF` 项目
2. 选择 **"发布"**
3. 选择现有的发布配置文件（或创建新的）
4. 配置：
   - **目标位置**: `bin\Release\net9.0-windows\publish`
   - **配置**: Release
   - **目标运行时**: win-x64
   - **部署模式**: 框架依赖
5. 点击 **"发布"**

**方式二：通过命令行**

```powershell
# 在项目根目录执行
dotnet publish src/BinanceApps.WPF/BinanceApps.WPF.csproj `
    -c Release `
    -r win-x64 `
    --self-contained false `
    -o src/BinanceApps.WPF/bin/Release/net9.0-windows/publish
```

**发布后的目录结构**：
```
src/BinanceApps.WPF/bin/Release/net9.0-windows/publish/
├── BinanceApps.WPF.exe
├── App.config
├── *.dll （所有依赖）
├── runtimes/ （必需）
└── appsettings.json
```

---

### 步骤 3：打包 ZIP

**运行打包脚本**：
```batch
快速打包更新.cmd
```

**脚本会自动**：
1. ✅ 检查发布是否成功
2. ✅ 删除旧的 ZIP 文件
3. ✅ 将 `publish/` 目录打包为 ZIP
4. ✅ 显示文件大小和位置
5. ✅ 自动打开文件所在目录

**输出文件**：
```
BinanceApps_v1.0.9.zip  （在项目根目录）
```

---

### 步骤 4：上传到更新服务器

1. 登录更新服务器管理后台
2. 进入 **版本管理**
3. 点击 **"添加新版本"**
4. 填写信息：
   - 版本号：`1.0.9`
   - 上传文件：`BinanceApps_v1.0.9.zip`
   - 更新说明：填写本次更新内容
   - 是否强制更新：根据需要勾选
5. 提交保存

---

### 步骤 5：测试更新

1. 运行客户端程序
2. 打开 **帮助 → 检查更新**
3. 验证：
   - ✅ 是否检测到新版本
   - ✅ 更新是否成功下载
   - ✅ 程序是否正常重启
   - ✅ 注册码是否保留
   - ✅ 版本号是否更新

---

## 🗑️ 定期清理

### 何时清理？

- 发布新版本前
- 磁盘空间不足时
- 项目目录过大时

### 如何清理？

**运行清理脚本**：
```batch
清理构建目录.cmd
```

**会删除**：
- ❌ `bin/Debug/` - 调试输出
- ❌ `bin/Release/` 根目录文件 - 中间产物
- ❌ `bin/Release/net9.0-windows/` 除 publish 外的文件
- ❌ `obj/` - 编译缓存
- ❌ 所有 `*.bak` 备份文件

**会保留**：
- ✅ `publish/` - 发布输出（用于打包）
- ✅ `KlineData/` - K线数据
- ✅ `MaDistanceData/` - 均线距离数据
- ✅ `Data/` - 数据库文件
- ✅ `runtimes/` - 运行时库

---

## 📋 目录结构（清理后）

```
src/BinanceApps.WPF/
├── bin/
│   └── Release/
│       └── net9.0-windows/
│           ├── publish/              ⭐ 发布输出（用于打包）
│           ├── KlineData/            ✅ 数据目录（保留）
│           ├── MaDistanceData/       ✅ 数据目录（保留）
│           ├── Data/                 ✅ 数据目录（保留）
│           └── runtimes/             ✅ 运行时库（保留）
├── App.config                        📝 源配置文件
├── BinanceApps.WPF.csproj           📝 项目文件
└── ... （其他源代码文件）
```

---

## 🔧 快速命令参考

### 完整发布流程（命令行）

```batch
# 1. 清理旧文件
清理构建目录.cmd

# 2. 发布应用
cd src/BinanceApps.WPF
dotnet publish -c Release -r win-x64 --self-contained false -o bin/Release/net9.0-windows/publish
cd ../..

# 3. 打包 ZIP
快速打包更新.cmd
```

### 仅重新打包

```batch
# 如果 publish 目录已存在，只需重新打包
快速打包更新.cmd
```

---

## ⚠️ 注意事项

### 1. 版本号管理

- ✅ 确保 3 个位置的版本号一致
- ✅ 遵循语义化版本规范（主版本.次版本.补丁）
- ✅ 打包前检查版本号是否正确

### 2. 配置文件

- ✅ `App.config` 会被自动复制到 publish 目录
- ✅ 开发环境和运行时配置是分离的
- ❌ 不要在 publish 目录手动修改配置（会被覆盖）

### 3. 数据安全

- ✅ 清理脚本会保留所有数据目录
- ✅ 注册码保存在 `%LocalAppData%\BinanceApps\`
- ✅ 更新不会影响用户数据

### 4. 测试建议

- ✅ 本地测试：先在 publish 目录运行测试
- ✅ 更新测试：使用旧版本测试更新流程
- ✅ 回退测试：确认更新失败时能正常回退

---

## 🚀 最佳实践

### 发布清单

每次发布前检查：

- [ ] 代码已提交到版本控制
- [ ] 版本号已更新（3个位置）
- [ ] 更新日志已记录
- [ ] 本地测试通过
- [ ] 清理了旧的构建输出
- [ ] 发布成功，无错误
- [ ] ZIP 文件已生成
- [ ] 文件大小合理（约 3-5 MB）

### 文件管理

- ✅ 定期清理 `.bak` 文件
- ✅ 备份数据目录到其他位置
- ✅ 只提交源代码到版本控制（不提交 bin/obj）
- ✅ ZIP 文件单独存储，不入库

---

## 📞 故障排查

### 问题 1：发布失败

**可能原因**：
- 代码编译错误
- 依赖包缺失
- 磁盘空间不足

**解决方法**：
```batch
# 清理并重新构建
清理构建目录.cmd
dotnet restore
dotnet build -c Release
dotnet publish -c Release -r win-x64 --self-contained false -o src/BinanceApps.WPF/bin/Release/net9.0-windows/publish
```

### 问题 2：打包失败

**可能原因**：
- publish 目录不存在
- 权限不足
- 文件被占用

**解决方法**：
1. 确认 publish 目录存在
2. 关闭所有运行中的程序
3. 以管理员身份运行脚本

### 问题 3：更新后版本号未变

**可能原因**：
- App.config 中的 `CurrentAppVersion` 未更新
- 客户端缓存

**解决方法**：
1. 检查 publish/App.config 中的版本号
2. 删除客户端的配置缓存
3. 重新发布

---

**文档版本**: 1.0  
**更新日期**: 2025-10-01  
**适用版本**: BinanceApps 1.0.8+ 