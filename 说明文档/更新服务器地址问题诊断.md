# 更新服务器地址问题诊断与修复

## 📋 问题现象

程序启动时，日志显示：
```
🌐 服务器地址: http://38.181.35.75:8080         ✅ 正确（许可证服务器）
🔧 [调试] 更新服务器 URL: http://192.168.1.101:8080  ❌ 错误（旧的硬编码地址）
```

**许可证服务器地址正确**，但**更新服务器地址错误**，说明程序还在使用旧的编译文件。

---

## 🔍 原因分析

### 1. 代码检查 ✅
- `App.xaml.cs` 第 50 行：`ServerUrl = serverUrl` ✅ 代码正确
- `App.config` 第 10 行：`LicenseServerUrl` = `http://38.181.35.75:8080` ✅ 配置正确
- 源代码中已无任何 `192.168.1.101` 的硬编码 ✅

### 2. 编译缓存 ❌
**最可能的原因**：
- Visual Studio 增量编译缓存了旧代码
- `bin/` 和 `obj/` 目录中存在旧的 DLL
- 正在运行的程序锁定了 DLL，导致无法更新

---

## ✅ 解决方案

### 方法 1：使用自动脚本（推荐）⭐⭐⭐⭐⭐

1. **关闭所有相关程序**：
   - 关闭 `BinanceApps.WPF.exe`
   - 关闭 Visual Studio（如果已打开）

2. **运行清理脚本**：
   ```batch
   彻底清理并重新编译.cmd
   ```

3. **验证**：
   - 运行新编译的程序
   - 查看控制台日志，确认"更新服务器 URL"是否正确

---

### 方法 2：手动操作

#### 步骤 1：关闭程序
```batch
# 确保没有任何程序在运行
taskkill /f /im BinanceApps.WPF.exe 2>nul
```

#### 步骤 2：清理编译目录
```batch
# 删除所有 bin 和 obj 目录
for /d /r . %%d in (bin,obj) do @if exist "%%d" rd /s /q "%%d"
```

#### 步骤 3：还原 NuGet 包
```batch
dotnet restore src/BinanceApps.WPF/BinanceApps.WPF.csproj
```

#### 步骤 4：强制完整重新编译
```batch
dotnet build src/BinanceApps.WPF/BinanceApps.WPF.csproj -c Release --no-incremental
```

#### 步骤 5：运行并验证
```batch
src\BinanceApps.WPF\bin\Release\net9.0-windows\BinanceApps.WPF.exe
```

---

## 🧪 验证步骤

### 1. 查看控制台输出

运行程序后，控制台应该显示：
```
🚀 BinanceApps 启动
📋 应用信息: BinanceApps (ID: App_20250928132921)
🌐 服务器地址: http://38.181.35.75:8080
...
🔧 [调试] 更新服务器 URL: http://38.181.35.75:8080  ← 应该和上面一致！
🔧 [调试] 应用 ID: App_20250928132921
🔧 [调试] 应用名称: BinanceApps
```

### 2. 检查版本号

查看日志中的版本号：
```
📌 使用已保存的版本号: 1.0.8（来自最后一次更新）
🔧 [调试] 当前版本: 1.0.8
```

### 3. 测试检查更新功能

点击 **"帮助" → "检查更新"**，确认能够正常连接到服务器。

---

## 🔧 高级调试

### 如果问题依然存在

#### 1. 检查可执行文件的时间戳
```batch
dir /TC src\BinanceApps.WPF\bin\Release\net9.0-windows\BinanceApps.WPF.exe
```
确认文件的修改时间是最新的。

#### 2. 检查 DLL 是否被锁定
```batch
# 使用 Process Explorer 查看是否有进程锁定了 DLL
# 或者重启电脑后再次编译
```

#### 3. 清理 NuGet 缓存
```batch
dotnet nuget locals all --clear
dotnet restore
```

#### 4. 使用 Visual Studio 重建
- 在 Visual Studio 中：**生成 → 清理解决方案**
- 然后：**生成 → 重新生成解决方案**

---

## 📝 配置文件确认

### App.config 应该包含：
```xml
<appSettings>
    <!-- 统一的服务器地址 -->
    <add key="LicenseServerUrl" value="http://38.181.35.75:8080" />
    
    <!-- 应用标识 -->
    <add key="ApplicationId" value="App_20250928132921" />
    <add key="ApplicationName" value="BinanceApps" />
    
    <!-- 当前版本（自动更新） -->
    <add key="CurrentAppVersion" value="1.0.8" />
</appSettings>
```

---

## ⚠️ 注意事项

1. **必须先关闭程序**：正在运行的程序会锁定 DLL，导致无法替换

2. **清理后首次编译较慢**：因为需要重新编译所有依赖项

3. **不要使用增量编译**：使用 `--no-incremental` 参数确保完全重新编译

4. **验证可执行文件位置**：
   - Debug 版本：`src\BinanceApps.WPF\bin\Debug\net9.0-windows\`
   - Release 版本：`src\BinanceApps.WPF\bin\Release\net9.0-windows\`
   
   确保运行的是正确版本的可执行文件！

---

## 🎯 快速检查清单

- [ ] 已关闭所有 BinanceApps.WPF.exe 进程
- [ ] 已关闭 Visual Studio
- [ ] 已删除所有 bin 和 obj 目录
- [ ] 已执行 `dotnet restore`
- [ ] 已执行 `dotnet build --no-incremental`
- [ ] 运行程序后，控制台显示正确的服务器地址
- [ ] "检查更新"功能正常工作

---

## 🆘 如果仍然无法解决

### 终极解决方案：完全重新克隆项目

```batch
# 1. 备份当前项目
xcopy /E /I D:\CSharpProjects\BinanceAppsClient D:\CSharpProjects\BinanceAppsClient_Backup

# 2. 删除旧项目
rd /s /q D:\CSharpProjects\BinanceAppsClient

# 3. 重新克隆/复制项目
# ...

# 4. 还原和编译
cd D:\CSharpProjects\BinanceAppsClient
dotnet restore
dotnet build -c Release
```

---

**诊断版本**: 1.0  
**创建日期**: 2025-10-05  
**适用版本**: BinanceApps v1.0.8+  
**预计解决时间**: 5-10 分钟

