# 服务器地址配置说明

## ✅ 问题已修复

### 🐛 原问题

之前 `App.xaml.cs` 中硬编码了服务器地址：
```csharp
ServerUrl = "http://192.168.1.101:8080",  // ❌ 硬编码
```

这导致：
- ❌ 修改 `App.config` 无效
- ❌ 必须重新编译才能更改服务器
- ❌ 无法灵活切换服务器

### ✅ 修复方案

已修改为从配置文件动态读取：
```csharp
ServerUrl = serverUrl,  // ✅ 从 App.config 动态读取
```

**位置**: `src/BinanceApps.WPF/App.xaml.cs` 第 50 行

---

## 🔧 现在如何修改服务器地址

### 方法 1：修改源码配置（开发环境）

**文件**: `src/BinanceApps.WPF/App.config`

修改第 10 行：
```xml
<add key="LicenseServerUrl" value="http://新服务器地址:端口" />
```

**重新编译并发布**：
```bash
# 在 VS2022 中发布
右键项目 → 发布 → 发布到 publish
```

---

### 方法 2：修改发布配置（运行时）

**文件**: `src/BinanceApps.WPF/publish/App.config`

修改第 10 行：
```xml
<add key="LicenseServerUrl" value="http://新服务器地址:端口" />
```

**重新打包**：
```bash
快速打包更新.cmd
```

**无需重新编译！直接生效！**

---

## 📋 配置说明

### 单一配置项，双重用途

`LicenseServerUrl` 同时用于：

1. **许可证验证** (`LicenseManager`)
   - 验证注册码
   - 激活许可证
   - 在线验证

2. **自动更新** (`UpdateManager`)
   - 检查新版本
   - 下载更新包
   - 版本管理

### 完整配置示例

```xml
<?xml version="1.0" encoding="utf-8"?>
<configuration>
    <appSettings>
        <!-- 🌐 服务器地址（许可证 + 更新） -->
        <add key="LicenseServerUrl" value="http://38.181.35.75:8080" />
        
        <!-- 📱 应用标识 -->
        <add key="ApplicationId" value="App_20250928132921" />
        
        <!-- 📌 当前版本（自动更新） -->
        <add key="CurrentAppVersion" value="1.0.8" />
        
        <!-- 🔑 许可证密钥（自动保存，保存在 AppData） -->
        <add key="LicenseKey" value="" />
    </appSettings>
</configuration>
```

---

## 🚀 快速切换服务器

### 场景 1：切换到公网服务器

```xml
<add key="LicenseServerUrl" value="http://38.181.35.75:8080" />
```

### 场景 2：切换到本地测试服务器

```xml
<add key="LicenseServerUrl" value="http://192.168.1.101:8080" />
```

### 场景 3：使用域名

```xml
<add key="LicenseServerUrl" value="https://update.yourdomain.com" />
```

---

## 📝 修改步骤（完整流程）

### 开发环境修改并发布新版本

```bash
# 1. 修改源码配置
编辑: src/BinanceApps.WPF/App.config
修改: LicenseServerUrl 值

# 2. 在 VS2022 中发布
右键 BinanceApps.WPF → 发布

# 3. 打包 ZIP
快速打包更新.cmd

# 4. 上传到服务器
登录更新服务器 → 上传 ZIP 文件
```

### 仅修改已发布程序的服务器地址

```bash
# 1. 修改发布目录的配置
编辑: src/BinanceApps.WPF/publish/App.config
修改: LicenseServerUrl 值

# 2. 重新打包
快速打包更新.cmd

# 3. 上传到服务器
登录更新服务器 → 上传 ZIP 文件
```

---

## ⚠️ 注意事项

### 1. 配置同步

修改服务器地址后，需要确保：
- ✅ 源码的 `App.config` 
- ✅ 发布目录的 `publish/App.config`
- ✅ 两者保持一致

### 2. 服务器格式

```
✅ 正确格式：
http://192.168.1.101:8080
http://38.181.35.75:8080
https://update.yourdomain.com

❌ 错误格式：
http://192.168.1.101:8080/  （不要尾部斜杠）
192.168.1.101:8080          （缺少协议）
http://192.168.1.101        （缺少端口）
```

### 3. 更新流程

修改服务器地址后：
1. ✅ 需要重新打包 ZIP
2. ✅ 上传到**新服务器**
3. ✅ 客户端需要**手动修改配置**或**重新安装**

### 4. 许可证问题

切换服务器后：
- ⚠️ 可能需要重新激活许可证
- ⚠️ 因为许可证数据在不同服务器上
- ✅ 注册码保存在 AppData，不会丢失

---

## 🔍 验证修改是否生效

### 方法 1：查看启动日志

运行程序，查看控制台输出：
```
📋 应用信息: BinanceApps (ID: App_20250928132921)
🌐 服务器地址: http://38.181.35.75:8080  ← 检查这里
🔧 [调试] 更新服务器 URL: http://38.181.35.75:8080  ← 检查这里
```

### 方法 2：测试功能

1. **许可证验证**
   - 输入注册码
   - 检查是否能成功激活

2. **检查更新**
   - 帮助 → 检查更新
   - 查看是否能连接到新服务器

---

## 📞 故障排查

### 问题 1：修改配置后仍然连接旧服务器

**原因**：可能修改了源码配置，但未重新发布

**解决**：
```bash
# 确保修改的是 publish 目录的配置
src/BinanceApps.WPF/publish/App.config
```

### 问题 2：连接服务器失败

**原因**：服务器地址错误或服务器未运行

**检查**：
1. 服务器地址格式是否正确
2. 服务器是否在运行
3. 网络是否可达
4. 防火墙是否放行

### 问题 3：许可证验证失败

**原因**：新服务器上没有许可证数据

**解决**：
1. 在新服务器上创建应用
2. 生成新的许可证
3. 重新激活客户端

---

## 📚 相关文件

### 配置文件
- `src/BinanceApps.WPF/App.config` - 源码配置
- `src/BinanceApps.WPF/publish/App.config` - 发布配置

### 代码文件
- `src/BinanceApps.WPF/App.xaml.cs` (第 35, 50 行) - 读取配置

### 脚本文件
- `快速打包更新.cmd` - 打包发布
- `清理构建目录.cmd` - 清理构建输出

### 文档文件
- `构建目录说明.md` - 目录结构说明
- `发布和打包工作流程.md` - 发布流程
- `服务器地址配置说明.md` - 本文档

---

## ✅ 修复验证清单

修改完成后，请验证：

- [ ] `App.xaml.cs` 第 50 行使用 `serverUrl` 变量
- [ ] `App.config` 中的 `LicenseServerUrl` 已修改
- [ ] 重新发布或打包
- [ ] 启动程序，查看日志输出的服务器地址
- [ ] 测试许可证验证功能
- [ ] 测试检查更新功能

---

**文档版本**: 1.0  
**更新日期**: 2025-10-01  
**适用版本**: BinanceApps 1.0.8+  
**修复状态**: ✅ 已修复 