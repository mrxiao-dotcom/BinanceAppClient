# 自定义板块监控功能开发文档

## 📋 需求概述

### 功能目标
实现一个自定义板块监控功能，允许用户创建、管理和监控自定义的合约组合。

### 核心功能
1. ✅ 创建自定义组合（名称、说明、合约列表）
2. ✅ 通过模糊搜索添加合约到组合
3. ✅ 查看组合的平均涨幅
4. ✅ 查看组合内合约的详细数据
5. ✅ 修改和删除组合
6. ✅ 数据持久化（AppData目录）

---

## 🎨 UI 设计

### 页面布局

```
┌─────────────────────────────────────────────────────────────────┐
│ 自定义板块监控                                                    │
├─────────────────────────────────────────────────────────────────┤
│ [创建组合] [刷新数据] [导出数据]                    最后更新: xxx  │
├──────────────────────────┬──────────────────────────────────────┤
│ 组合列表                  │ 组合明细                               │
│ ┌──────────────────────┐│ ┌────────────────────────────────┐  │
│ │ 主流币板块            ││ │ 合约    涨幅    价格    成交额   │  │
│ │ +5.23%  ↑  8个       ││ │ BTCUSDT +3.2%  $50,234  $2.5B  │  │
│ │ [修改] [删除]         ││ │ 备注: 比特币                    │  │
│ ├──────────────────────┤│ ├────────────────────────────────┤  │
│ │ DeFi板块              ││ │ ETHUSDT +2.1%  $3,456  $1.2B   │  │
│ │ -2.15%  ↓  12个      ││ │ 备注: 以太坊                    │  │
│ │ [修改] [删除]         ││ ├────────────────────────────────┤  │
│ ├──────────────────────┤│ │ SOLUSDT +8.5%  $150.23  $800M  │  │
│ │ Layer2板块            ││ │ 备注: 高性能公链                │  │
│ │ +1.05%  ↑  6个       ││ └────────────────────────────────┘  │
│ │ [修改] [删除]         ││                                      │
│ └──────────────────────┘│                                      │
└──────────────────────────┴──────────────────────────────────────┘
```

### 创建/编辑组合对话框

```
┌───────────────────────────────────────────────┐
│ 创建自定义组合                                 │
├───────────────────────────────────────────────┤
│                                               │
│ 组合名称:                                      │
│ ┌───────────────────────────────────────────┐│
│ │ 主流币板块                                  ││
│ └───────────────────────────────────────────┘│
│                                               │
│ 组合说明:                                      │
│ ┌───────────────────────────────────────────┐│
│ │ 包含主流大盘币种                            ││
│ └───────────────────────────────────────────┘│
│                                               │
│ 添加合约:                                      │
│ ┌─────────────────┐ [搜索]                   │
│ │ BTC             │                          │
│ └─────────────────┘                          │
│                                               │
│ 搜索结果:                                      │
│ ┌───────────────────────────────────────────┐│
│ │ BTCUSDT  [添加]                            ││
│ │ BTCBUSD  [添加]                            ││
│ │ BTCEUR   [添加]                            ││
│ └───────────────────────────────────────────┘│
│                                               │
│ 已添加的合约:                                  │
│ ┌───────────────────────────────────────────┐│
│ │ BTCUSDT  [删除]                            ││
│ │ 备注: ┌──────────────┐                    ││
│ │      │ 比特币        │                    ││
│ │      └──────────────┘                    ││
│ ├───────────────────────────────────────────┤│
│ │ ETHUSDT  [删除]                            ││
│ │ 备注: ┌──────────────┐                    ││
│ │      │ 以太坊        │                    ││
│ │      └──────────────┘                    ││
│ └───────────────────────────────────────────┘│
│                                               │
│              [确定]  [取消]                    │
└───────────────────────────────────────────────┘
```

---

## 🏗️ 架构设计

### 技术栈
- **数据层**: `CustomPortfolio.cs` - 数据模型
- **服务层**: `CustomPortfolioService.cs` - 业务逻辑
- **界面层**: `CustomPortfolioWindow.xaml` - WPF界面
- **存储**: `%AppData%\BinanceApps\custom_portfolios.json`

### 数据流

```
用户操作
   ↓
WPF界面（CustomPortfolioWindow）
   ↓
服务层（CustomPortfolioService）
   ↓
JSON持久化（AppData目录）
```

### 数据更新流

```
Timer定时器（每5秒）
   ↓
获取24H Ticker数据
   ↓
计算组合平均涨幅
   ↓
更新UI显示
```

---

## 💾 数据结构

### 1. 自定义板块（CustomPortfolio）
```csharp
public class CustomPortfolio
{
    public string Id { get; set; }              // GUID
    public string Name { get; set; }            // 组合名称
    public string Description { get; set; }     // 组合说明
    public List<PortfolioSymbol> Symbols { get; set; }  // 合约列表
    public DateTime CreatedTime { get; set; }   // 创建时间
    public DateTime LastModifiedTime { get; set; }  // 修改时间
}
```

### 2. 组合内合约（PortfolioSymbol）
```csharp
public class PortfolioSymbol
{
    public string Symbol { get; set; }   // 合约代码（如BTCUSDT）
    public string Remark { get; set; }   // 备注
    public DateTime AddedTime { get; set; }  // 添加时间
}
```

### 3. 运行时数据（PortfolioRuntimeData）
```csharp
public class PortfolioRuntimeData
{
    public CustomPortfolio Portfolio { get; set; }
    public decimal AveragePriceChangePercent { get; set; }  // 平均涨幅
    public List<PortfolioSymbolData> SymbolsData { get; set; }
    public DateTime LastUpdateTime { get; set; }
}
```

### 4. 合约实时数据（PortfolioSymbolData）
```csharp
public class PortfolioSymbolData
{
    public string Symbol { get; set; }
    public string Remark { get; set; }
    public decimal PriceChangePercent { get; set; }  // 24H涨幅
    public decimal LastPrice { get; set; }           // 当前价格
    public decimal QuoteVolume { get; set; }         // 24H成交额
}
```

---

## 📝 实施步骤

### 阶段 1：数据模型（已完成 ✅）
- [x] `CustomPortfolio.cs` - 创建数据模型
- [x] `CustomPortfolioService.cs` - 创建服务层

### 阶段 2：UI界面（待实施）

#### 2.1 主窗口（CustomPortfolioWindow.xaml）
```xml
<Window x:Class="BinanceApps.WPF.CustomPortfolioWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="自定义板块监控" Height="700" Width="1200"
        WindowStartupLocation="CenterScreen">
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>  <!-- 功能区 -->
            <RowDefinition Height="*"/>     <!-- 内容区 -->
        </Grid.RowDefinitions>
        
        <!-- 功能区 -->
        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="10">
            <Button x:Name="btnCreatePortfolio" Content="创建组合" 
                    Width="100" Height="30" Margin="5" Click="BtnCreatePortfolio_Click"/>
            <Button x:Name="btnRefreshData" Content="刷新数据" 
                    Width="100" Height="30" Margin="5" Click="BtnRefreshData_Click"/>
            <TextBlock x:Name="txtLastUpdate" VerticalAlignment="Center" 
                       Margin="20,0,0,0" Text="最后更新: --"/>
        </StackPanel>
        
        <!-- 内容区 -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="300"/>  <!-- 组合列表 -->
                <ColumnDefinition Width="*"/>    <!-- 组合明细 -->
            </Grid.ColumnDefinitions>
            
            <!-- 组合列表 -->
            <Border Grid.Column="0" BorderBrush="LightGray" BorderThickness="1" Margin="10">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    
                    <TextBlock Grid.Row="0" Text="组合列表" FontSize="16" 
                               FontWeight="Bold" Margin="10" TextAlignment="Center"/>
                    
                    <ListView x:Name="lvPortfolios" Grid.Row="1" 
                              SelectionChanged="LvPortfolios_SelectionChanged">
                        <!-- ListView模板在代码中动态生成 -->
                    </ListView>
                </Grid>
            </Border>
            
            <!-- 组合明细 -->
            <Border Grid.Column="1" BorderBrush="LightGray" BorderThickness="1" Margin="10">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    
                    <TextBlock Grid.Row="0" x:Name="txtDetailTitle" Text="请选择组合" 
                               FontSize="16" FontWeight="Bold" Margin="10" TextAlignment="Center"/>
                    
                    <ListView x:Name="lvSymbolDetails" Grid.Row="1">
                        <!-- ListView模板在代码中动态生成 -->
                    </ListView>
                </Grid>
            </Border>
        </Grid>
    </Grid>
</Window>
```

#### 2.2 创建/编辑对话框（PortfolioEditorDialog.xaml）
```xml
<Window x:Class="BinanceApps.WPF.PortfolioEditorDialog"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="编辑组合" Height="600" Width="500"
        WindowStartupLocation="CenterOwner">
    
    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>  <!-- 名称 -->
            <RowDefinition Height="Auto"/>  <!-- 说明 -->
            <RowDefinition Height="Auto"/>  <!-- 搜索 -->
            <RowDefinition Height="150"/>   <!-- 搜索结果 -->
            <RowDefinition Height="*"/>     <!-- 已添加合约 -->
            <RowDefinition Height="Auto"/>  <!-- 按钮 -->
        </Grid.RowDefinitions>
        
        <!-- 组合名称 -->
        <StackPanel Grid.Row="0" Margin="0,5">
            <TextBlock Text="组合名称:" FontWeight="Bold"/>
            <TextBox x:Name="txtName" Height="30" Margin="0,5"/>
        </StackPanel>
        
        <!-- 组合说明 -->
        <StackPanel Grid.Row="1" Margin="0,5">
            <TextBlock Text="组合说明:" FontWeight="Bold"/>
            <TextBox x:Name="txtDescription" Height="60" 
                     TextWrapping="Wrap" AcceptsReturn="True" Margin="0,5"/>
        </StackPanel>
        
        <!-- 搜索合约 -->
        <StackPanel Grid.Row="2" Margin="0,5">
            <TextBlock Text="添加合约:" FontWeight="Bold"/>
            <Grid Margin="0,5">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <TextBox x:Name="txtSearch" Grid.Column="0" Height="30"/>
                <Button x:Name="btnSearch" Grid.Column="1" Content="搜索" 
                        Width="80" Height="30" Margin="5,0,0,0" Click="BtnSearch_Click"/>
            </Grid>
        </StackPanel>
        
        <!-- 搜索结果 -->
        <StackPanel Grid.Row="3" Margin="0,5">
            <TextBlock Text="搜索结果:" FontWeight="Bold"/>
            <ListView x:Name="lvSearchResults" Margin="0,5">
                <!-- 动态生成 -->
            </ListView>
        </StackPanel>
        
        <!-- 已添加合约 -->
        <StackPanel Grid.Row="4" Margin="0,5">
            <TextBlock Text="已添加的合约:" FontWeight="Bold"/>
            <ListView x:Name="lvSelectedSymbols" Margin="0,5">
                <!-- 动态生成 -->
            </ListView>
        </StackPanel>
        
        <!-- 按钮 -->
        <StackPanel Grid.Row="5" Orientation="Horizontal" 
                    HorizontalAlignment="Right" Margin="0,10">
            <Button x:Name="btnSave" Content="保存" Width="80" Height="30" 
                    Margin="5" Click="BtnSave_Click"/>
            <Button x:Name="btnCancel" Content="取消" Width="80" Height="30" 
                    Margin="5" Click="BtnCancel_Click"/>
        </StackPanel>
    </Grid>
</Window>
```

### 阶段 3：业务逻辑实现

#### 3.1 初始化服务
```csharp
// 在 MainWindow.xaml.cs 中
private CustomPortfolioService? _customPortfolioService;

// 在构造函数中初始化
_customPortfolioService = new CustomPortfolioService(_logger);
await _customPortfolioService.InitializeAsync();
```

#### 3.2 获取Ticker数据
```csharp
// 使用现有的 API 客户端获取 24H Ticker
var tickers = await _apiClient.Get24HTickersAsync();

// 为每个组合计算平均涨幅
foreach (var portfolio in portfolios)
{
    var symbolTickers = tickers
        .Where(t => portfolio.Symbols.Any(s => s.Symbol == t.Symbol))
        .ToList();
    
    var avgChange = symbolTickers.Average(t => t.PriceChangePercent);
    // 更新UI显示
}
```

#### 3.3 创建组合流程
```
1. 用户点击"创建组合"按钮
2. 显示 PortfolioEditorDialog 对话框
3. 用户输入名称、说明
4. 用户搜索并添加合约
5. 用户点击"保存"
6. 调用 CustomPortfolioService.CreatePortfolioAsync()
7. 刷新组合列表显示
```

#### 3.4 修改组合流程
```
1. 用户选择组合，点击"修改"按钮
2. 显示 PortfolioEditorDialog 对话框（预填充数据）
3. 用户修改信息
4. 用户点击"保存"
5. 调用 CustomPortfolioService.UpdatePortfolioAsync()
6. 刷新组合列表显示
```

#### 3.5 删除组合流程
```
1. 用户选择组合，点击"删除"按钮
2. 显示确认对话框
3. 用户确认
4. 调用 CustomPortfolioService.DeletePortfolioAsync()
5. 刷新组合列表显示
```

---

## 🎨 UI元素设计细节

### 组合列表项模板
```
┌────────────────────────────┐
│ 主流币板块                  │  ← 组合名称（粗体）
│ +5.23% ↑  8个合约          │  ← 涨幅（颜色）+ 成分数
│ [修改] [删除]               │  ← 操作按钮
└────────────────────────────┘
```

**涨幅颜色规则**：
- 涨幅 > 0：绿色 + ↑
- 涨幅 < 0：红色 + ↓
- 涨幅 = 0：灰色 + →

### 合约明细列表项模板
```
┌────────────────────────────────────────────┐
│ BTCUSDT                                    │  ← 合约名称
│ 涨幅: +3.25%  价格: $50,234.56             │  ← 涨幅、价格
│ 成交额: $2.5B                               │  ← 24H成交额
│ 备注: 比特币                                │  ← 用户备注
└────────────────────────────────────────────┘
```

---

## 🔄 数据更新机制

### 定时刷新
```csharp
// 使用 Timer 每5秒更新一次
private System.Threading.Timer? _updateTimer;

private void StartAutoUpdate()
{
    _updateTimer = new System.Threading.Timer(
        async _ => await RefreshPortfolioDataAsync(),
        null,
        TimeSpan.Zero,
        TimeSpan.FromSeconds(5)
    );
}
```

### 手动刷新
```csharp
private async void BtnRefreshData_Click(object sender, RoutedEventArgs e)
{
    await RefreshPortfolioDataAsync();
    MessageBox.Show("数据已刷新", "提示", MessageBoxButton.OK, MessageBoxImage.Information);
}
```

---

## 📊 数据存储示例

### custom_portfolios.json
```json
{
  "Version": "1.0",
  "LastUpdated": "2025-10-01T12:00:00Z",
  "Portfolios": [
    {
      "Id": "abc123...",
      "Name": "主流币板块",
      "Description": "包含主流大盘币种",
      "Symbols": [
        {
          "Symbol": "BTCUSDT",
          "Remark": "比特币",
          "AddedTime": "2025-10-01T10:00:00Z"
        },
        {
          "Symbol": "ETHUSDT",
          "Remark": "以太坊",
          "AddedTime": "2025-10-01T10:05:00Z"
        }
      ],
      "CreatedTime": "2025-10-01T10:00:00Z",
      "LastModifiedTime": "2025-10-01T10:05:00Z"
    }
  ]
}
```

---

## ✅ 测试清单

### 功能测试
- [ ] 创建组合
- [ ] 编辑组合
- [ ] 删除组合
- [ ] 搜索合约（模糊匹配）
- [ ] 添加合约到组合
- [ ] 从组合中移除合约
- [ ] 添加/修改合约备注
- [ ] 查看组合涨幅
- [ ] 查看合约详细数据

### 数据持久化测试
- [ ] 创建组合后重启应用，数据保留
- [ ] 修改组合后重启应用，修改保留
- [ ] 删除组合后重启应用，确认已删除

### 边界测试
- [ ] 空组合（0个合约）
- [ ] 大组合（100+个合约）
- [ ] 重复添加同一个合约
- [ ] 搜索不存在的合约
- [ ] 组合名称为空
- [ ] 特殊字符处理

### 性能测试
- [ ] 10个组合，每个100个合约
- [ ] 数据刷新性能
- [ ] UI响应速度

---

## 🚀 后续增强功能（可选）

### 短期增强
- [ ] 组合排序（按涨幅、名称等）
- [ ] 组合导出（JSON/CSV）
- [ ] 组合导入
- [ ] 搜索历史记录

### 长期增强
- [ ] 组合性能图表
- [ ] 历史涨幅趋势
- [ ] 告警功能（组合涨幅达到阈值）
- [ ] 组合对比功能
- [ ] 云端同步

---

## 📞 常见问题

### Q1: 如何获取全市场合约列表？
**A**: 使用现有的 `_apiClient.GetExchangeInfoAsync()` 方法获取所有交易对。

### Q2: 涨幅数据从哪里来？
**A**: 使用 `_apiClient.Get24HTickersAsync()` 获取24小时Ticker数据。

### Q3: 数据保存在哪里？
**A**: `%LocalAppData%\BinanceApps\custom_portfolios.json`

### Q4: 如何处理已删除的合约？
**A**: 在刷新数据时，如果合约不存在于Ticker列表中，显示为"已下架"状态。

---

## 📝 开发进度

- [x] 阶段1：数据模型（CustomPortfolio.cs）
- [x] 阶段1：服务层（CustomPortfolioService.cs）
- [x] 阶段1：开发文档
- [ ] 阶段2：主窗口UI（CustomPortfolioWindow.xaml）
- [ ] 阶段2：编辑对话框UI（PortfolioEditorDialog.xaml）
- [ ] 阶段3：业务逻辑实现
- [ ] 阶段4：集成到主菜单
- [ ] 阶段5：测试和优化

---

**开发开始日期**: 2025-10-01  
**预计完成日期**: 待定  
**责任人**: 开发团队 