# ğŸ“± å®¢æˆ·ç«¯é›†æˆæŒ‡å—

## ğŸ¯ **æ¦‚è¿°**

è¿™ä¸ªæŒ‡å—å°†å¸®åŠ©æ‚¨å°†æ³¨å†ŒéªŒè¯åŠŸèƒ½é›†æˆåˆ°ç°æœ‰çš„WPFå®¢æˆ·ç«¯åº”ç”¨ç¨‹åºä¸­ã€‚

---

## ğŸš€ **å¿«é€Ÿå¼€å§‹**

### **ç¬¬ä¸€æ­¥ï¼šæ·»åŠ å¼•ç”¨**

åœ¨æ‚¨çš„WPFå®¢æˆ·ç«¯é¡¹ç›®ä¸­æ·»åŠ å¯¹ClientSDKçš„å¼•ç”¨ï¼š

```xml
<ProjectReference Include="path\to\RegisterSrv.ClientSDK\RegisterSrv.ClientSDK.csproj" />
```

æˆ–è€…æ·»åŠ NuGetåŒ…å¼•ç”¨ï¼ˆå¦‚æœæ‚¨å°†SDKæ‰“åŒ…ä¸ºNuGetåŒ…ï¼‰ï¼š

```xml
<PackageReference Include="RegisterSrv.ClientSDK" Version="1.0.0" />
```

### **ç¬¬äºŒæ­¥ï¼šæ·»åŠ å¿…è¦çš„NuGetåŒ…**

åœ¨æ‚¨çš„å®¢æˆ·ç«¯é¡¹ç›®ä¸­æ·»åŠ ä»¥ä¸‹åŒ…ï¼š

```xml
<PackageReference Include="System.Management" Version="8.0.0" />
<PackageReference Include="System.Configuration.ConfigurationManager" Version="8.0.1" />
```

### **ç¬¬ä¸‰æ­¥ï¼šé…ç½®App.config**

åœ¨æ‚¨çš„åº”ç”¨ç¨‹åºçš„App.configä¸­æ·»åŠ é…ç½®ï¼š

```xml
<?xml version="1.0" encoding="utf-8"?>
<configuration>
    <appSettings>
        <!-- æ³¨å†ŒæœåŠ¡å™¨åœ°å€ -->
        <add key="LicenseServerUrl" value="http://localhost:5232" />
        <!-- æ³¨å†Œç å°†è‡ªåŠ¨ä¿å­˜åˆ°è¿™é‡Œ -->
        <add key="LicenseKey" value="" />
    </appSettings>
</configuration>
```

---

## ğŸ’» **é›†æˆæ–¹æ³•**

### **æ–¹æ³•ä¸€ï¼šç®€å•é›†æˆï¼ˆæ¨èï¼‰**

åœ¨æ‚¨çš„ä¸»çª—å£æˆ–App.xaml.csä¸­æ·»åŠ ä»¥ä¸‹ä»£ç ï¼š

```csharp
using RegisterSrv.ClientSDK;

public partial class App : Application
{
    protected override void OnStartup(StartupEventArgs e)
    {
        // åˆå§‹åŒ–è®¸å¯è¯ç®¡ç†å™¨
        LicenseManager.Initialize("YourAppId"); // æ›¿æ¢ä¸ºæ‚¨çš„åº”ç”¨ID
        
        // æ£€æŸ¥è®¸å¯è¯
        var task = Task.Run(async () =>
        {
            var isValid = await LicenseManager.EnsureLicenseValidAsync(
                "æ‚¨çš„åº”ç”¨ç¨‹åºåç§°", 
                "1.0.0", // åº”ç”¨ç‰ˆæœ¬
                null,    // çˆ¶çª—å£
                false    // ä¸å…è®¸å–æ¶ˆï¼Œå¼ºåˆ¶æ³¨å†Œ
            );
            
            if (!isValid)
            {
                // ç”¨æˆ·å–æ¶ˆæ³¨å†Œæˆ–æ³¨å†Œå¤±è´¥ï¼Œé€€å‡ºåº”ç”¨
                Dispatcher.Invoke(() => Shutdown());
                return;
            }
            
            // æ³¨å†ŒæˆåŠŸï¼Œå¯åŠ¨ä¸»çª—å£
            Dispatcher.Invoke(() =>
            {
                var mainWindow = new MainWindow();
                mainWindow.Show();
            });
        });
        
        // ä¸è°ƒç”¨base.OnStartupï¼Œå› ä¸ºæˆ‘ä»¬æ‰‹åŠ¨ç®¡ç†ä¸»çª—å£
    }
    
    protected override void OnExit(ExitEventArgs e)
    {
        LicenseManager.Cleanup();
        base.OnExit(e);
    }
}
```

### **æ–¹æ³•äºŒï¼šåœ¨ä¸»çª—å£ä¸­é›†æˆ**

å¦‚æœæ‚¨å¸Œæœ›åœ¨ä¸»çª—å£åŠ è½½æ—¶æ£€æŸ¥è®¸å¯è¯ï¼š

```csharp
using RegisterSrv.ClientSDK;

public partial class MainWindow : Window
{
    public MainWindow()
    {
        InitializeComponent();
        
        // åˆå§‹åŒ–è®¸å¯è¯ç®¡ç†å™¨
        LicenseManager.Initialize("YourAppId");
        
        Loaded += MainWindow_Loaded;
    }
    
    private async void MainWindow_Loaded(object sender, RoutedEventArgs e)
    {
        // æ£€æŸ¥è®¸å¯è¯
        var isValid = await LicenseManager.EnsureLicenseValidAsync(
            "æ‚¨çš„åº”ç”¨ç¨‹åºåç§°",
            "1.0.0",
            this // çˆ¶çª—å£
        );
        
        if (!isValid)
        {
            // ç”¨æˆ·å–æ¶ˆæ³¨å†Œï¼Œå…³é—­åº”ç”¨
            Close();
            return;
        }
        
        // è®¸å¯è¯æœ‰æ•ˆï¼Œç»§ç»­æ­£å¸¸æµç¨‹
        InitializeApplication();
    }
    
    private void InitializeApplication()
    {
        // æ‚¨çš„åº”ç”¨åˆå§‹åŒ–ä»£ç 
    }
}
```

### **æ–¹æ³•ä¸‰ï¼šèœå•é¡¹é›†æˆ**

åœ¨èœå•ä¸­æ·»åŠ "æ³¨å†Œ"é€‰é¡¹ï¼š

```csharp
private void MenuItem_Register_Click(object sender, RoutedEventArgs e)
{
    LicenseManager.Initialize("YourAppId");
    
    var isRegistered = LicenseManager.ShowRegistrationDialog(
        "æ‚¨çš„åº”ç”¨ç¨‹åºåç§°",
        "1.0.0",
        this
    );
    
    if (isRegistered)
    {
        MessageBox.Show("æ³¨å†ŒæˆåŠŸï¼", "æˆåŠŸ", MessageBoxButton.OK, MessageBoxImage.Information);
    }
}
```

---

## ğŸ”§ **é«˜çº§ç”¨æ³•**

### **è‡ªå®šä¹‰éªŒè¯é€»è¾‘**

```csharp
public class CustomLicenseChecker
{
    public static async Task<bool> ValidateWithCustomLogic()
    {
        LicenseManager.Initialize("YourAppId");
        
        // éªŒè¯å½“å‰è®¸å¯è¯
        var result = await LicenseManager.ValidateCurrentLicenseAsync();
        
        if (result.IsValid)
        {
            // æ£€æŸ¥æ˜¯å¦å³å°†è¿‡æœŸ
            if (result.ExpiresAt.HasValue && 
                result.ExpiresAt.Value.Subtract(DateTime.Now).Days <= 7)
            {
                MessageBox.Show(
                    $"æ‚¨çš„è®¸å¯è¯å°†åœ¨ {result.ExpiresAt.Value:yyyy-MM-dd} åˆ°æœŸï¼Œè¯·åŠæ—¶ç»­è´¹ã€‚",
                    "è®¸å¯è¯å³å°†åˆ°æœŸ",
                    MessageBoxButton.OK,
                    MessageBoxImage.Warning);
            }
            
            return true;
        }
        
        return false;
    }
}
```

### **åå°å®šæœŸéªŒè¯**

```csharp
public class LicenseValidator
{
    private readonly Timer _validationTimer;
    
    public LicenseValidator()
    {
        // æ¯å°æ—¶éªŒè¯ä¸€æ¬¡è®¸å¯è¯
        _validationTimer = new Timer(ValidateLicense, null, TimeSpan.Zero, TimeSpan.FromHours(1));
    }
    
    private async void ValidateLicense(object state)
    {
        try
        {
            var result = await LicenseManager.ValidateCurrentLicenseAsync();
            if (!result.IsValid)
            {
                // è®¸å¯è¯æ— æ•ˆï¼Œé€šçŸ¥ç”¨æˆ·
                Application.Current.Dispatcher.Invoke(() =>
                {
                    MessageBox.Show(
                        "è®¸å¯è¯éªŒè¯å¤±è´¥ï¼Œåº”ç”¨ç¨‹åºå°†é€€å‡ºã€‚",
                        "è®¸å¯è¯é”™è¯¯",
                        MessageBoxButton.OK,
                        MessageBoxImage.Error);
                    
                    Application.Current.Shutdown();
                });
            }
        }
        catch (Exception ex)
        {
            // è®°å½•é”™è¯¯ï¼Œä½†ä¸ä¸­æ–­åº”ç”¨ç¨‹åº
            System.Diagnostics.Debug.WriteLine($"è®¸å¯è¯éªŒè¯é”™è¯¯: {ex.Message}");
        }
    }
}
```

---

## ğŸ¨ **UIé›†æˆç¤ºä¾‹**

### **åœ¨çŠ¶æ€æ æ˜¾ç¤ºè®¸å¯è¯ä¿¡æ¯**

```csharp
public partial class MainWindow : Window
{
    public MainWindow()
    {
        InitializeComponent();
        UpdateLicenseStatus();
    }
    
    private async void UpdateLicenseStatus()
    {
        try
        {
            LicenseManager.Initialize("YourAppId");
            var result = await LicenseManager.ValidateCurrentLicenseAsync();
            
            if (result.IsValid)
            {
                StatusBarLicense.Text = $"å·²æ³¨å†Œ - {result.LicenseType}";
                StatusBarLicense.Foreground = Brushes.Green;
                
                if (result.ExpiresAt.HasValue)
                {
                    StatusBarExpiry.Text = $"åˆ°æœŸ: {result.ExpiresAt.Value:yyyy-MM-dd}";
                }
                else
                {
                    StatusBarExpiry.Text = "æ°¸ä¹…è®¸å¯";
                }
            }
            else
            {
                StatusBarLicense.Text = "æœªæ³¨å†Œ";
                StatusBarLicense.Foreground = Brushes.Red;
                StatusBarExpiry.Text = "";
            }
        }
        catch
        {
            StatusBarLicense.Text = "è®¸å¯è¯æ£€æŸ¥å¤±è´¥";
            StatusBarLicense.Foreground = Brushes.Orange;
        }
    }
}
```

---

## ğŸ“‹ **é…ç½®é€‰é¡¹**

### **App.config å®Œæ•´é…ç½®**

```xml
<?xml version="1.0" encoding="utf-8"?>
<configuration>
    <appSettings>
        <!-- å¿…éœ€ï¼šæ³¨å†ŒæœåŠ¡å™¨åœ°å€ -->
        <add key="LicenseServerUrl" value="http://your-server.com:5232" />
        
        <!-- è‡ªåŠ¨ä¿å­˜ï¼šæœ‰æ•ˆçš„æ³¨å†Œç  -->
        <add key="LicenseKey" value="" />
        
        <!-- å¯é€‰ï¼šéªŒè¯è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ -->
        <add key="LicenseValidationTimeout" value="30" />
        
        <!-- å¯é€‰ï¼šç¦»çº¿éªŒè¯å®½é™æœŸï¼ˆå¤©ï¼‰ -->
        <add key="OfflineGracePeriod" value="7" />
    </appSettings>
</configuration>
```

---

## ğŸ”’ **å®‰å…¨å»ºè®®**

### **åŸºæœ¬å®‰å…¨æªæ–½**

1. **åº”ç”¨ç¨‹åºIDä¿æŠ¤**
   ```csharp
   // ä¸è¦åœ¨ä»£ç ä¸­ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯
   private const string APP_ID = "YourUniqueAppId2024";
   ```

2. **ç½‘ç»œé€šä¿¡åŠ å¯†**
   - åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨HTTPS
   - é…ç½®SSLè¯ä¹¦

3. **æœ¬åœ°å­˜å‚¨ä¿æŠ¤**
   ```csharp
   // å¯ä»¥å¯¹ä¿å­˜çš„æ³¨å†Œç è¿›è¡Œç®€å•åŠ å¯†
   public static class ConfigHelper
   {
       public static string GetEncryptedLicenseKey()
       {
           var encrypted = ConfigurationManager.AppSettings["LicenseKey"];
           // å®ç°æ‚¨çš„è§£å¯†é€»è¾‘
           return DecryptString(encrypted);
       }
   }
   ```

---

## ğŸ› **æ•…éšœæ’é™¤**

### **å¸¸è§é—®é¢˜**

1. **"è®¸å¯è¯ç®¡ç†å™¨æœªåˆå§‹åŒ–"é”™è¯¯**
   - ç¡®ä¿åœ¨ä½¿ç”¨å‰è°ƒç”¨äº†`LicenseManager.Initialize()`

2. **ç½‘ç»œè¿æ¥å¤±è´¥**
   - æ£€æŸ¥æœåŠ¡å™¨åœ°å€æ˜¯å¦æ­£ç¡®
   - ç¡®ä¿é˜²ç«å¢™å…è®¸è¿æ¥
   - éªŒè¯æœåŠ¡å™¨æ˜¯å¦æ­£åœ¨è¿è¡Œ

3. **æœºå™¨ç ä¸ä¸€è‡´**
   - ç¡¬ä»¶æ›´æ”¹å¯èƒ½å¯¼è‡´æœºå™¨ç å˜åŒ–
   - è”ç³»ç®¡ç†å‘˜é‡æ–°ç»‘å®šè®¸å¯è¯

### **è°ƒè¯•æŠ€å·§**

```csharp
// å¯ç”¨è¯¦ç»†æ—¥å¿—
public static class DebugHelper
{
    public static async Task TestLicenseSystem()
    {
        try
        {
            LicenseManager.Initialize("YourAppId");
            
            // æµ‹è¯•æœåŠ¡å™¨è¿æ¥
            var connected = await LicenseManager.TestServerConnectionAsync();
            Console.WriteLine($"æœåŠ¡å™¨è¿æ¥: {(connected ? "æˆåŠŸ" : "å¤±è´¥")}");
            
            // æ˜¾ç¤ºæœºå™¨ç 
            var machineCode = LicenseManager.GetMachineCode();
            Console.WriteLine($"æœºå™¨ç : {machineCode}");
            
            // éªŒè¯å½“å‰è®¸å¯è¯
            var result = await LicenseManager.ValidateCurrentLicenseAsync();
            Console.WriteLine($"è®¸å¯è¯çŠ¶æ€: {(result.IsValid ? "æœ‰æ•ˆ" : "æ— æ•ˆ")}");
            Console.WriteLine($"æ¶ˆæ¯: {result.Message}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"æµ‹è¯•å¤±è´¥: {ex.Message}");
        }
    }
}
```

---

## ğŸ“ **æŠ€æœ¯æ”¯æŒ**

å¦‚æœæ‚¨åœ¨é›†æˆè¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š

1. âœ… **æœåŠ¡å™¨æ˜¯å¦æ­£åœ¨è¿è¡Œ**
2. âœ… **ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸**
3. âœ… **åº”ç”¨ç¨‹åºIDæ˜¯å¦æ­£ç¡®**
4. âœ… **é…ç½®æ–‡ä»¶æ˜¯å¦æ­£ç¡®**
5. âœ… **NuGetåŒ…æ˜¯å¦æ­£ç¡®å®‰è£…**

---

## ğŸ‰ **å®Œæˆé›†æˆ**

æ­å–œï¼æ‚¨å·²ç»æˆåŠŸå°†æ³¨å†ŒéªŒè¯åŠŸèƒ½é›†æˆåˆ°æ‚¨çš„WPFåº”ç”¨ç¨‹åºä¸­ã€‚

**ä¸»è¦åŠŸèƒ½ï¼š**
- âœ… è‡ªåŠ¨è®¸å¯è¯éªŒè¯
- âœ… ç”¨æˆ·å‹å¥½çš„æ³¨å†Œç•Œé¢
- âœ… é…ç½®è‡ªåŠ¨ä¿å­˜
- âœ… æœºå™¨ç ç»‘å®š
- âœ… ç½‘ç»œè¿æ¥æµ‹è¯•
- âœ… é”™è¯¯å¤„ç†å’Œç”¨æˆ·æç¤º

æ‚¨çš„åº”ç”¨ç¨‹åºç°åœ¨å…·å¤‡äº†å®Œæ•´çš„è®¸å¯è¯ç®¡ç†åŠŸèƒ½ï¼ğŸŠ 