# 表格最大化对齐修复

## 📋 问题描述

当窗口最大化时，组合列表的表头和内容行列对应不上，导致：
- 名称列错位
- 数值列错位
- 整体表格显示混乱

## 🔍 根本原因

### 原架构问题

表头和内容行在不同的容器中，导致它们的可用宽度计算不同步：

```xml
<!-- 原来的结构 -->
<Border Padding="8,5">
    <StackPanel x:Name="panelPortfolioHeader" Orientation="Horizontal">
        <!-- 在这里动态创建表头Grid -->
    </StackPanel>
</Border>

<ScrollViewer>
    <StackPanel x:Name="panelPortfolios" Margin="5">
        <!-- 在这里动态创建内容行Grid -->
    </StackPanel>
</ScrollViewer>
```

### 问题分析

1. **容器不一致**
   - 表头：Grid放在StackPanel中，StackPanel根据内容自适应宽度
   - 内容：Grid放在StackPanel中，但StackPanel在ScrollViewer内

2. **Padding/Margin不一致**
   - 表头Border：`Padding="8,5"`（左右各8px）
   - 内容StackPanel：`Margin="5"`（四周各5px）
   - 结果：可用宽度不同

3. **弹性列宽度计算**
   - 表头的`Width="*"`基于表头容器宽度
   - 内容的`Width="*"`基于内容容器宽度
   - 窗口变化时，两者计算结果不同步

## ✅ 解决方案

### 1. 统一边距

```xml
<!-- 修改前 -->
<Border Padding="8,5">
    <StackPanel x:Name="panelPortfolioHeader"/>
</Border>
<ScrollViewer>
    <StackPanel Margin="5"/>
</ScrollViewer>

<!-- 修改后 -->
<Border Padding="5,5,5,5">
    <Grid x:Name="gridPortfolioHeader"/>
</Border>
<ScrollViewer HorizontalScrollBarVisibility="Disabled">
    <StackPanel Margin="5"/>
</ScrollViewer>
```

**改进点**：
- ✅ 表头Padding从8,5改为5,5,5,5（与内容Margin保持一致）
- ✅ 移除表头的StackPanel容器，直接使用Grid
- ✅ ScrollViewer禁用水平滚动条

### 2. 直接使用XAML定义的Grid

```csharp
// 修改前：动态创建Grid并添加到StackPanel
private void CreatePortfolioListHeader()
{
    panelPortfolioHeader.Children.Clear();
    var grid = new Grid();
    // ... 配置grid ...
    panelPortfolioHeader.Children.Add(grid);
}

// 修改后：直接配置XAML中定义的Grid
private void CreatePortfolioListHeader()
{
    var headerGrid = this.FindName("gridPortfolioHeader") as Grid;
    headerGrid.ColumnDefinitions.Clear();
    headerGrid.Children.Clear();
    // ... 直接配置headerGrid ...
}
```

**优势**：
- ✅ 表头Grid和内容Grid在相同的布局层级
- ✅ 宽度计算逻辑一致
- ✅ 弹性列（*）宽度同步

### 3. 确保Grid填充整个容器

```csharp
// 在内容行Grid上添加
var grid = new Grid
{
    HorizontalAlignment = HorizontalAlignment.Stretch
};
```

## 🎯 修改清单

### XAML修改 (`CustomPortfolioWindow.xaml`)

```xml
<!-- 表头结构优化 -->
<Border Grid.Row="2" Background="#F0F0F0" BorderBrush="#E0E0E0" 
        BorderThickness="0,0,0,1" Padding="5,5,5,5">
    <Grid x:Name="gridPortfolioHeader"/>  <!-- 直接使用Grid，移除StackPanel -->
</Border>

<!-- 内容区域优化 -->
<ScrollViewer Grid.Row="3" VerticalScrollBarVisibility="Auto" 
              HorizontalScrollBarVisibility="Disabled">  <!-- 禁用水平滚动 -->
    <StackPanel x:Name="panelPortfolios" Margin="5"/>
</ScrollViewer>
```

### C#代码修改 (`CustomPortfolioWindow.xaml.cs`)

#### CreatePortfolioListHeader()

```csharp
private void CreatePortfolioListHeader()
{
    // 从XAML中查找表头Grid
    var headerGrid = this.FindName("gridPortfolioHeader") as Grid;
    if (headerGrid == null)
    {
        _logger.LogError("无法找到表头Grid: gridPortfolioHeader");
        return;
    }
    
    // 清空并重新配置
    headerGrid.ColumnDefinitions.Clear();
    headerGrid.Children.Clear();
    
    // 定义列宽（与内容行完全一致）
    headerGrid.ColumnDefinitions.Add(new ColumnDefinition { Width = new GridLength(50) });
    headerGrid.ColumnDefinitions.Add(new ColumnDefinition { Width = new GridLength(1, GridUnitType.Star) });
    // ... 其他列 ...
}
```

#### CreatePortfolioRow()

```csharp
private Border CreatePortfolioRow(PortfolioRuntimeData runtimeData, int index)
{
    // ...
    var grid = new Grid
    {
        HorizontalAlignment = HorizontalAlignment.Stretch  // 填充整个容器宽度
    };
    
    // 列宽定义与表头完全一致
    grid.ColumnDefinitions.Add(new ColumnDefinition { Width = new GridLength(50) });
    grid.ColumnDefinitions.Add(new ColumnDefinition { Width = new GridLength(1, GridUnitType.Star) });
    // ... 其他列 ...
}
```

## 🎨 修复前后对比

### 修复前（窗口最大化时）

```
表头：
┌─────┬────────────────────────────────────────┬─────────┬─────────┬─────┬────────┬──────┐
│序号 │        组合名称（居中，但偏移）           │ 24H涨幅 │ 30天涨幅│ 数量│ 成交额  │ 操作 │
└─────┴────────────────────────────────────────┴─────────┴─────────┴─────┴────────┴──────┘

内容：
┌─────┬────────────────────────────────────────────────┬─────────┬─────────┬─────┬────────┬──────┐
│ 1   │ 经典主流（左对齐，位置不对）                      │ +2.5% ↑ │ +5.3% ↑ │ 4个 │ $120M  │ 改 删│
└─────┴────────────────────────────────────────────────┴─────────┴─────────┴─────┴────────┴──────┘
      ↑ 错位                                              ↑ 错位
```

### 修复后（窗口最大化时）

```
表头：
┌─────┬────────────────────────────────────────────────┬─────────┬─────────┬─────┬────────┬──────┐
│序号 │ 组合名称（左对齐）                               │ 24H涨幅 │ 30天涨幅│ 数量│ 成交额  │ 操作 │
└─────┴────────────────────────────────────────────────┴─────────┴─────────┴─────┴────────┴──────┘

内容：
┌─────┬────────────────────────────────────────────────┬─────────┬─────────┬─────┬────────┬──────┐
│ 1   │ 经典主流（左对齐）                               │ +2.5% ↑ │ +5.3% ↑ │ 4个 │ $120M  │ 改 删│
│ 2   │ 次新潜力高成长项目组合精选                        │ +1.8% ↑ │ +3.2% ↑ │ 6个 │ $85M   │ 改 删│
└─────┴────────────────────────────────────────────────┴─────────┴─────────┴─────┴────────┴──────┘
      ✅ 完美对齐                                          ✅ 完美对齐
```

## 🔧 技术原理

### WPF Grid布局宽度计算

#### 固定宽度列
```csharp
new ColumnDefinition { Width = new GridLength(100) }
```
- 宽度固定为100px
- 不受容器宽度影响
- 始终保持一致

#### 弹性宽度列
```csharp
new ColumnDefinition { Width = new GridLength(1, GridUnitType.Star) }
```
- 宽度 = (容器总宽度 - 所有固定宽度列的总和) / 所有*列的权重总和
- **关键**：依赖于容器的ActualWidth
- **问题**：如果容器宽度不同，计算结果不同

#### 本项目的列宽设置

| 列名 | 宽度类型 | 值 |
|------|---------|---|
| 序号 | 固定 | 50px |
| 组合名称 | **弹性** | **1*** |
| 24H涨幅 | 固定 | 100px |
| 30天涨幅 | 固定 | 100px |
| 数量 | 固定 | 80px |
| 成交额 | 固定 | 100px |
| 操作 | 固定 | 80px |

**固定宽度总计**：510px  
**弹性列（名称）宽度**：容器宽度 - 510px

### 容器宽度同步的关键

```
Border (Padding: 5,5,5,5)
  └─ Grid (直接作为Child)
       └─ ColumnDefinition (Width="*")
```

表头和内容必须：
1. ✅ 在相同的布局层级
2. ✅ 具有相同的Padding/Margin
3. ✅ 使用相同的列宽定义

## 🎯 测试要点

- [ ] **窗口正常大小**：表头和内容对齐
- [ ] **窗口最大化**：表头和内容对齐
- [ ] **窗口最小化后恢复**：表头和内容对齐
- [ ] **拖动GridSplitter**：表头和内容随宽度变化同步
- [ ] **调整窗口宽度**：表头和内容始终对齐
- [ ] **名称列超长**：省略号正确显示，不影响对齐
- [ ] **水平滚动**：不出现水平滚动条（已禁用）

## 📦 修改文件

- ✅ `src/BinanceApps.WPF/CustomPortfolioWindow.xaml`
  - 第97-100行：表头Border结构
  - 第102行：ScrollViewer禁用水平滚动

- ✅ `src/BinanceApps.WPF/CustomPortfolioWindow.xaml.cs`
  - 第352-414行：`CreatePortfolioListHeader()` 方法
  - 第872-876行：`CreatePortfolioRow()` Grid创建

## 💡 最佳实践

### WPF表格对齐的通用解决方案

1. **统一容器结构**
   - 表头和内容使用相同的容器类型
   - 避免一个用StackPanel，一个用Grid

2. **统一Padding/Margin**
   - 确保表头和内容的边距完全一致
   - Padding和Margin都会影响可用宽度

3. **使用XAML定义Grid**
   - 在XAML中定义固定的Grid容器
   - C#代码只负责填充内容，不创建容器

4. **SharedSizeScope（备选方案）**
   ```xml
   <Grid Grid.IsSharedSizeScope="True">
       <!-- 表头和内容的列可以使用SharedSizeGroup同步宽度 -->
   </Grid>
   ```

5. **禁用不必要的滚动条**
   - 水平滚动条会影响宽度计算
   - 如果表格不需要水平滚动，应禁用

---

**修复完成日期**: 2025-10-02  
**修复人**: AI Assistant  
**版本**: 1.0 