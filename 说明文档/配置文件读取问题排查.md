# 配置文件读取问题排查

## 🔴 问题现象

**日志显示**：
```
📊 开始从API加载合约流通量信息...
🌐 API地址: http://localhost:8080/api/contract
🔗 正在请求: http://localhost:8080/api/contract?includeDisabled=false
⚠️ 加载合约信息失败或服务器未响应（量比功能将不可用）
```

**预期应该显示**：
```
🌐 API地址: http://38.181.35.75:8080/api/contract
```

## 🎯 根本原因

程序读取的配置文件**不是最新的**，可能是以下原因之一：

### 原因1：运行的是旧版本（最可能⭐⭐⭐⭐⭐）

- 您修改了源代码目录的 `App.config`
- 但运行的是**之前编译的旧版本**
- 旧版本使用的是旧的配置文件或硬编码的默认值

### 原因2：配置文件未被复制到输出目录

- 编译时 `App.config` 没有被正确复制为 `BinanceApps.WPF.dll.config`
- 项目配置可能有问题

### 原因3：配置文件被缓存

- .NET应用程序配置文件可能被系统缓存
- 需要清理缓存后重新编译

## ✅ 解决方案

### 方案1：使用检查脚本（推荐）

运行我刚创建的脚本：
```cmd
检查并运行最新版本.cmd
```

这个脚本会：
1. ✅ 编译最新版本
2. ✅ 检查输出目录的配置文件
3. ✅ 显示配置文件中的 `ContractApiServerUrl` 值
4. ✅ 运行最新编译的程序

### 方案2：手动清理并重新编译

```powershell
# 1. 清理所有编译输出
dotnet clean src/BinanceApps.WPF/BinanceApps.WPF.csproj

# 2. 删除 bin 和 obj 目录
Remove-Item -Recurse -Force src/BinanceApps.WPF/bin
Remove-Item -Recurse -Force src/BinanceApps.WPF/obj

# 3. 重新编译 Release 版本
dotnet build src/BinanceApps.WPF/BinanceApps.WPF.csproj -c Release

# 4. 验证配置文件
type src\BinanceApps.WPF\bin\Release\net9.0-windows\BinanceApps.WPF.dll.config | findstr ContractApiServerUrl

# 5. 运行最新版本
.\src\BinanceApps.WPF\bin\Release\net9.0-windows\BinanceApps.WPF.exe
```

### 方案3：确认运行的是正确的exe

**检查您是否在运行**：
- ❌ 桌面快捷方式（可能指向旧版本）
- ❌ 其他目录的副本
- ❌ Debug 版本（而不是 Release 版本）

**应该运行**：
- ✅ `src\BinanceApps.WPF\bin\Release\net9.0-windows\BinanceApps.WPF.exe`

## 🔍 诊断步骤

### 第1步：查看新的调试日志

最新版本添加了详细的调试输出，启动时会显示：

```
🔍 读取配置: ContractApiServerUrl = http://38.181.35.75:8080
✅ 使用配置的合约API地址: http://38.181.35.75:8080
```

或者：

```
🔍 读取配置: ContractApiServerUrl = (null)
⚠️ 配置文件中未找到ContractApiServerUrl，使用默认值: http://localhost:8080
```

**如果看到第二种情况**，说明配置文件确实没有被读取。

### 第2步：手动检查配置文件

```powershell
# 检查输出目录的配置文件
type src\BinanceApps.WPF\bin\Release\net9.0-windows\BinanceApps.WPF.dll.config
```

**应该看到**：
```xml
<add key="ContractApiServerUrl" value="http://38.181.35.75:8080" />
```

**如果看不到或值不对**：
- 重新编译
- 手动复制 `App.config` 到输出目录并重命名

### 第3步：对比文件时间戳

```powershell
# 查看源文件修改时间
Get-Item src\BinanceApps.WPF\App.config | Select-Object LastWriteTime

# 查看编译输出的配置文件时间
Get-Item src\BinanceApps.WPF\bin\Release\net9.0-windows\BinanceApps.WPF.dll.config | Select-Object LastWriteTime

# 查看exe文件时间
Get-Item src\BinanceApps.WPF\bin\Release\net9.0-windows\BinanceApps.WPF.exe | Select-Object LastWriteTime
```

**这三个文件的时间应该接近**（都是最近编译的时间）

## 🛠️ 代码修改说明

### 修改位置

**文件**：`src/BinanceApps.WPF/MainWindow.xaml.cs`  
**行号**：192-214

### 修改内容

添加了详细的调试输出：
```csharp
// 读取配置
var contractApiUrl = System.Configuration.ConfigurationManager.AppSettings["ContractApiServerUrl"];

// 调试输出
Console.WriteLine($"🔍 读取配置: ContractApiServerUrl = {contractApiUrl ?? "(null)"}");

// 如果配置为空或无效，使用默认值并警告
if (string.IsNullOrWhiteSpace(contractApiUrl))
{
    contractApiUrl = "http://localhost:8080";
    Console.WriteLine($"⚠️ 配置文件中未找到ContractApiServerUrl，使用默认值: {contractApiUrl}");
}
else
{
    Console.WriteLine($"✅ 使用配置的合约API地址: {contractApiUrl}");
}
```

### 为什么添加这些输出？

1. **明确显示读取到的配置值**（包括 null 的情况）
2. **区分是使用配置值还是默认值**
3. **便于诊断配置文件读取问题**

## 📋 验证清单

重新启动程序后，应该看到以下日志序列：

- [ ] `🔍 读取配置: ContractApiServerUrl = http://38.181.35.75:8080`
- [ ] `✅ 使用配置的合约API地址: http://38.181.35.75:8080`
- [ ] `📊 开始从API加载合约流通量信息...`
- [ ] `🌐 API地址: http://38.181.35.75:8080/api/contract`
- [ ] `🔗 正在请求: http://38.181.35.75:8080/api/contract?includeDisabled=false`
- [ ] `📡 HTTP响应状态: OK`
- [ ] `✅ 成功加载 XXX 个合约信息到缓存`

**如果地址还是 localhost:8080**：
1. 确认您运行的是刚才编译的 exe
2. 使用 `检查并运行最新版本.cmd` 脚本
3. 提供启动日志的完整输出

## 🎯 其他需要检查的配置

### 1. LicenseServerUrl（已统一读取）

**位置**：`src/BinanceApps.WPF/App.xaml.cs`  
**状态**：✅ 已从配置文件动态读取

```csharp
var licenseServerUrl = System.Configuration.ConfigurationManager.AppSettings["LicenseServerUrl"] ?? "http://localhost:8080";
```

### 2. ContractApiServerUrl（本次修复）

**位置**：`src/BinanceApps.WPF/MainWindow.xaml.cs`  
**状态**：✅ 已从配置文件动态读取（本次修复）

```csharp
var contractApiUrl = System.Configuration.ConfigurationManager.AppSettings["ContractApiServerUrl"];
```

### 3. 其他可能的硬编码位置

已全部检查，**没有其他硬编码的API地址**。

## 📝 总结

### 问题

- 日志显示API地址为 `localhost:8080`
- 但配置文件中是 `http://38.181.35.75:8080`

### 原因

- 运行的是旧版本的程序
- 旧版本的配置文件或代码使用了默认值

### 解决

1. ✅ 添加详细的调试输出
2. ✅ 重新编译最新版本
3. ✅ 运行最新版本的程序
4. ✅ 使用 `检查并运行最新版本.cmd` 脚本验证

### 验证

启动日志应该显示：
```
✅ 使用配置的合约API地址: http://38.181.35.75:8080
```

而不是：
```
⚠️ 配置文件中未找到ContractApiServerUrl，使用默认值: http://localhost:8080
```

