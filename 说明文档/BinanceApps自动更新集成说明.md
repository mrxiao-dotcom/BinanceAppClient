# BinanceApps 自动更新功能集成说明

## 📋 集成概述

已成功将 `RegisterSrv.AutoUpdate` 组件集成到 BinanceApps.WPF 项目中，实现了自动在线升级功能。

## ✅ 已完成的修改

### 1. 添加 NuGet 包依赖
- 已安装 `RegisterSrv.AutoUpdate` 版本 1.0.0
- 包引用已添加到 `BinanceApps.WPF.csproj`

### 2. 配置应用程序版本信息
在 `BinanceApps.WPF.csproj` 中添加了版本信息：
```xml
<Version>1.0.0</Version>
<AssemblyVersion>1.0.0.0</AssemblyVersion>
<FileVersion>1.0.0.0</FileVersion>
```

### 3. 修改 App.xaml.cs
**修改内容：**
- 添加 `RegisterSrv.AutoUpdate` 命名空间引用
- 添加静态属性 `UpdateManager` 用于全局访问
- 在 `OnStartup` 方法中初始化更新管理器，配置如下：
  - **服务器地址**：`http://192.168.1.101:8080`
  - **应用程序 ID**：从 App.config 读取（`ApplicationId`）
  - **应用程序名称**：从 App.config 读取（`ApplicationName`）
  - **当前版本**：从程序集自动获取（1.0.0）
  - **启动时自动检查**：开启
  - **静默更新**：关闭（显示UI）

- 在许可证验证成功后、主窗口启动前，执行静默更新检查
  - 如果有更新，会自动显示更新对话框
  - 如果检查失败，会记录警告日志但不影响应用启动

### 4. 修改 MainWindow.xaml
在"帮助"菜单中添加了"检查更新"菜单项：
```xml
<MenuItem Header="检查更新" Click="MenuItem_CheckUpdate_Click"/>
```

### 5. 修改 MainWindow.xaml.cs
添加了 `MenuItem_CheckUpdate_Click` 方法：
- 用户点击"帮助" → "检查更新"时触发
- 显示完整的更新检查流程（非静默模式）
- 包含异常处理和错误提示

## 🔧 配置说明

### 🆕 更新服务器配置（v2.3.3 优化）

**统一配置管理**：所有服务器地址统一从 `App.config` 读取

**配置文件位置**：`src/BinanceApps.WPF/App.config`

```xml
<appSettings>
    <!-- 统一的服务器地址（用于许可证验证、自动更新、合约API） -->
    <add key="LicenseServerUrl" value="http://your-server:8080" />
    
    <!-- 可选：如果合约API服务器地址不同，可单独配置 -->
    <!-- <add key="ContractApiServerUrl" value="http://another-server:8080" /> -->
</appSettings>
```

**优势**：
- ✅ **无需修改代码**：只需修改配置文件
- ✅ **统一管理**：一个地址配置多处使用
- ✅ **灵活扩展**：支持单独配置不同功能的服务器地址
- ✅ **详细日志**：启动时显示实际使用的服务器地址

**日志示例**：
```
🔍 ContractApiServerUrl 未配置，使用 LicenseServerUrl: http://38.181.35.75:8080
✅ 合约API最终地址: http://38.181.35.75:8080
✅ 更新服务器地址: http://38.181.35.75:8080
```

## 🧪 测试步骤

### 前提条件
1. ✅ 确保本地更新服务器（`http://192.168.1.101:8080`）正在运行
2. ✅ 在服务器端注册应用程序（AppId 与 App.config 中的 `ApplicationId` 一致）
3. ✅ 在服务器端上传新版本（版本号需大于 1.0.0，如 1.0.1 或 1.1.0）

### 测试场景 1：启动时自动检查更新

1. 启动 BinanceApps 应用程序
2. 应用程序会在许可证验证成功后自动检查更新
3. 如果服务器上有新版本：
   - 显示更新对话框，展示新版本信息、更新说明、文件大小等
   - 用户可以选择：
     - **立即更新**：下载并安装新版本，然后重启应用
     - **稍后提醒**：跳过本次更新
   - 如果是强制更新，则只能选择"立即更新"
4. 如果没有新版本：
   - 不显示任何提示，直接进入主界面

**预期控制台输出：**
```
✅ 自动更新管理器已初始化 (版本: 1.0.0)
✅ 许可证验证成功，检查更新...
✅ 启动主窗口
```

### 测试场景 2：手动检查更新

1. 启动应用程序后，点击菜单 **"帮助" → "检查更新"**
2. 应用程序会主动检查服务器上的新版本
3. 根据服务器响应显示不同结果：
   - **有新版本**：显示更新对话框（同场景 1）
   - **已是最新版本**：显示提示"当前已是最新版本"
   - **检查失败**：显示错误消息（如网络问题、服务器无响应等）

### 测试场景 3：更新下载和安装

1. 在更新对话框中点击"立即更新"
2. 显示进度窗口，展示：
   - 下载进度条
   - 当前状态（下载中、验证中、安装中）
3. 下载完成后自动验证文件完整性（MD5 校验）
4. 安装更新（解压并覆盖文件）
5. 提示重启应用程序
6. 重启后，应用程序版本应更新为新版本号

### 测试场景 4：强制更新

**服务器端配置：**
- 将某个版本标记为"强制更新"

**预期行为：**
- 更新对话框中"稍后提醒"按钮被禁用
- 显示红色强制更新标记
- 用户必须完成更新才能继续使用应用

### 测试场景 5：离线/网络异常

**测试方法：**
- 关闭更新服务器或断开网络

**预期行为：**
- 启动时静默检查失败，记录警告日志但不影响应用启动
- 手动检查更新时，显示友好的错误提示（如"无法连接到更新服务器"）

## 📊 功能特性

### ✅ 已实现的功能
- ✅ 启动时自动静默检查更新
- ✅ 手动检查更新（菜单入口）
- ✅ 更新确认对话框（版本对比、更新说明、文件大小）
- ✅ 下载进度显示
- ✅ 文件完整性校验（MD5）
- ✅ 自动安装更新
- ✅ 支持强制更新
- ✅ 异常处理和友好的错误提示
- ✅ 版本号自动管理

### 🎨 UI 组件
1. **UpdateDialog** - 更新确认对话框
   - 显示版本对比
   - 显示更新说明
   - 显示文件大小和发布时间
   - 支持强制更新模式

2. **UpdateProgressWindow** - 更新进度窗口
   - 实时进度条
   - 状态消息
   - 现代化无边框设计

## 🔍 故障排查

### 问题 1：启动时未检查更新
**可能原因：**
- 更新服务器未运行
- 网络连接问题

**解决方法：**
- 检查控制台日志
- 确认服务器地址配置正确
- 手动点击"检查更新"查看详细错误信息

### 问题 2：更新检查失败
**可能原因：**
- 服务器端未注册该应用程序
- ApplicationId 不匹配

**解决方法：**
- 在服务器端确认应用程序已注册
- 检查 App.config 中的 `ApplicationId` 与服务器端是否一致

### 问题 3：下载失败
**可能原因：**
- 网络中断
- 服务器上的更新包文件损坏

**解决方法：**
- 重新尝试更新
- 在服务器端重新上传更新包

## 📝 开发注意事项

### 版本号管理
- 版本号在 `BinanceApps.WPF.csproj` 中统一管理
- 每次发布新版本前，必须更新 `<Version>` 标签
- 建议使用语义化版本号（Major.Minor.Patch）

### 服务器端要求
1. 应用程序必须在服务器端注册
2. 上传的更新包必须是 ZIP 格式
3. ZIP 包内文件结构必须与应用程序目录结构一致
4. 服务器会自动计算更新包的 MD5 值

### 更新包制作
```bash
# 发布应用程序
dotnet publish -c Release

# 打包为 ZIP（包含 publish 目录下的所有文件）
# 上传到服务器端的版本管理界面
```

## ✨ 后续优化建议

1. ~~**配置外部化**~~：✅ 已完成（v2.3.3）- 所有服务器地址已从 App.config 读取
2. **关于窗口增强**：显示当前版本和服务器最新版本对比
3. **更新历史**：记录更新历史和回滚功能
4. **差量更新**：支持增量更新减少下载大小
5. **多语言支持**：更新对话框支持多语言

---

## 🆕 v2.3.3 最新优化总结（2025-10-03）

### 1. 服务器地址配置优化 ⭐⭐⭐⭐⭐

**原问题**：
- 服务器地址硬编码在代码中
- 需要重新编译才能修改地址
- 多个功能使用不同的配置方式

**优化方案**：
```xml
<!-- 只需配置一个地址，所有功能都使用它 -->
<add key="LicenseServerUrl" value="http://your-server:8080" />
```

**配置读取优先级**：
1. `ContractApiServerUrl`（如果配置了）
2. `LicenseServerUrl`（如果 ContractApiServerUrl 未配置）
3. 默认值 `localhost:8080`（如果都未配置）

**好处**：
- ✅ 修改配置无需重新编译
- ✅ 统一管理所有API地址
- ✅ 向后兼容旧配置
- ✅ 详细的日志输出

### 2. 版本管理优化 ⭐⭐⭐⭐

**优化内容**：
- ✅ `CurrentAppVersion` 存储在 `App.config` 中
- ✅ 更新后自动修改版本号
- ✅ 优先读取配置版本而非程序集版本
- ✅ 避免重复更新提示

**代码实现**：
```csharp
// 优先从 App.config 读取版本
private string GetApplicationVersion()
{
    var configVersion = ConfigurationManager.AppSettings["CurrentAppVersion"];
    if (!string.IsNullOrWhiteSpace(configVersion))
        return configVersion;
    
    return Assembly.GetExecutingAssembly().GetName().Version?.ToString() ?? "1.0.0";
}
```

### 3. 配置文件和数据保护 ⭐⭐⭐⭐⭐

**问题**：更新后用户注册码丢失，需要重新输入

**解决方案**：
- ✅ 双重存储：AppData + App.config
- ✅ 更新时自动保护配置文件
- ✅ 保护所有用户数据文件

**保护的文件类型**：
```
App.config     - 应用配置（包括注册码）
*.db          - 数据库文件
*.log         - 日志文件
*.dat         - AppData 数据文件
```

### 4. 智能更新机制 ⭐⭐⭐⭐

**外部更新脚本**：
```
主程序 → 下载更新 → 启动外部脚本 → 主程序退出
    ↓
外部脚本等待 → 解压文件 → 智能复制 → 重启程序
```

**好处**：
- ✅ 避免 DLL 文件锁定
- ✅ MD5 校验确保完整性
- ✅ 自动备份旧版本
- ✅ 失败后可回滚

### 5. 合约API集成 ⭐⭐⭐

**新增功能**：
- 量比排行 TOP20
- 合约流通量信息
- 流通市值计算

**配置优化**：
- 自动使用 `LicenseServerUrl`
- 无需单独配置

### 6. 符号匹配修复 ⭐⭐⭐

**问题**：合约符号格式不匹配（API返回 `BTCUSDT`，代码又加了 `USDT`）

**修复**：
```csharp
// 修改前：var symbol = contract.Name.ToUpper() + "USDT";  // BTCUSDTUSDT ❌
// 修改后：var symbol = contract.Name.ToUpper();           // BTCUSDT ✅
```

---

## 📊 版本对比

| 功能 | v1.0.0 (原版) | v2.3.3 (最新) |
|------|--------------|--------------|
| 服务器地址配置 | 硬编码 | App.config 动态读取 ✅ |
| 版本管理 | 程序集版本 | App.config 版本 ✅ |
| 注册码持久化 | 仅 App.config | AppData + App.config ✅ |
| 更新后数据保护 | 无 | 自动保护配置和数据 ✅ |
| DLL 锁定问题 | 存在 | 外部脚本解决 ✅ |
| 量比排行功能 | 无 | 已集成 ✅ |
| 配置统一性 | 分散 | 统一管理 ✅ |
| 调试日志 | 简单 | 详细输出 ✅ |

---

## 📞 技术支持

**项目地址**：https://github.com/registerSrv/RegisterSrv

**集成文档**：参考 `RegisterSrv.AutoUpdate 客户端集成指南.md`

---

**集成日期**：2025-09-30  
**最新更新**：2025-10-03  
**集成版本**：RegisterSrv.AutoUpdate 1.0.0  
**应用版本**：BinanceApps v2.3.3  
**文档版本**：2.0 